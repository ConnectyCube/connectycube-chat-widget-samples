!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("ws")):"function"==typeof define&&define.amd?define(["ws"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).ConnectyCube=t(e.WebSocket)}(this,function(e){"use strict";function t(e){return e&&e.__esModule?e:{default:e}}var s,n,r=t(e);!function(e){e[e.COMPACT=1]="COMPACT",e[e.FULL=0]="FULL"}(s||(s={})),function(e){e.FACEBOOK="facebook",e.TWITTER="twitter",e.FIREBASE_PHONE="firebase_phone",e.FIREBASE_EMAIL="firebase_email"}(n||(n={}));const i="WebRTCVideoChat";var a,o,c,l,d,u,h,p,m,g,f,y,b,v,C,S,w,E,T,k,I,x,A,L,D,R,O,P,_;!function(e){e.CALL="call",e.ACCEPT="accept",e.REJECT="reject",e.STOP="hangUp",e.RESTART="iceRestart",e.RESTART_ACCEPT="iceRestartAccept",e.CANDIDATE="iceCandidates"}(a||(a={})),function(e){e[e.UNDEFINED=0]="UNDEFINED",e[e.CONNECTING=1]="CONNECTING",e[e.CONNECTED=2]="CONNECTED",e[e.FAILED=3]="FAILED",e[e.DISCONNECTED=4]="DISCONNECTED",e[e.CLOSED=5]="CLOSED",e[e.COMPLETED=6]="COMPLETED"}(o||(o={})),function(e){e[e.NEW=1]="NEW",e[e.ACTIVE=2]="ACTIVE",e[e.STOPPED=3]="STOPPED",e[e.REJECTED=4]="REJECTED",e[e.CLOSED=5]="CLOSED"}(c||(c={})),function(e){e[e.VIDEO=1]="VIDEO",e[e.AUDIO=2]="AUDIO"}(l||(l={})),function(e){e.CALL="call",e.ACCEPT="accept",e.REJECT="reject",e.STOP="stop",e.INVALID="invalid",e.NOT_ANSWER="not-answer",e.REMOTE_STREAM="remote-stream",e.CONNECTION_STATE="connection-state",e.CLOSE="close",e.STATS_REPORT="stats-report",e.DEVICES="devices"}(d||(d={})),function(e){e[e.NEW=1]="NEW",e[e.CONNECTING=2]="CONNECTING",e[e.CHECKING=3]="CHECKING",e[e.CONNECTED=4]="CONNECTED",e[e.DISCONNECTED=5]="DISCONNECTED",e[e.FAILED=6]="FAILED",e[e.CLOSED=7]="CLOSED",e[e.COMPLETED=8]="COMPLETED"}(u||(u={})),function(e){e.CHAT="chat",e.GROUPCHAT="groupchat"}(h||(h={})),function(e){e.STATUS="status",e.ERROR="error",e.DISCONNECTED="disconnected",e.RECONNECTED="reconnected",e.MESSAGE="message",e.SYSTEM_MESSAGE="system-message",e.ERROR_MESSAGE="error-message",e.TYPING_MESSAGE="typing-message",e.UPDATE_MESSAGE="update-message",e.DELETE_MESSAGE="delete-message",e.REACTIONS_MESSAGE="reactions-message",e.DELIVERED_MESSAGE="delivered-message",e.READ_MESSAGE="read-message",e.SENT_MESSAGE="sent-message",e.USER_LAST_ACTIVITY="user-last-activity",e.JOIN="join",e.LEAVE="leave",e.KICK="kick"}(p||(p={})),function(e){e.ALLOW="allow",e.DENY="deny"}(m||(m={})),function(e){e[e.BOSH=1]="BOSH",e[e.WS=2]="WS"}(g||(g={})),function(e){e.ALL="all",e.TRACE="trace",e.DEBUG="debug",e.VDEBUG="vdebug",e.LOG="log",e.WARN="warn",e.ERROR="error"}(f||(f={})),function(e){e.SAMA="sama",e.XMPP="xmpp"}(y||(y={})),function(e){e.CREATE="create",e.READ="read",e.UPDATE="update",e.DELETE="delete"}(b||(b={})),function(e){e.OPEN="open",e.OWNER="owner",e.NOT_ALLOWED="not_allowed",e.OPEN_FOR_GROUPS="open_for_groups",e.OPEN_FOR_USERS_IDS="open_for_users_ids"}(v||(v={})),function(e){e[e.PUBLIC=1]="PUBLIC",e[e.GROUP=2]="GROUP",e[e.PRIVATE=3]="PRIVATE",e[e.BROADCAST=4]="BROADCAST",e[e.MEETING=5]="MEETING"}(C||(C={})),function(e){e.SENT="sent",e.DELIVERED="delivered",e.READ="read"}(S||(S={})),function(e){e.CREATED="created_at",e.UPDATED="updated_at",e.LAST_MESSAGE="last_message_date_sent"}(w||(w={})),function(e){e.VIDEO="videoinput",e.AUDIO="audioinput"}(E||(E={})),function(e){e.PARTICIPANT_JOINED="participant_joined",e.PARTICIPANT_LEFT="participant_left",e.LOCAL_STREAM="local_stream",e.REMOTE_STREAM="remote_stream",e.REMOTE_TRACKS_UPDATED="remote_tracks_updated",e.DATA_CHANNEL_OPEN="data_channel_open",e.DATA_CHANNEL_MESSAGE="data_channel_message",e.ERROR="error"}(T||(T={})),function(e){e.VIDEO="video",e.AUDIO="audio"}(k||(k={})),function(e){e.CREATED="created",e.ENDED="ended",e.MUTE="mute",e.UNMUTE="unmute"}(I||(I={})),function(e){e.JOIN="join",e.LEFT="left",e.SLOW_LINK="slow-link",e.REMOTE_TRACKS_UPDATED="remote-tracks",e.REMOTE_STREAM="remote-stream",e.REMOTE_CONNECTION_STATE="remote-connection-state",e.DATA_CHANNEL_OPENED="data-channel-opened",e.DATA_CHANNEL_MESSAGE="data-channel-message",e.SESSION_CONNECTION_STATE="session-connection-state",e.ERROR="error"}(x||(x={})),function(e){e.AUDIO="audio",e.VIDEO="video",e.NONE="none"}(A||(A={})),function(e){e.MINUTES="minutes",e.HOURS="hours",e.DAYS="days",e.WEEK="weeks"}(L||(L={})),function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.PATCH="PATCH",e.DELETE="DELETE",e.HEAD="HEAD"}(D||(D={})),function(e){e.JSON="json",e.TEXT="text"}(R||(R={})),function(e){e.APNS="apns",e.VOIP="apns_voip",e.GCM="gcm",e.WEB="web"}(O||(O={})),function(e){e.IOS="ios",e.ANDROID="android",e.WEB="web"}(P||(P={})),function(e){e.DEV="development",e.PROD="production"}(_||(_={}));var M=Object.freeze({__proto__:null,get AddressBookUserDataType(){return s},get CallEvent(){return d},get CallSessionConnectionState(){return o},get CallSessionState(){return c},CallSignalingModuleIdentifier:i,get CallSignalingType(){return a},get CallType(){return l},get ChatAPIs(){return y},get ChatEvent(){return p},get ChatProtocol(){return g},get ChatType(){return h},get ConferenceEvent(){return x},get DataPermission(){return b},get DataPermissionAccess(){return v},get DeviceInputType(){return E},get DevicePlatform(){return P},get DialogDateProp(){return w},get DialogType(){return C},get JanusCallType(){return k},get JanusDebugMode(){return f},get JanusEvent(){return T},get JanusMediaTrackReason(){return I},get LastMessageMessageStatus(){return S},get LoginProviderNames(){return n},get MediaType(){return A},get MeetingDateMetric(){return L},get NotificationChannel(){return O},get PeerConnectionState(){return u},get PrivacyListAction(){return m},get ProxyMethod(){return D},get ProxyType(){return R},get PushEnvironment(){return _}});const N="function"==typeof Buffer;"function"==typeof TextDecoder&&new TextDecoder;const j="function"==typeof TextEncoder?new TextEncoder:void 0,U=Array.prototype.slice.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=");(e=>{let t={};e.forEach((e,s)=>t[e]=s)})(U);const J=String.fromCharCode.bind(String);"function"==typeof Uint8Array.from&&Uint8Array.from.bind(Uint8Array);const F="function"==typeof btoa?e=>btoa(e):N?e=>Buffer.from(e,"binary").toString("base64"):e=>{let t,s,n,r,i="";const a=e.length%3;for(let a=0;a<e.length;){if((s=e.charCodeAt(a++))>255||(n=e.charCodeAt(a++))>255||(r=e.charCodeAt(a++))>255)throw new TypeError("invalid character found");t=s<<16|n<<8|r,i+=U[t>>18&63]+U[t>>12&63]+U[t>>6&63]+U[63&t]}return a?i.slice(0,a-3)+"===".substring(a):i},$=N?e=>Buffer.from(e).toString("base64"):e=>{let t=[];for(let s=0,n=e.length;s<n;s+=4096)t.push(J.apply(null,e.subarray(s,s+4096)));return F(t.join(""))},q=e=>{if(e.length<2)return(t=e.charCodeAt(0))<128?e:t<2048?J(192|t>>>6)+J(128|63&t):J(224|t>>>12&15)+J(128|t>>>6&63)+J(128|63&t);var t=65536+1024*(e.charCodeAt(0)-55296)+(e.charCodeAt(1)-56320);return J(240|t>>>18&7)+J(128|t>>>12&63)+J(128|t>>>6&63)+J(128|63&t)},V=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,z=N?e=>Buffer.from(e,"utf8").toString("base64"):j?e=>$(j.encode(e)):e=>F(e.replace(V,q)),W=(e,t=!1)=>t?(e=>e.replace(/=/g,"").replace(/[+\/]/g,e=>"+"==e?"-":"_"))(z(e)):z(e),B="5.1.10",G="undefined"!=typeof window&&"object"==typeof document,H="object"==typeof process&&"object"==typeof process.versions&&Boolean(process.versions.node),X=!1,K=!1,Q=fetch,Y=FormData,Z=G?window.adapter:void 0,ee=G?window.navigator:void 0,te=G&&ee?ee.mediaDevices:void 0,se=G?window.MediaStream:void 0,ne=G?window.MediaStreamTrack:void 0,re=G?window.RTCIceCandidate:void 0,ie=G?window.RTCPeerConnection:void 0,ae=G?window.RTCRtpReceiver:void 0,oe=G?window.RTCRtpSender:void 0,ce=G?window.RTCSessionDescription:void 0,le=!!G&&Boolean(te&&ie);le&&!Z&&console.warn("Install WebRTC adapter if you want to use ConnectyCube.videochatconference. More info https://github.com/webrtc/adapter");var de=Object.freeze({__proto__:null,FormDataImpl:Y,MediaStream:se,MediaStreamTrack:ne,RTCIceCandidate:re,RTCPeerConnection:ie,RTCRtpReceiver:ae,RTCRtpSender:oe,RTCSessionDescription:ce,adapter:Z,base64Encode:W,fetchImpl:Q,isBrowser:G,isExpo:K,isNodeJS:H,isReactNative:X,isWebRTCAvailable:le,mediaDevices:te,navigator:ee,sdkVersion:B});class ue{static instance;version=B;creds={appId:"",authKey:""};endpoints={api:"api.connectycube.com",chat:"chat.connectycube.com",muc:"muc.chat.connectycube.com"};chatProtocol={bosh:"https://chat.connectycube.com:5281",websocket:"wss://chat.connectycube.com:5291",active:2};chat={streamManagement:{enable:!1},reconnect:{enable:!0,timeInterval:5},apiImp:y.XMPP};videochat={alwaysRelayCalls:!1,answerTimeInterval:60,dialingTimeInterval:5,disconnectTimeInterval:30,statsReportTimeInterval:null,iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:turn.connectycube.com"},{urls:"turn:turn.connectycube.com:5349?transport=udp",username:"connectycube",credential:"4c29501ca9207b7fb9c4b4b6b04faeb1"},{urls:"turn:turn.connectycube.com:5349?transport=tcp",username:"connectycube",credential:"4c29501ca9207b7fb9c4b4b6b04faeb1"}]};conference={server:"wss://janus.connectycube.com:8989",debug:f.ALL};whiteboard={server:"https://whiteboard.connectycube.com"};linkpreview={server:"https://linkpreview.connectycube.com"};urls={session:"session",login:"login",users:"users",chat:"chat",blobs:"blobs",subscriptions:"subscriptions",events:"events",data:"data",addressbook:"address_book",meetings:"meetings",whiteboards:"whiteboards",unfurl:"unfurl",calls:"calls",type:".json"};on={sessionExpired:void 0,xmppDataWrite:void 0,xmppDataRead:void 0};timeout=null;debug={mode:1};constructor(){}static getInstance(){return ue.instance||(ue.instance=new ue),ue.instance}set(e){this.endpoints.api_url=e.endpoints?.api_url,e.endpoints?.chat&&(this.endpoints.muc=`muc.${e.endpoints.chat}`,this.chatProtocol.bosh=`https://${e.endpoints.chat}:5281`,this.chatProtocol.websocket=e.endpoints.chat_url??`wss://${e.endpoints.chat}:5291`),Object.keys(e).forEach(t=>{if("set"!==t&&this.hasOwnProperty(t)){const s=e[t];"object"==typeof s&&null!==s?Object.keys(s).forEach(e=>{this[t]?.hasOwnProperty(e)&&(this[t][e]=s[e])}):this[t]=s}})}}var he=ue.getInstance();class pe{static loggers=[];static env={isReactNative:X,isBrowser:G,isNodeJS:H,isExpo:K};static safeCallbackCall(e=()=>{}){return(...t)=>{if("function"==typeof e)try{e(...t)}catch(t){console.error("Error in listener:",t,`Check the code:\n>>>\n${e.toString()}\n<<<`)}}}static getUrl(e,t,s){const n=t?`/${t}`:"",r=s?`/${s}`:"";return`${he.endpoints.api_url??`https://${he.endpoints.api}`}/${e}${n}${r}${he.urls.type}`}static isArray(e){return Array.isArray(e)}static isObject(e){return"[object Object]"===Object.prototype.toString.call(e)}static getBsonObjectId(){const e={machine:Math.floor(16777216*Math.random()).toString(16),pid:Math.floor(32767*Math.random()).toString(16),increment:0},t=Math.floor(Date.now()/1e3).toString(16),s=(e.increment++).toString(16);return parseInt(s,16)>16777215&&(e.increment=0),t.padStart(8,"0")+e.machine.padStart(6,"0")+e.pid.padStart(4,"0")+s.padStart(6,"0")}static DLog(...e){if(pe.loggers.length>0)return void pe.loggers.forEach(t=>t(e));if("object"==typeof he.debug){(Array.isArray(he.debug.mode)?he.debug.mode:[he.debug.mode]).forEach(e=>{1===e&&pe.loggers.push(e=>{console.log(...e)})})}pe.loggers.forEach(t=>t(e))}static callTrafficUsageCallback(e,t){if("function"==typeof he.on[e]){const s=e=>new Blob([e]).size,n=(e={})=>{const{body:t,headers:n}=e;let r=0;return t&&(r+=s("string"==typeof t?t:JSON.stringify(t))),n&&(r+=s(JSON.stringify(n))),r};he.on[e](n(t),t)}}static cloneObject(e={},t=!1){try{const s=JSON.stringify(e),n=t?s.replace(/null/g,'""'):s;return JSON.parse(n)}catch{return e}}}class me{sdkInstance={config:he,session:null};requestsNumber=0;fetchImpl=Q;currentUserId;abortControllersMap={};requestMethod=D;responseType=R;setSession(e){this.sdkInstance.session=e,e&&e.user_id&&this.setCurrentUserId(e.user_id)}getSession(){return this.sdkInstance.session}setCurrentUserId(e){this.currentUserId=e||void 0}getCurrentUserId(){return this.currentUserId}logRequest(e,t){pe.DLog(`[Request][${t}]`,`${e.type||"GET"} ${e.url}`,e)}logResponse(e,t){pe.DLog(`[Response][${t}]`,e)}buildRequestAndURL(e){const t=!e.type||"GET"===e.type||"HEAD"===e.type,s=!!e.type&&("POST"===e.type||"PUT"===e.type),n=this.sdkInstance&&this.sdkInstance.session&&this.sdkInstance.session.token,r=-1===e.url.indexOf("s3.amazonaws.com"),i=!1===e.contentType,a=e.authKey;let o,c=e.url;const l={};return l.method=e.type||"GET",e.data&&(o=this.buildRequestBody(e,i,s),t?c+=`?${o}`:l.body=o),i||(l.headers={"Content-Type":s?"application/json;charset=utf-8":"application/x-www-form-urlencoded; charset=UTF-8"}),r&&(l.headers||(l.headers={}),l.headers["CB-SDK"]=`JS ${he.version} - Client`,n?l.headers["CB-Token"]=n:a&&(l.headers["CB-AuthKey"]=a)),he.timeout&&(l.timeout=he.timeout),[l,c]}buildRequestBody(e,t,s){const n=e.data,r=e.useArrayQuery;let i;return t?(i=new Y,Object.keys(n).forEach(function(t){e.fileToCustomObject&&"file"===t?i.append(t,n[t].data,n[t].name):i.append(t,e.data[t])})):i=s?JSON.stringify(n):this.serializeQueryParams(n,"",r,0),i}serializeQueryParams(e,t,s,n=0){const r=[];for(let i in e){let a=this.encodeURIComponent(i);pe.isArray(e)&&(a="");const o=t?t+`[${a}]`:a;let c=e[i];const l=pe.isArray(c);l&&(s||0===n)||pe.isObject(c)?r.push(this.serializeQueryParams(c,o,s,++n)):(c=l?c.sort().join(","):c,r.push(`${o}=${this.encodeURIComponent(c)}`))}return r.sort().join("&")}encodeURIComponent(e){return encodeURIComponent(e).replace(/[#$&+,/:;=?@\[\]]/g,e=>`%${e.charCodeAt(0).toString(16)}`)}abortRequest(e){if(this.abortControllersMap[e]){(this.abortControllersMap[e].controllers||[]).forEach(e=>{e.abort()})}}processSuccessfulOrFailedRequest(e){if(!e||!this.abortControllersMap[e])return;const t=this.abortControllersMap[e].controllers||[];this.abortControllersMap[e].doneRequestsCount?this.abortControllersMap[e].doneRequestsCount+=1:this.abortControllersMap[e].doneRequestsCount=1;this.abortControllersMap[e].doneRequestsCount===t.length&&delete this.abortControllersMap[e]}async ajax(e){const t=++this.requestsNumber;return new Promise((s,n)=>{this.logRequest(e,t);const[r,i]=this.buildRequestAndURL(e),a=e.abort_id;if(a){let e=0;if(this.abortControllersMap[a]){const t=this.abortControllersMap[a].controllers||[];this.abortControllersMap[a].controllers.push(new AbortController),e=t.length-1}else this.abortControllersMap[a]={controllers:[new AbortController]};const t=this.abortControllersMap[a].controllers[e].signal;Object.assign(r,{signal:t})}let o;Q(i,r).then(t=>{o=t;return(e.dataType||R.JSON)===R.TEXT?o.text():o.json()}).then(r=>{this.processSuccessfulOrFailedRequest(a),o.ok?this.processAjaxResponse(r,s,t):this.processAjaxError(o,r,null,n,s,e,t)}).catch(r=>{this.processSuccessfulOrFailedRequest(a),this.processAjaxError(o," ",r,n,s,e,t)})})}processAjaxResponse(e,t,s){const n=e&&" "!==e?e:"empty body";this.logResponse(n,s),t(e)}processAjaxError(e,t,s,n,r,i,a){if(!e&&s&&!s.code)return void n(s);const o=t||s||t.errors,c=e?.status,l={code:e&&c||s&&s.code,info:(t&&"string"==typeof t&&" "!==t?JSON.parse(t):t)||s&&s.errno};this.logResponse(o,a),-1===e?.url.indexOf(he.urls.session)&&this.isExpiredSessionError(l)&&"function"==typeof he.on.sessionExpired?this.handleExpiredSessionResponse(l,null,n,r,i):n(l)}handleExpiredSessionResponse(e,t,s,n,r){const i=()=>{e?s(e):n(t)},a=e=>{e&&(this.setSession(e),this.ajax(r).then(n).catch(s))};"function"==typeof he.on.sessionExpired&&he.on.sessionExpired(i,a)}isExpiredSessionError(e){try{return e&&401===e.code&&"Required session does not exist"===e.info?.errors?.base?.[0]}catch{return!1}}}class ge{proxy;route=he.urls.addressbook;constructor(e){this.proxy=e}async uploadAddressBook(e=[],t={}){if(!pe.isArray(e))throw new Error("First parameter must be an Array.");const s={type:D.POST,url:pe.getUrl(this.route),data:{contacts:e,...t}};return this.proxy.ajax(s)}async get(e){const t={type:D.GET,url:pe.getUrl(this.route),data:e?{udid:e}:void 0};return this.proxy.ajax(t)}async getRegisteredUsers(e=!1){const t={type:D.GET,url:pe.getUrl(this.route,"registered_users"),data:"boolean"==typeof e?{compact:e?1:0}:e};return this.proxy.ajax(t)}}class fe{proxy;routes={session:he.urls.session,login:he.urls.login};constructor(e){this.proxy=e}setSession=e=>{this.proxy.setSession(e)};getSession=async()=>{try{const e={type:D.GET,url:pe.getUrl(this.routes.session)};return(await this.proxy.ajax(e)).session}catch(e){throw e}};createSession=async(e={})=>{if(""===he.creds.appId||""===he.creds.authKey)throw new Error('Cannot create a new session without "appId" and "authKey"');try{const t={type:D.POST,url:pe.getUrl(this.routes.session),data:this.generateCreateSessionParams(e)},s=await this.proxy.ajax(t);return this.proxy.setSession(s.session),this.proxy.setCurrentUserId(s.session.user_id),s.session}catch(e){throw e}};destroySession=async()=>{try{const e={type:D.DELETE,url:pe.getUrl(this.routes.session),dataType:R.TEXT};await this.proxy.ajax(e),this.proxy.setSession(null),this.proxy.setCurrentUserId(null)}catch(e){throw e}};login=async e=>{try{const t={type:D.POST,url:pe.getUrl(this.routes.login),data:e},{user:s}=await this.proxy.ajax(t);return this.proxy.setCurrentUserId(s.id),s}catch(e){throw e}};logout=async()=>{const e={type:D.DELETE,url:pe.getUrl(this.routes.login),dataType:R.TEXT};return this.proxy.setCurrentUserId(null),this.proxy.ajax(e)};generateCreateSessionParams(e={}){const t={application_id:he.creds.appId,auth_key:he.creds.authKey};return"guest"in e?t.user=e:"login"in e&&"password"in e?t.user={login:e.login,password:e.password}:"email"in e&&"password"in e?t.user={email:e.email,password:e.password}:"provider"in e&&(t.provider=e.provider,"keys"in e&&(t.keys=e.keys),"firebase_phone"in e&&(t.firebase_phone=e.firebase_phone),"firebase_email"in e&&(t.firebase_email=e.firebase_email)),t}}function ye(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function be(e){if(Object.prototype.hasOwnProperty.call(e,"__esModule"))return e;var t=e.default;if("function"==typeof t){var s=function e(){var s=!1;try{s=this instanceof e}catch{}return s?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};s.prototype=t.prototype}else s={};return Object.defineProperty(s,"__esModule",{value:!0}),Object.keys(e).forEach(function(t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(s,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}),s}var ve,Ce,Se,we={};function Ee(){if(ve)return we;ve=1;const e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"};function t(t){return e[t]}const s={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&apos;":"'"};function n(e){if("#"===e[1]){const t="x"===e[2]?parseInt(e.slice(3),16):parseInt(e.slice(2),10);if(9===t||10===t||13===t||t>=32&&t<=55295||t>=57344&&t<=65533||t>=65536&&t<=1114111)return String.fromCodePoint(t);throw new Error("Illegal XML character 0x"+t.toString(16))}if(s[e])return s[e]||e;throw new Error("Illegal XML entity "+e)}return we.escapeXML=function(e){return e.replace(/["&'<>]/g,t)},we.escapeXMLText=function(e){return e.replace(/[&<>]/g,t)},we.unescapeXML=function(e){let t="",s=-1,r=-1,i=0;for(;-1!==(s=e.indexOf("&",i))&&-1!==(r=e.indexOf(";",s+1));)t=t+e.slice(i,s)+n(e.slice(s,r+1)),i=r+1;return 0===i?e:(t+=e.substring(i),t)},we.unescapeXMLText=function(e){return e.replace(/&(amp|#38|lt|#60|gt|#62);/g,n)},we}function Te(){if(Se)return Ce;Se=1;var e=Ee();class t{constructor(e,t){this.name=e,this.parent=null,this.children=[],this.attrs={},this.setAttrs(t)}is(e,t){return this.getName()===e&&(!t||this.getNS()===t)}getName(){const e=this.name.indexOf(":");return e>=0?this.name.slice(e+1):this.name}getNS(){const e=this.name.indexOf(":");if(e>=0){const t=this.name.slice(0,e);return this.findNS(t)}return this.findNS()}findNS(e){if(e){const t="xmlns:"+e;if(this.attrs[t])return this.attrs[t];if(this.parent)return this.parent.findNS(e)}else{if(this.attrs.xmlns)return this.attrs.xmlns;if(this.parent)return this.parent.findNS()}}getXmlns(){let e={};this.parent&&(e=this.parent.getXmlns());for(const t in this.attrs){const s=t.match("xmlns:?(.*)");this.attrs.hasOwnProperty(t)&&s&&(e[this.attrs[t]]=s[1])}return e}setAttrs(e){"string"==typeof e?this.attrs.xmlns=e:e&&Object.assign(this.attrs,e)}getAttr(e,t){if(!t)return this.attrs[e];const s=this.getXmlns();return s[t]?this.attrs[[s[t],e].join(":")]:null}getChild(e,t){return this.getChildren(e,t)[0]}getChildren(e,t){const s=[];for(const n of this.children)!n.getName||n.getName()!==e||t&&n.getNS()!==t||s.push(n);return s}getChildByAttr(e,t,s,n){return this.getChildrenByAttr(e,t,s,n)[0]}getChildrenByAttr(e,t,s,n){let r=[];for(const i of this.children)!i.attrs||i.attrs[e]!==t||s&&i.getNS()!==s||r.push(i),n&&i.getChildrenByAttr&&r.push(i.getChildrenByAttr(e,t,s,!0));return n&&(r=r.flat()),r}getChildrenByFilter(e,t){let s=[];for(const n of this.children)e(n)&&s.push(n),t&&n.getChildrenByFilter&&s.push(n.getChildrenByFilter(e,!0));return t&&(s=s.flat()),s}getText(){let e="";for(const t of this.children)"string"!=typeof t&&"number"!=typeof t||(e+=t);return e}getChildText(e,t){const s=this.getChild(e,t);return s?s.getText():null}getChildElements(){return this.getChildrenByFilter(e=>e instanceof t)}root(){return this.parent?this.parent.root():this}up(){return this.parent?this.parent:this}c(e,s){return this.cnode(new t(e,s))}cnode(e){return this.children.push(e),"object"==typeof e&&(e.parent=this),e}append(...e){for(const t of e)this.children.push(t),"object"==typeof t&&(t.parent=this)}prepend(...e){for(const t of e)this.children.unshift(t),"object"==typeof t&&(t.parent=this)}t(e){return this.children.push(e),this}remove(e,t){const s="string"==typeof e?s=>!(s.is&&s.is(e,t)):t=>t!==e;return this.children=this.children.filter(s),this}text(e){return e&&1===this.children.length?(this.children[0]=e,this):this.getText()}attr(e,t){return void 0!==t||null===t?(this.attrs||(this.attrs={}),this.attrs[e]=t,this):this.attrs[e]}toString(){let e="";return this.write(t=>{e+=t}),e}_addChildren(t){t(">");for(const s of this.children)null!=s&&(s.write?s.write(t):"string"==typeof s?t(e.escapeXMLText(s)):s.toString&&t(e.escapeXMLText(s.toString(10))));t("</"),t(this.name),t(">")}write(t){t("<"),t(this.name);for(const s in this.attrs){const n=this.attrs[s];null!=n&&(t(" "),t(s),t('="'),t(e.escapeXML("string"==typeof n?n:n.toString(10))),t('"'))}0===this.children.length?t("/>"):this._addChildren(t)}}return t.prototype.tree=t.prototype.root,Ce=t}var ke,Ie,xe=ye(Te());var Ae,Le,De,Re=function(){if(Ie)return ke;Ie=1;var e=Te();function t(e,s){if(Array.isArray(s))for(const n of s)t(e,n);else""!==s&&null!=s&&!0!==s&&!1!==s&&e.cnode(s)}return ke=function(s,n,...r){if("object"==typeof n&&null!==n){delete n.__source,delete n.__self;for(const[e,t]of Object.entries(n))null==t?delete n[e]:n[e]=t.toString(10)}const i=new e(s,n);for(const e of r)t(i,e);return i}}(),Oe=ye(Re),Pe=Ee(),_e={exports:{}};function Me(){return Ae||(Ae=1,function(e){var t=Object.prototype.hasOwnProperty,s="~";function n(){}function r(e,t,s){this.fn=e,this.context=t,this.once=s||!1}function i(e,t,n,i,a){if("function"!=typeof n)throw new TypeError("The listener must be a function");var o=new r(n,i||e,a),c=s?s+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],o]:e._events[c].push(o):(e._events[c]=o,e._eventsCount++),e}function a(e,t){0===--e._eventsCount?e._events=new n:delete e._events[t]}function o(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),(new n).__proto__||(s=!1)),o.prototype.eventNames=function(){var e,n,r=[];if(0===this._eventsCount)return r;for(n in e=this._events)t.call(e,n)&&r.push(s?n.slice(1):n);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(e)):r},o.prototype.listeners=function(e){var t=s?s+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var r=0,i=n.length,a=new Array(i);r<i;r++)a[r]=n[r].fn;return a},o.prototype.listenerCount=function(e){var t=s?s+e:e,n=this._events[t];return n?n.fn?1:n.length:0},o.prototype.emit=function(e,t,n,r,i,a){var o=s?s+e:e;if(!this._events[o])return!1;var c,l,d=this._events[o],u=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,n),!0;case 4:return d.fn.call(d.context,t,n,r),!0;case 5:return d.fn.call(d.context,t,n,r,i),!0;case 6:return d.fn.call(d.context,t,n,r,i,a),!0}for(l=1,c=new Array(u-1);l<u;l++)c[l-1]=arguments[l];d.fn.apply(d.context,c)}else{var h,p=d.length;for(l=0;l<p;l++)switch(d[l].once&&this.removeListener(e,d[l].fn,void 0,!0),u){case 1:d[l].fn.call(d[l].context);break;case 2:d[l].fn.call(d[l].context,t);break;case 3:d[l].fn.call(d[l].context,t,n);break;case 4:d[l].fn.call(d[l].context,t,n,r);break;default:if(!c)for(h=1,c=new Array(u-1);h<u;h++)c[h-1]=arguments[h];d[l].fn.apply(d[l].context,c)}}return!0},o.prototype.on=function(e,t,s){return i(this,e,t,s,!1)},o.prototype.once=function(e,t,s){return i(this,e,t,s,!0)},o.prototype.removeListener=function(e,t,n,r){var i=s?s+e:e;if(!this._events[i])return this;if(!t)return a(this,i),this;var o=this._events[i];if(o.fn)o.fn!==t||r&&!o.once||n&&o.context!==n||a(this,i);else{for(var c=0,l=[],d=o.length;c<d;c++)(o[c].fn!==t||r&&!o[c].once||n&&o[c].context!==n)&&l.push(o[c]);l.length?this._events[i]=1===l.length?l[0]:l:a(this,i)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=s?s+e:e,this._events[t]&&a(this,t)):(this._events=new n,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=s,o.EventEmitter=o,e.exports=o}(_e)),_e.exports}var Ne=function(){if(De)return Le;De=1;var e=Me(),t=Ee();class s extends e.EventEmitter{constructor(){super();let e,s,n,r,i,a,o,c,l,d=0,u=0;this._handleTagOpening=function(e,t,s){e?this.emit("endElement",t,!1):(this.emit("startElement",t,s),a&&this.emit("endElement",t,!0))},this.write=function(h){"string"!=typeof h&&(h=h.toString());let p=0;function m(){if("number"==typeof u){const e=h.slice(u,p);return u=void 0,e}}for(e&&(h=e+h,p+=s?0:e.length,s=!1,e=null);p<h.length;p++){switch(d){case 0:{const e=h.indexOf("<",p);-1!==e&&p!==e&&(p=e);break}case 8:{const e=h.indexOf(c,p);-1!==e&&(p=e);break}case 1:{const e=h.indexOf("--\x3e",p);-1!==e&&(p=e+2);break}case 10:{const e=h.indexOf("]]>",p);-1!==e&&(p=e+2);break}}const e=h.charCodeAt(p);switch(d){case 0:if(60===e){const e=m();e&&this.emit("text",t.unescapeXML(e)),d=3,u=p+1,r={}}break;case 9:if(93===e)if("]>"===h.substr(p+1,2)){const e=m();e&&this.emit("text",e),d=0}else h.length<p+2&&(s=!0,p=h.length);break;case 3:47===e&&u===p?(u=p+1,i=!0):33===e?"[CDATA["===h.substr(p+1,7)?(u=p+8,d=9):h.length<p+8&&"[CDATA[".startsWith(h.slice(p+1))?(s=!0,p=h.length):(u=void 0,d=1):63===e?(u=void 0,d=2):(e<=32||47===e||62===e)&&(n=m(),p--,d=4);break;case 1:if(62===e){const e=h.charCodeAt(p-1),t=h.charCodeAt(p-2);(45===e&&45===t||93===e&&93===t)&&(d=0)}break;case 2:if(62===e){63===h.charCodeAt(p-1)&&(d=0)}break;case 4:62===e?(this._handleTagOpening(i,n,r),n=void 0,r=void 0,i=void 0,a=void 0,d=0,u=p+1):47===e?a=!0:e>32&&(u=p,d=5);break;case 5:(e<=32||61===e)&&(l=m(),p--,d=6);break;case 6:61===e&&(d=7);break;case 7:34!==e&&39!==e||(o=e,c=34===e?'"':"'",d=8,u=p+1);break;case 8:if(e===o){const e=t.unescapeXML(m());r[l]=e,l=void 0,d=4}}}"number"==typeof u&&u<=h.length&&(e=h.slice(u),u=0)}}end(e){e&&this.write(e),this.write=function(){}}}return Le=s}(),je=ye(Ne),Ue=ye(Me());class Je extends Error{constructor(e){super(e),this.name="TimeoutError"}}function Fe(e,t){const s=function(e){let t;const s=new Promise(s=>{t=setTimeout(s,e)});return s.timeout=t,s}(t);const n=new Je;return Promise.race([e.finally(function(){clearTimeout(s.timeout)}),s.then(()=>{throw n})])}const $e=new WeakMap;function qe(e){let t=$e.get(e);if(!t){t={on:(e.addEventListener??e.addListener).bind(e),off:(e.removeEventListener??e.removeListener).bind(e),once:(e.once??((t,s)=>e.addEventListener(t,s,{once:!0}))).bind(e)},$e.set(e,t)}return t}function Ve(e,t,s="error",n){return new Promise((r,i)=>{let a;const{off:o,once:c}=qe(e),l=()=>{clearTimeout(a),o(t,u),o(s,d)};function d(e){i(e),l()}function u(e){r(e),l()}if(c(t,u),s&&c(s,d),n){const e=new Je;a=setTimeout(()=>{l(),i(e)},n)}})}function ze(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}function We(e,t=null,s){return new Promise((n,r)=>{function i(t){e.removeListener("nonza",o),r(t)}function a(...t){e.removeListener("nonza",o),n(...t)}async function o(e){try{await s(e,a)}catch(e){i(e)}}t&&e.send(t).catch(i),e.on("nonza",o)})}function Be(e){return{subscribe(t){const{on:s}=qe(t);for(const[t,n]of Object.entries(e))s(t,n)},unsubscribe(t){const{off:s}=qe(t);for(const[t,n]of Object.entries(e))s(t,n)}}}class Ge extends Error{constructor(...e){super(...e),this.name="XMLError"}}class He extends Ue{constructor(){super();const e=new je;this.root=null,this.cursor=null,e.on("startElement",this.onStartElement.bind(this)),e.on("endElement",this.onEndElement.bind(this)),e.on("text",this.onText.bind(this)),this.parser=e}onStartElement(e,t){const s=new xe(e,t),{root:n,cursor:r}=this;n?r!==n&&r.append(s):(this.root=s,this.emit("start",s)),this.cursor=s}onEndElement(e){const{root:t,cursor:s}=this;if(e===s.name){if(s!==t)return s.parent?void(this.cursor=s.parent):(s.parent=t,this.emit("element",s),void(this.cursor=t));this.emit("end",t)}else this.emit("error",new Ge(`${s.name} must be closed.`))}onText(e){const{cursor:t}=this;t?t.t(e):this.emit("error",new Ge(`${e} must be a child.`))}write(e){this.parser.write(e)}end(e){e&&this.parser.write(e)}}function Xe(...e){return Oe(...e)}function Ke(e){if(!e)return!1;return-1!==e.replaceAll(String.raw`\20`,"").replaceAll(String.raw`\22`,"").replaceAll(String.raw`\26`,"").replaceAll(String.raw`\27`,"").replaceAll(String.raw`\2f`,"").replaceAll(String.raw`\3a`,"").replaceAll(String.raw`\3c`,"").replaceAll(String.raw`\3e`,"").replaceAll(String.raw`\40`,"").replaceAll(String.raw`\5c`,"").search(/[ "&'/:<>@\\]/g)}function Qe(e){return null===e?null:e.replaceAll(/^\s+|\s+$/g,"").replaceAll("\\",String.raw`\5c`).replaceAll(" ",String.raw`\20`).replaceAll('"',String.raw`\22`).replaceAll("&",String.raw`\26`).replaceAll("'",String.raw`\27`).replaceAll("/",String.raw`\2f`).replaceAll(":",String.raw`\3a`).replaceAll("<",String.raw`\3c`).replaceAll(">",String.raw`\3e`).replaceAll("@",String.raw`\40`)}function Ye(e){return null===e?null:e.replaceAll(String.raw`\20`," ").replaceAll(String.raw`\22`,'"').replaceAll(String.raw`\26`,"&").replaceAll(String.raw`\27`,"'").replaceAll(String.raw`\2f`,"/").replaceAll(String.raw`\3a`,":").replaceAll(String.raw`\3c`,"<").replaceAll(String.raw`\3e`,">").replaceAll(String.raw`\40`,"@").replaceAll(String.raw`\5c`,"\\")}He.XMLError=Ge,Object.assign(Xe,{Element:xe,createElement:Oe,Parser:He,escapeXML:Pe.escapeXML,unescapeXML:Pe.unescapeXML,escapeXMLText:Pe.escapeXMLText,unescapeXMLText:Pe.unescapeXMLText,XMLError:Ge,xml:Xe});class Ze{constructor(e,t,s){if("string"!=typeof t||!t)throw new TypeError("Invalid domain.");this.setDomain(t),this.setLocal("string"==typeof e?e:""),this.setResource("string"==typeof s?s:"")}[Symbol.toPrimitive](e){return"number"===e?Number.NaN:this.toString()}toString(e){let t=this._domain;return this._local&&(t=this.getLocal(e)+"@"+t),this._resource&&(t=t+"/"+this._resource),t}bare(){return this._resource?new Ze(this._local,this._domain,null):this}equals(e){return this._local===e._local&&this._domain===e._domain&&this._resource===e._resource}setLocal(e,t){return(t=t||Ke(e))&&(e=Qe(e)),this._local=e&&e.toLowerCase(),this}getLocal(e=!1){let t=null;return t=e?Ye(this._local):this._local,t}setDomain(e){return this._domain=e.toLowerCase(),this}getDomain(){return this._domain}setResource(e){return this._resource=e,this}getResource(){return this._resource}}function et(e){let t,s;const n=e.indexOf("/");-1!==n&&(s=e.slice(n+1),e=e.slice(0,n));const r=e.indexOf("@");return-1!==r&&(t=e.slice(0,r),e=e.slice(r+1)),new Ze(t,e,s)}function tt(...e){return e[1]||e[2]?new Ze(...e):et(...e)}Object.defineProperty(Ze.prototype,"local",{get:Ze.prototype.getLocal,set:Ze.prototype.setLocal}),Object.defineProperty(Ze.prototype,"domain",{get:Ze.prototype.getDomain,set:Ze.prototype.setDomain}),Object.defineProperty(Ze.prototype,"resource",{get:Ze.prototype.getResource,set:Ze.prototype.setResource});const st=tt.bind();st.jid=tt,st.JID=Ze,st.parse=et,st.equal=function(e,t){return e.equals(t)},st.detectEscape=Ke,st.escapeLocal=Qe,st.unescapeLocal=Ye;class nt extends Error{constructor(e,t,s){super(e+(t?` - ${t}`:"")),this.name="XMPPError",this.condition=e,this.text=t,this.application=s}static fromElement(e){const[t,s,n]=e.getChildElements();let r,i;s&&(s.is("text")?r=s:s&&(i=s),n&&(i=n));const a=new this(t.name,r?r.text():"",i);return a.element=e,a}}class rt extends nt{constructor(...e){super(...e),this.name="StreamError"}}function it(e){let{port:t,hostname:s,protocol:n}=new URL(e);return"[::1]"===s&&(s="::1"),{port:t,hostname:s,protocol:n}}function at(e){const{port:t,hostname:s}=it(`http://${e}`);return{port:t,hostname:s}}class ot extends Ue{#e=null;#t=null;constructor(e={}){super(),"string"==typeof e&&(e={domain:e}),this.jid=null,this.timeout=e.timeout||2e3,this.options=e,this.status="offline",this.socket=null,this.parser=null,this.root=null}isSecure(){return!0===this.socket?.secure}async _streamError(e,t){try{await this.send(Xe("stream:error",{},[Xe(e,{xmlns:"urn:ietf:params:xml:ns:xmpp-streams"},t)]))}catch{}return this.disconnect()}_onData(e){const t=e.toString("utf8");this.parser.write(t)}#s(e){this._streamError("bad-format"),this._detachParser(),this.emit("error",e)}#n(e,t){this._detachSocket(),this._status("disconnect",{clean:!e,reason:t})}#r(e,t){this._detachParser(),this._status("close",{clean:!e,reason:t})}_attachSocket(e){this.socket=e,this.#e??=Be({data:this._onData.bind(this),close:this.#n.bind(this),connect:()=>this._status("connect"),error:e=>this.emit("error",e)}),this.#e.subscribe(this.socket)}_detachSocket(){this.socket&&this.#e?.unsubscribe(this.socket),this.socket=null}_onElement(e){const t=e.is("error","http://etherx.jabber.org/streams");t&&this._onStreamError(e),this.emit("element",e),this.emit(this.isStanza(e)?"stanza":"nonza",e),t&&this.disconnect()}_onStreamError(e){const t=rt.fromElement(e);if("see-other-host"===t.condition)return this._onSeeOtherHost(t);this.emit("error",t)}async _onSeeOtherHost(e){const{protocol:t}=function(e){return e.includes("://")?it(e):at(e)}(this.options.service),s=e.element.getChildText("see-other-host"),{port:n}=at(s);let r;r=n?`${t||"xmpp:"}//${s}`:(t?`${t}//`:"")+s;try{await Ve(this,"disconnect");const{domain:e,lang:t}=this.options;await this.connect(r),await this.open({domain:e,lang:t})}catch(e){this.emit("error",e)}}_attachParser(e){this.parser=e,this.#t??=Be({element:this._onElement.bind(this),error:this.#s.bind(this),end:this.#r.bind(this),start:e=>this._status("open",e)}),this.#t.subscribe(this.parser)}_detachParser(){this.parser&&this.#t?.unsubscribe(this.parser),this.parser=null,this.root=null}_jid(e){return this.jid=st(e),this.jid}_status(e,...t){this.status!==e&&(this.status=e,this.emit("status",e,...t),this.emit(e,...t))}_ready(e=!1){e?this.status="online":this._status("online",this.jid)}async disconnect(){let e;try{e=await this._closeStream()}catch(e){this.#r(e)}try{await this._closeSocket()}catch(e){this.#n(!0,e)}return e}async start(){if("offline"!==this.status)throw new Error("Connection is not offline");const{service:e,domain:t,lang:s}=this.options;await this.connect(e);const n=Ve(this,"online");return await this.open({domain:t,lang:s}),n}async connect(e){this._status("connecting",e);const t=new this.Socket;return this._attachSocket(t),t.connect(this.socketParameters(e)),Ve(t,"connect")}async _closeSocket(e=this.timeout){this._status("disconnecting"),this.socket.end(),await Ve(this.socket,"close","error",e)}async open(e){this._status("opening");const{domain:t,lang:s}=e,n=this.headerElement();return n.attrs.to=t,n.attrs["xml:lang"]=s,this.root=n,this._attachParser(new this.Parser),await this.write(this.header(n)),Ve(this,"open","error",this.timeout)}async stop(){const e=await this.disconnect();return this._status("offline",e),e}async _closeStream(e=this.timeout){await this.#i("close");const t=this.footer(this.footerElement());return await this.write(t),this._status("closing"),Ve(this.parser,"end","error",e)}async restart(){this._detachParser();const{domain:e,lang:t}=this.options;return this.open({domain:e,lang:t})}async send(e){e.parent=this.root,await this.write(e.toString()),this.emit("send",e)}sendReceive(e,t=this.timeout){return Promise.all([this.send(e),Ve(this,"element","error",t)]).then(([,e])=>e)}async write(e){if("closing"===this.status)throw new Error("Connection is closing");return new Promise((t,s)=>{this.socket.write(e,e=>e?s(e):t())})}isStanza(e){const{name:t}=e;return"iq"===t||"message"===t||"presence"===t}isNonza(e){return!this.isStanza(e)}header(e){return e.toString()}headerElement(){return new Xe.Element("",{version:"1.0",xmlns:this.NS})}footer(e){return e.toString()}footerElement(){}socketParameters(){}#a=new Map;#o=new Set(["close"]);hook(e,t){this.#c(e),this.#a.has(e)||this.#a.set(e,new Set),this.#a.get(e).add([t])}#c(e){if(!this.#o.has(e))throw new Error(`Hook event name "${e}" is unknown.`)}unhook(e,t){this.#c(e);const s=this.#a.get("event"),n=[...s].find(e=>e.handler===t);s.remove(n)}async#i(e,...t){this.#c(e);const s=this.#a.get(e);s&&await Promise.all([...s].map(async([e])=>{try{await e(...t)}catch(e){this.emit("error",e)}}))}}ot.prototype.NS="",ot.prototype.Socket=null,ot.prototype.Parser=null;class ct extends ot{constructor(e){super(e),this.transports=[]}send(e,...t){return this.Transport.prototype.send.call(this,e,...t)}sendMany(...e){return this.Transport.prototype.sendMany.call(this,...e)}_findTransport(e){return this.transports.find(t=>{try{return void 0!==t.prototype.socketParameters(e)}catch{return!1}})}connect(e){const t=this._findTransport(e);if(!t)throw new Error("No compatible connection method found.");return this.Transport=t,this.Socket=t.prototype.Socket,this.Parser=t.prototype.Parser,super.connect(e)}socketParameters(...e){return this.Transport.prototype.socketParameters(...e)}header(e,...t){const s=this.isSecure()&&this.jid?.bare().toString();return s&&(e.attrs.from=s),this.Transport.prototype.header(e,...t)}headerElement(...e){return this.Transport.prototype.headerElement(...e)}footer(...e){return this.Transport.prototype.footer(...e)}footerElement(...e){return this.Transport.prototype.footerElement(...e)}}ct.prototype.NS="jabber:client";class lt extends Ue{constructor(e){super(),this.delay=1e3,this.entity=e,this._timeout=null}#l=()=>{this.scheduleReconnect()};scheduleReconnect(){const{entity:e,delay:t,_timeout:s}=this;clearTimeout(s),this._timeout=setTimeout(async()=>{if("disconnect"===e.status)try{await this.reconnect()}catch{}},t)}async reconnect(){const{entity:e}=this;this.emit("reconnecting");const{service:t,domain:s,lang:n}=e.options;await e.connect(t),await e.open({domain:s,lang:n}),this.emit("reconnected")}start(){const{entity:e}=this;e.on("disconnect",this.#l)}stop(){const{entity:e,_timeout:t}=this;e.removeListener("disconnect",this.#l),clearTimeout(t)}}const dt="ECONNERROR";const ut="urn:ietf:params:xml:ns:xmpp-framing";class ht extends ot{send(e,...t){return e.attrs.xmlns??=this.NS,super.send(e,...t)}async sendMany(e){for(const t of e)t.attrs.xmlns??=this.NS,t.parent=this.root,this.socket.write(t.toString()),this.emit("send",t)}footerElement(){return new Xe.Element("close",{xmlns:ut})}headerElement(){const e=super.headerElement();return e.name="open",e.attrs.xmlns=ut,e}socketParameters(e){return/^wss?:\/\//.test(e)?e:void 0}}var pt,mt;ht.prototype.Socket=class extends Ue{#d=null;socket=null;url=null;secure=!1;connect(e){this.url=e,this.secure=function(e){const t=it(e);return"wss:"===t.protocol||!!["localhost","127.0.0.1","::1"].includes(t.hostname)}(e),this._attachSocket(new WebSocket(e,["xmpp"]))}_attachSocket(e){this.socket=e,this.#d??=Be({open:()=>this.emit("connect"),message:({data:e})=>this.emit("data",e),error:e=>{const{url:t}=this;let{error:s}=e;s||(s=new Error(e.message||`WebSocket ${dt} ${t}`),s.errno=dt,s.code=dt),s.event=e,s.url=t,this.emit("error",s)},close:e=>{this._detachSocket(),this.emit("close",!e.wasClean,e)}}),this.#d.subscribe(this.socket)}_detachSocket(){this.url=null,this.secure=!1,this.socket&&this.#d?.unsubscribe(this.socket),this.socket=null}end(){this.socket.close()}write(e,t){function s(e){t&&Promise.resolve().then(()=>t(e))}try{this.socket.send(e)}catch(e){return void s(e)}s()}},ht.prototype.NS="jabber:client",ht.prototype.Parser=class extends He{onStartElement(e,t){const s=new xe(e,t),{cursor:n}=this;n&&n.append(s),this.cursor=s}onEndElement(e){const{cursor:t}=this;e===t.name?t.parent?this.cursor=t.parent:(t.is("open","urn:ietf:params:xml:ns:xmpp-framing")?this.emit("start",t):t.is("close","urn:ietf:params:xml:ns:xmpp-framing")?this.emit("end",t):this.emit("element",t),this.cursor=null):this.emit("error",new Ge(`${t.name} must be closed.`))}};var gt=(mt||(mt=1,pt=function(e){if(!Array.isArray(e))throw new TypeError("Middleware stack must be an array!");for(const t of e)if("function"!=typeof t)throw new TypeError("Middleware must be composed of functions!");return function(t,s){let n=-1;return function r(i){if(i<=n)return Promise.reject(new Error("next() called multiple times"));n=i;let a=e[i];if(i===e.length&&(a=s),!a)return Promise.resolve();try{return Promise.resolve(a(t,r.bind(null,i+1)))}catch(e){return Promise.reject(e)}}(0)}}),pt),ft=ye(gt);class yt{constructor(e,t){this.stanza=t,this.entity=e;const{name:s,attrs:n}=t,{type:r,id:i}=n;this.name=s,this.id=i||"",this.type="message"===s?r||"normal":"presence"===s?r||"available":r||"",this.from=null,this.to=null,this.local="",this.domain="",this.resource=""}}class bt extends yt{constructor(e,t){super(e,t);const{jid:s}=e,{domain:n}=e.options??{},r=t.attrs.to||s?.toString(),i=t.attrs.from||n;r&&(this.to=new st(r)),i&&(this.from=new st(i),this.local=this.from.local,this.domain=this.from.domain,this.resource=this.from.resource)}}class vt extends yt{constructor(e,t){super(e,t);const{jid:s}=e,{domain:n}=e.options??{},r=t.attrs.from||s?.toString(),i=t.attrs.to||n;r&&(this.from=new st(r)),i&&(this.to=new st(i),this.local=this.to.local,this.domain=this.to.domain,this.resource=this.to.resource)}}function Ct(e,t,s){return n=>{const r=new s(e,n);return ft(t)(r)}}function St(e){return(t,s)=>{s().then(t=>t&&e.send(t)).catch(t=>e.emit("error",t))}}class wt extends nt{constructor(e,t,s,n){super(e,t,s),this.type=n,this.name="StanzaError"}static fromElement(e){const t=super.fromElement(e);return t.type=e.attrs.type,t}}class Et{constructor({entity:e,middleware:t}){this.handlers=new Map,this.entity=e,this.middleware=t}start(){this.middleware.use(this._route.bind(this))}_route({type:e,name:t,id:s,stanza:n},r){if(!function({name:e,type:t}){return"iq"===e&&("error"===t||"result"===t)}({name:t,type:e}))return r();const i=this.handlers.get(s);if(!i)return r();"error"===e?i.reject(wt.fromElement(n.getChild("error"))):i.resolve(n),this.handlers.delete(s)}async request(e,t=3e4){e.attrs.id||(e.attrs.id=function(){let e;for(;!e;)e=Math.random().toString(36).slice(2,12);return e}());const s=new ze;this.handlers.set(e.attrs.id,s);try{await this.entity.send(e),await Fe(s.promise,t)}catch(t){throw this.handlers.delete(e.attrs.id),t}return s.promise}_childRequest(e,t,s,...n){const{name:r,attrs:{xmlns:i}}=t;return this.request(Xe("iq",{type:e,to:s},t),...n).then(e=>e.getChild(r,i))}async get(...e){return this._childRequest("get",...e)}async set(...e){return this._childRequest("set",...e)}}function Tt({stanza:e}){return Xe("iq",{to:e.attrs.from,from:e.attrs.to,id:e.attrs.id})}function kt(e,t,s){const n=Tt(e);return n.attrs.type="error",s&&n.append(s),n.append(t),n}function It(e,t){return Xe("error",{type:e},Xe(t,"urn:ietf:params:xml:ns:xmpp-stanzas"))}function xt(e){return async function(t,s){if(!function({name:e,type:t}){return"iq"===e&&"error"!==t&&"result"!==t}(t))return s();const{stanza:n}=t,r=n.getChildElements(),[i]=r;if(!function({type:e},t,s){return("get"===e||"set"===e)&&1===t.length&&!!s}(t,r,i))return kt(t,It("modify","bad-request"),i);let a;t.element=i;try{a=await s()}catch(t){e.emit("error",t),a=It("cancel","internal-server-error")}return a||(a=It("cancel","service-unavailable")),a instanceof Xe.Element&&a.is("error")?kt(t,a,i):function(e,t){const s=Tt(e);return s.attrs.type="result",t&&s.append(t),s}(t,a instanceof Xe.Element?a:void 0)}}function At(e,t,s,n){return(r,i)=>r.type!==e|!r.element||!r.element.is(s,t)?i():n(r,i)}function Lt(e){return globalThis.btoa(e)}function Dt(e){return globalThis.atob(e)}class Rt extends nt{constructor(...e){super(...e),this.name="SASLError"}}const Ot="urn:ietf:params:xml:ns:xmpp-sasl";function Pt(e,t,s){const n=new Set(e.getChildren("mechanism",t).map(e=>e.text()));return s._mechs.map(({name:e})=>e).filter(e=>n.has(e))}function _t({streamFeatures:e,saslFactory:t},s){e.use("mechanisms",Ot,async({entity:e},n,r)=>{const i=Pt(r,Ot,t);if(0===i.length)throw new Rt("SASL: No compatible mechanism available.");await s(async function(s,n){await async function({saslFactory:e,entity:t,mechanism:s,credentials:n}){const r=e.create([s]);if(!r)throw new Error(`SASL: Mechanism ${s} not found.`);const{domain:i}=t.options,a={username:null,password:null,server:i,host:i,realm:i,serviceType:"xmpp",serviceName:i,...n};await We(t,r.clientFirst&&Xe("auth",{xmlns:Ot,mechanism:r.name},Lt(await r.response(a))),async(e,s)=>{if(e.getNS()===Ot){if("challenge"===e.name){await r.challenge(Dt(e.text()));const s=await r.response(a);return void await t.send(Xe("response",{xmlns:Ot,mechanism:r.name},"string"==typeof s?Lt(s):""))}if("failure"===e.name)throw Rt.fromElement(e);return"success"===e.name?s():void 0}})}({saslFactory:t,entity:e,mechanism:n,credentials:s})},i,null,e),await e.restart()})}const Mt="urn:xmpp:sasl:2";async function Nt({saslFactory:e,entity:t,mechanism:s,credentials:n,userAgent:r,streamFeatures:i,features:a}){const o=e.create([s]);if(!o)throw new Error(`SASL: Mechanism ${s} not found.`);const{domain:c}=t.options,l={username:null,password:null,server:c,host:c,realm:c,serviceType:"xmpp",serviceName:c,...n};await We(t,Xe("authenticate",{xmlns:Mt,mechanism:o.name},[o.clientFirst&&Xe("initial-response",{},Lt(await o.response(l))),r,...i]),async(e,s)=>{if(e.getNS()===Mt){if("challenge"===e.name){await o.challenge(Dt(e.text()));const s=await o.response(l);return void await t.send(Xe("response",{xmlns:Mt,mechanism:o.name},"string"==typeof s?Lt(s):""))}if("failure"===e.name)throw Rt.fromElement(e);if("continue"===e.name)throw new Error("SASL continue is not supported yet");if("success"===e.name){const n=e.getChild("additional-data")?.text();n&&o.final&&await o.final(Dt(n));const r=e.getChildText("authorization-identifier");r&&t._jid(r);for(const t of e.getChildElements()){const e=a.get(t.getNS());e?.[1]?.(t)}return s()}}})}function jt({streamFeatures:e,saslFactory:t},s){const n=new Map;let r;return e.use("authentication",Mt,async({entity:e},i,a)=>{const o=Pt(a,Mt,t),c=await async function({element:e,features:t}){const s=[],n=e.getChild("inline");if(!n)return s;for(const e of n.getChildElements()){const n=e.getNS(),r=t.get(n);r&&s.push(r[0](e))}return Promise.all(s)}({element:a,features:n}),l=!!r?.mechanism;if(0===o.length&&!l)throw new Rt("SASL: No compatible mechanism available.");await s(async function(s,i,a){if(await r.auth({authenticate:Nt,entity:e,userAgent:a,streamFeatures:c,features:n,credentials:s}))return;await Nt({entity:e,userAgent:a,streamFeatures:c,features:n,saslFactory:t,mechanism:i,credentials:s})},o,l?r:null,e)}),{use(e,t,s){n.set(e,[t,s])},setup({fast:e}){r=e}}}const Ut="urn:ietf:params:xml:ns:xmpp-bind";async function Jt(e,t,s){const n=await t.set(function(e){return Xe("bind",{xmlns:Ut},e&&Xe("resource",{},e))}(s)),r=n.getChildText("jid");return e._jid(r),e._ready(!1),r}function Ft({streamFeatures:e,iqCaller:t},s){e.use("bind",Ut,function({iqCaller:e},t){return async({entity:s},n)=>{t="function"==typeof t?await t():t,await Jt(s,e,t),n()}}({iqCaller:t},s))}const $t="urn:xmpp:bind:0";function qt({sasl2:e,entity:t},s){const n=new Map;return e.use($t,async e=>{if(!e.is("bind",$t))return;s="function"==typeof s?await s():s;const t=await function({element:e,features:t}){const s=[],n=e.getChild("inline");if(!n)return s;for(const e of n.getChildElements()){const n=e.attrs.var,r=t.get(n);r&&s.push(r[0](e))}return Promise.all(s)}({element:e,features:n});return Xe("bind",{xmlns:"urn:xmpp:bind:0"},s&&Xe("tag",null,s),...t)},e=>{if(e.is("bound")){t._ready(!1);for(const t of e.getChildElements()){const e=n.get(t.getNS());e?.[1]?.(t)}}}),{use(e,t,s){n.set(e,[t,s])}}}var Vt,zt={exports:{}},Wt={exports:{}};var Bt;var Gt=(Bt||(Bt=1,function(e){!function(e,t,s){(t.exports=s).Factory=s}(0,e,(Vt||(Vt=1,function(e){!function(e,t){function s(){this._mechs=[]}s.prototype.use=function(e,t){return t||(e=(t=e).prototype.name),this._mechs.push({name:e,mech:t}),this},s.prototype.create=function(e){for(var t=0,s=this._mechs.length;t<s;t++)for(var n=0,r=e.length;n<r;n++){var i=this._mechs[t];if(i.name==e[n])return new i.mech}return null},t.exports=s}(0,e)}(Wt)),Wt.exports))}(zt)),zt.exports),Ht=ye(Gt);const Xt="urn:xmpp:fast:0";function Kt({sasl2:e,entity:t}){const s=new Ht;let n;const r=new Ue;function i(){r.mechanism=null,r.mechanisms=[]}return Object.assign(r,{mechanism:null,mechanisms:[],async saveToken(e){n=e},fetchToken:async()=>n,async deleteToken(){n=null},async save(e){try{await this.saveToken(e)}catch(e){t.emit("error",e)}},async fetch(){try{return this.fetchToken()}catch(e){t.emit("error",e)}},async delete(){try{await this.deleteToken()}catch(e){t.emit("error",e)}},saslFactory:s,async auth({authenticate:e,entity:t,userAgent:s,credentials:n,streamFeatures:i,features:a}){if(!r.mechanism)return!1;const{token:o}=n;if(!function(e,t){if(!e)return!1;if(!t.includes(e.mechanism))return!1;if(new Date(e.expiry)<=new Date)return!1;return!0}(o,r.mechanisms))return c();try{return await e({saslFactory:r.saslFactory,mechanism:o.mechanism,credentials:{...n,password:o.token},streamFeatures:[...i,Xe("fast",{xmlns:Xt})],entity:t,userAgent:s,features:a}),!0}catch(e){return e instanceof Rt&&["not-authorized","credentials-expired"].includes(e.condition)?c():(t.emit("error",e),!1)}async function c(){return await r.delete(),function(e){e.push(Xe("request-token",{xmlns:Xt,mechanism:r.mechanism}))}(i),!1}}}),i(),e.use(Xt,async e=>{if(!e.is("fast",Xt))return i();r.available=!0;const t=Pt(e,Xt,s),n=t[0];if(!n)return i();r.mechanisms=t,r.mechanism=n},async e=>{e.is("token",Xt)&&await r.save({mechanism:r.mechanism,token:e.attrs.token,expiry:e.attrs.expiry})}),r}var Qt,Yt={exports:{}},Zt={exports:{}};var es;var ts=(es||(es=1,function(e){!function(e,t,s){(t.exports=s).Mechanism=s}(0,e,(Qt||(Qt=1,function(e){!function(e,t){function s(){}s.prototype.name="PLAIN",s.prototype.clientFirst=!0,s.prototype.response=function(e){var t="";return t+=e.authzid||"",t+="\0",t+=e.username,(t+="\0")+e.password},s.prototype.challenge=function(e){return this},t.exports=s}(0,e)}(Zt)),Zt.exports))}(Yt)),Yt.exports),ss=ye(ts);function ns(e){e.use(ss)}var rs,is={exports:{}},as={exports:{}};var os;var cs,ls=(os||(os=1,function(e){!function(e,t,s){(t.exports=s).Mechanism=s}(0,e,(rs||(rs=1,function(e){!function(e,t){function s(){}s.prototype.name="ANONYMOUS",s.prototype.clientFirst=!0,s.prototype.response=function(e){return e.trace||""},s.prototype.challenge=function(e){},t.exports=s}(0,e)}(as)),as.exports))}(is)),is.exports),ds=ye(ls);function us(e){e.use(ds)}function hs(){}function ps(e,t){return async function(...s){const[n,r,i,a]=s;if("function"==typeof e){const t=ms(r,a);await e(n,t)}else{e.token??=await(i?.fetch());const s=ms(r,a,e);await n(e,s,t)}}}function ms(e,t,s){const n=s?.username||t.options?.username,r=s?.password||t.options?.password,i=s?.token||t.options?.token;return n||r||i||!e.includes("ANONYMOUS")?t.isSecure()?e[0]:e.find(e=>"PLAIN"!==e):"ANONYMOUS"}hs.prototype.Mechanism=hs,hs.prototype.name="HT-SHA-256-NONE",hs.prototype.clientFirst=!0,hs.prototype.response=async function({username:e,password:t}){this.key=await crypto.subtle.importKey("raw",(new TextEncoder).encode(t),{name:"HMAC",hash:"SHA-256"},!1,["sign","verify"]);const s=await crypto.subtle.sign("HMAC",this.key,(new TextEncoder).encode("Initiator"));return`${e}\0${String.fromCodePoint(...new Uint8Array(s))}`},hs.prototype.final=async function(e){const t=Uint8Array.from(e,e=>e.codePointAt(0));if(!0!==await crypto.subtle.verify("HMAC",this.key,t,(new TextEncoder).encode("Responder")))throw new Error("Responder message from server was wrong")};class gs{static buildUserJid(e={}){const{userId:t,resource:s,jid:n}=e,r=he.creds.appId,i=he.endpoints.chat;return t?`${t}-${r}@${i}${s?`/${s}`:""}`:n}static buildUserJidLocalPart(e){return`${e}-${he.creds.appId}`}static createMessageStanza(e){return Xe("message",e)}static createIqStanza(e){return Xe("iq",e)}static createPresenceStanza(e){return Xe("presence",e)}static createNonza(e,t){return Xe(e,t)}static getAttr(e,t){return e?.getAttr(t)||e?.attrs[t]||null}static getElement(e,t){return e?.getChild(t)}static getName(e){return e?.getName()||null}static getText(e){return e?.getText()||null}static getChildElements(e){return e?.getChildElements()||[]}static isErrorStanza(e){return!!e?.getChild("error")}static getAllElements(e,t){return e?.getChildren(t)||[]}static getElementText(e,t){return e?.getChildText(t)||null}static getElementTreePath(e,t){return t.reduce((e,t)=>e?gs.getElement(e,t):void 0,e)}static assignObjectToXml(e,t,s){return e=e.c(s),Object.keys(t).forEach(s=>{"object"==typeof t[s]?gs.assignObjectToXml(e,t[s],s):e=e.c(s).t(t[s]).up()}),e=e.up()}static assignExtraParamsToXml(e,t){let s=gs.getElement(e,"extraParams");return Object.keys(t).forEach(e=>{"attachments"===e?t[e].forEach(e=>{s.c("attachment",e).up()}):"object"==typeof t[e]?gs.assignObjectToXml(s,t[e],e):s.c(e).t(t[e]).up()}),e.up(),e}static assignXmlToObject(e,t){const{children:s,name:n}=e,r={[n]:{}};return s.forEach(e=>{"string"==typeof e?r[n]=e:e.children.length>0?gs.assignXmlToObject(e,r[n]):r[n][e.name]=gs.getText(e)}),Object.assign(t,r)}static parseExtraParams(e){if(!e)return null;const t={attachments:[]};let s=null;return e.children.forEach(n=>{if("string"!=typeof n){if("attachment"===n.name){const e={};Object.keys(n.attrs).forEach(t=>{e[t]="size"===t?parseInt(n.attrs.size):n.attrs[t]}),t.attachments.push(e)}else"dialog_id"===n.name&&(s=gs.getElementText(e,"dialog_id"),t.dialog_id=s);n.children.length&&gs.assignXmlToObject(n,t)}}),0===t.attachments.length&&delete t.attachments,t.moduleIdentifier&&delete t.moduleIdentifier,{extension:t,dialogId:s}}static buildErrorFromXMPPErrorStanza(e){const t=gs.getElement(e,"error");return{code:t?parseInt(gs.getAttr(t,"code")):0,info:t?gs.getElementText(t,"text"):null}}static getUniqueId(e){const t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)});return"string"==typeof e||"number"==typeof e?`${t}:${e}`:t}static parseReactions(e){return gs.getChildElements(e).map(e=>({add:"true"===gs.getAttr(e,"add"),remove:"true"===gs.getAttr(e,"remove"),reaction:gs.getAttr(e,"type")})).reduce((e,{add:t,remove:s,reaction:n})=>(t?e.add=n:s&&(e.remove=n),e),{})}}function fs(e){let{resource:t,credentials:s,username:n,password:r,userAgent:i,...a}=e;const{domain:o,service:c}=a;!o&&c&&(a.domain=function(e){return(e.split("://")[1]||e).split(":")[0].split("/")[0]}(c));const l=new ct(a);n&&a.domain&&(l.jid=st(n,a.domain));const d=function({entity:e}){const t=new lt(e);return t.start(),t}({entity:l}),u=function({entity:e}){e.transports.push(ht)}({entity:l}),h=function({entity:e}){const t=[St(e)],s=[],n=Ct(e,t,bt),r=Ct(e,s,vt);return e.on("element",n),e.on("send",r),{use:e=>(t.push(e),e),filter:e=>(s.push(e),e)}}({entity:l}),p=function({middleware:e}){return{use:function(t,s,n){return e.use((e,r)=>{const{stanza:i}=e;if(!i.is("features","http://etherx.jabber.org/streams"))return r();const a=i.getChild(t,s);return a?n(e,r,a):r()})}}}({middleware:h}),m=function(...e){const t=new Et(...e);return t.start(),t}({middleware:h,entity:l}),g=function({middleware:e,entity:t}){return e.use(xt(t)),{get(t,s,n){e.use(At("get",t,s,n))},set(t,s,n){e.use(At("set",t,s,n))}}}({middleware:h,entity:l}),f=new Ht,y=Object.entries({plain:ns,anonymous:us}).map(([e,t])=>({[e]:t(f)}));i??=Xe("user-agent",{id:gs.getUniqueId()});const b=jt({streamFeatures:p,saslFactory:f},ps(s??{username:n,password:r},i)),v=Kt({sasl2:b,entity:l});b.setup({fast:v});const C=qt({sasl2:b,entity:l},t);!function(e){e.use(hs)}(v.saslFactory);const S=_t({streamFeatures:p,saslFactory:f},ps(s??{username:n,password:r},i)),w=Ft({iqCaller:m,streamFeatures:p},t);g?.get("urn:xmpp:ping","ping",()=>({}));return Object.assign(l,{entity:l,reconnect:d,websocket:u,middleware:h,streamFeatures:p,iqCaller:m,iqCallee:g,saslFactory:f,sasl2:b,sasl:S,resourceBinding:w,mechanisms:y,bind2:C,fast:v,sendOnline:function(e,...t){if("online"===l.status)return l.send.call(l,e,...t);{const e="You are not connected to chat. Please call 'connect' function first";return pe.DLog("[Chat][Error]",e),Promise.reject(new Error(e))}}})}class ys{xmppJID="";get userCurrentJid(){return this.xmppJID}set userCurrentJid(e){this.xmppJID=e||""}getUniqueId=gs.getUniqueId;isNumeric(e){return/^-?\d+$/.test(e)||/^\d+\.\d+$/.test(e)}jidOrUserId(e){return"string"==typeof e?this.isNumeric(e)?this.getUserJid(e):e.includes("@")?e:this.getRoomJidFromDialogId(e):this.getUserJid(e)}typeChat(e){switch(typeof e){case"string":return this.isNumeric(e)?"chat":e.includes("@")?e.includes("muc")?"groupchat":"chat":"groupchat";case"number":return"chat";default:throw new Error("Unsupported chat type")}}getUserJid(e){return`${e}-${he.creds.appId}@${he.endpoints.chat}`}getUserNickWithMucDomain(e){return`${he.endpoints.muc}/${e}`}getUserIdFromJID(e=this.userCurrentJid){return e?.includes("@")?parseInt(e.split("@")[0].split("-")[0]):null}getDialogIdFromJID(e){return e?.includes("@")?e.split("@")[0].split("_")[1]:null}getRoomJidFromDialogId(e){return`${he.creds.appId}_${e}@${he.endpoints.muc}`}getRoomJid(e){return`${e}/${this.getUserIdFromJID(this.userCurrentJid)}`}getIdFromResource(e){const t=e.split("/");return t.length>1?parseInt(t.slice(1).join("/")):null}getRoomJidFromRoomFullJid(e){const t=e.split("/");return t.length>1?t[0]:null}getBsonObjectId=pe.getBsonObjectId;getUserIdFromRoomJid(e){const t=e.split("/");return t.length>1?parseInt(t[t.length-1]):null}getDialogJid(e){return e.indexOf("@")>0?e:this.getRoomJidFromDialogId(e)}}!function(e){e.ENABLE="enable",e.ENABLED="enabled",e.REQUEST="r",e.ANSWER="a"}(cs||(cs={}));class bs{chat;xmlns="urn:xmpp:sm:3";enabled=!1;clientHandledCounter=0;serverHandledCounter=0;messagesQueue=new Set;messagesQueueClearTimer;constructor(e){this.chat=e}get supported(){return he.chatProtocol.active===g.WS&&he.chat.streamManagement?.enable}start(){this.enabled=!1,this.supported&&(this.removeElementHandler(),this.addElementHandler(),this.sendNonza(cs.ENABLE))}stop(){this.enabled=!1,this.supported&&(this.removeElementHandler(),this.markMessagesQueueAsLost())}async sendAndCount(e,t){const s=gs.getAttr(e,"type"),n=gs.getElementText(e,"body"),r=gs.getAllElements(e,"attachment"),i="message"===e.name,a=s===h.CHAT||s===h.GROUPCHAT,o=Boolean(n||r.length);try{await this.chat.xmppClient.sendOnline(e),this.enabled&&i&&a&&o&&(this.messagesQueue.add(t),this.sendNonza(cs.REQUEST))}catch{this.markMessageAsLost(t)}}elementHandler=e=>{const[t,s]=[e.name,gs.getAttr(e,"xmlns")];if(s===this.xmlns&&t===cs.ENABLED)return this.clientHandledCounter=0,this.serverHandledCounter=0,void(this.enabled=!0);if(s!==this.xmlns&&this.clientHandledCounter++,t!==cs.REQUEST){if(t===cs.ANSWER){const t=parseInt(gs.getAttr(e,"h"),10),s=Number.isNaN(t)?this.serverHandledCounter:t,n=s-this.serverHandledCounter;this.serverHandledCounter=s,this.markMessagesQueueAsSent(n),this.markMessagesQueueAsLostByTimeout()}}else this.sendNonza(cs.ANSWER)};markMessageAsSent(e){pe.safeCallbackCall(this.chat.onSentMessageCallback)(null,e),this.messagesQueue.delete(e)}markMessageAsLost(e,t=!0){pe.safeCallbackCall(this.chat.onSentMessageCallback)(e,null),t&&this.messagesQueue.delete(e)}markMessagesQueueAsSent(e=0){const t=this.messagesQueue.values();for(let s=0;s<e;s++){const{done:e,value:s}=t.next();if(e)break;this.markMessageAsSent(s)}}markMessagesQueueAsLost(){clearTimeout(this.messagesQueueClearTimer),this.messagesQueueClearTimer=void 0,this.messagesQueue.size>0&&(this.messagesQueue.forEach(e=>{this.markMessageAsLost(e,!1)}),this.messagesQueue.clear())}markMessagesQueueAsLostByTimeout(){const e=1e3*(he.chat.streamManagement?.acknowledgementTimeout??30);clearTimeout(this.messagesQueueClearTimer),this.messagesQueueClearTimer=setTimeout(()=>{this.markMessagesQueueAsLost()},e)}sendNonza(e){const t={xmlns:this.xmlns,...e===cs.ANSWER&&{h:this.clientHandledCounter}},s=gs.createNonza(e,t);return this.chat.xmppClient.sendOnline(s)}removeElementHandler(){this.chat.xmppClient.removeListener("element",this.elementHandler)}addElementHandler(){this.chat.xmppClient.on("element",this.elementHandler)}}class vs{xmlns="jabber:iq:privacy";helpers;xmppClient;stanzasCallbacks;constructor(e){this.helpers=e.helpers,this.xmppClient=e.xmppClient,this.stanzasCallbacks=e.stanzasCallbacks}async create(e){return new Promise((t,s)=>{const n=e.items.reduce((e,{user_id:t,action:s,mutualBlock:n})=>(e[t]={action:s,mutualBlock:n},e),{}),r=Object.keys(n),i={type:"set",from:this.helpers.userCurrentJid,id:gs.getUniqueId("edit")};let a=gs.createIqStanza(i);a.c("query",{xmlns:this.xmlns}).c("list",{name:e.name});for(let e=0,t=0,s=r.length;e<s;e++,t+=2){const s=r[e],{action:i,mutualBlock:o}=n[s],c=(o&&"deny"===i)??!1,l=this.helpers.jidOrUserId(parseInt(s,10)),d=this.helpers.getUserNickWithMucDomain(s);this.assignPrivacyItem(a,{order:t+1,value:l,action:i,isMutual:c}),this.assignPrivacyItem(a,{order:t+2,value:d,action:i,isMutual:c})}this.stanzasCallbacks[i.id]=e=>{gs.isErrorStanza(e)?s(gs.buildErrorFromXMPPErrorStanza(e)):t()},this.xmppClient.sendOnline(a)})}async getList(e){return new Promise((t,s)=>{const n=gs.getUniqueId("getlist"),r=gs.createIqStanza({type:"get",from:this.helpers.userCurrentJid,id:n});r.c("query",{xmlns:this.xmlns}).c("list",{name:e}),this.stanzasCallbacks[n]=e=>{const s=gs.getElement(e,"query"),r=gs.getElement(s,"list"),i={name:gs.getAttr(r,"name"),items:gs.getChildElements(r).map((e,t)=>{if(t%2==0){const{action:t,value:s}=e.attrs;return{user_id:this.helpers.getUserIdFromJID(s),action:t}}return null}).filter(e=>null!==e)};t(i),delete this.stanzasCallbacks[n]},this.xmppClient.sendOnline(r)})}async update(e){try{const t=await this.getList(e.name),s=new Map(t.items.map(e=>[e.user_id,e]));for(const t of e.items)if(t.action===m.ALLOW)s.delete(t.user_id);else{const e=Object.assign({},s.get(t.user_id),t);s.set(t.user_id,e)}const n=Array.from(s.values()),r={name:e.name,items:n};await this.create(r)}catch(e){throw e}}async getNames(){return new Promise((e,t)=>{const s=gs.getUniqueId("getNames"),n=gs.createIqStanza({type:"get",from:this.helpers.userCurrentJid,id:s});n.c("query",{xmlns:this.xmlns}),this.stanzasCallbacks[s]=s=>{if(gs.isErrorStanza(s))t(gs.buildErrorFromXMPPErrorStanza(s));else{const t=gs.getElement(s,"query"),n=gs.getElement(t,"default"),r=gs.getElement(t,"active"),i=gs.getAttr(n,"name"),a=gs.getAttr(r,"name"),o=gs.getChildElements(t).map(e=>gs.getAttr(e,"name"));e({default:i,active:a,names:o})}},this.xmppClient.sendOnline(n)})}async delete(e){return new Promise((t,s)=>{const n=gs.getUniqueId("remove"),r=gs.createIqStanza({type:"set",from:this.helpers.userCurrentJid,id:n});r.c("query",{xmlns:this.xmlns}).c("list",{name:e||""}),this.stanzasCallbacks[n]=e=>{gs.isErrorStanza(e)?s(gs.buildErrorFromXMPPErrorStanza(e)):t()},this.xmppClient.sendOnline(r)})}async setAsDefault(e){return new Promise((t,s)=>{const n=gs.getUniqueId("default"),r=gs.createIqStanza({type:"set",from:this.helpers.userCurrentJid,id:n});r.c("query",{xmlns:this.xmlns}).c("default",e?{name:e}:{}),this.stanzasCallbacks[n]=e=>{gs.isErrorStanza(e)?s(gs.buildErrorFromXMPPErrorStanza(e)):t()},this.xmppClient.sendOnline(r)})}assignPrivacyItem(e,t){const{value:s,action:n,order:r,isMutual:i}=t,a=gs.getElement(e,"query"),o=gs.getElement(a,"list").c("item",{type:"jid",value:s,action:n,order:r});i?(o.up(),r%2==0&&e.up().up()):o.c("message",{}).up().c("presence-in",{}).up().c("presence-out",{}).up().c("iq",{}).up().up()}}class Cs{xmlns="http://jabber.org/protocol/muc";helpers;xmppClient;stanzasCallbacks;joinedRooms={};constructor(e){this.helpers=e.helpers,this.xmppClient=e.xmppClient,this.stanzasCallbacks=e.stanzasCallbacks}async join(e){return new Promise((t,s)=>{const n=gs.getUniqueId("join"),r=this.helpers.getDialogJid(e),i=gs.createPresenceStanza({id:n,from:this.helpers.userCurrentJid,to:this.helpers.getRoomJid(r)});i.c("x",{xmlns:this.xmlns}).c("history",{maxstanzas:0}),this.stanzasCallbacks[n]=e=>{const i=gs.getElement(e,"x"),a=gs.getElement(i,"status"),o=gs.getAttr(a,"code");if(a&&"110"==o)this.joinedRooms[r]=!0,t();else{const t=gs.getAttr(i,"xmlns")===this.xmlns&&n.endsWith(":join"),r="error"===gs.getAttr(e,"type");if(t&&r){const t=gs.getElement(e,"error"),n={code:gs.getAttr(t,"code"),message:gs.getElementText(t,"text")||"Unknown issue"};s(n)}}},this.xmppClient.sendOnline(i)})}async leave(e){return new Promise((t,s)=>{const n=this.helpers.getDialogJid(e),r=gs.createPresenceStanza({type:"unavailable",from:this.helpers.userCurrentJid,to:this.helpers.getRoomJid(n)});delete this.joinedRooms[n],this.stanzasCallbacks["muc:leave"]=e=>{t()},this.xmppClient.sendOnline(r)})}async listOnlineUsers(e){return new Promise((t,s)=>{const n=gs.getUniqueId("muc_disco_items"),r=gs.createIqStanza({type:"get",to:this.helpers.getDialogJid(e),from:this.helpers.userCurrentJid,id:n});r.c("query",{xmlns:"http://jabber.org/protocol/disco#items"}),this.stanzasCallbacks[n]=e=>{const s=gs.getAttr(e,"id");if(this.stanzasCallbacks[s]){const s=gs.getAttr(e,"query"),n=gs.getChildElements(s).map(e=>{const t=gs.getAttr(e,"jid");return this.helpers.getUserIdFromRoomJid(t)}).filter(e=>null!==e);t(n)}},this.xmppClient.sendOnline(r)})}}class Ss{proxy;route=`${he.urls.chat}/Dialog`;constructor(e){this.proxy=e}async list(e={}){const t={type:D.GET,url:pe.getUrl(this.route),data:e};return this.proxy.ajax(t)}async create(e){const t=pe.cloneObject(e);pe.isArray(t?.occupants_ids)&&(t.occupants_ids=t.occupants_ids.join(", ")),pe.isArray(t?.admins_ids)&&(t.admins_ids=t.admins_ids.join(", "));const s={type:D.POST,url:pe.getUrl(this.route),data:t};return this.proxy.ajax(s)}async update(e,t={}){const s={type:D.PUT,url:pe.getUrl(this.route,e),data:t};return this.proxy.ajax(s)}async delete(e,t={}){const s="string"==typeof e?e.split(",").map(e=>e.trim()):e,n={type:D.DELETE,url:pe.getUrl(this.route,s.toString()),dataType:1===s.length?R.TEXT:R.JSON,data:t};return this.proxy.ajax(n)}async addAdmins(e,t){const s={type:D.PUT,url:pe.getUrl(this.route,e,"admins"),data:{push_all:{admins_ids:t}}};return this.proxy.ajax(s)}async removeAdmins(e,t){const s={type:D.PUT,url:pe.getUrl(this.route,e,"admins"),data:{pull_all:{admins_ids:t}}};return this.proxy.ajax(s)}async subscribe(e){const t={type:D.POST,url:pe.getUrl(this.route,e,"subscribe")};return this.proxy.ajax(t)}subscribeToPublic=this.subscribe;async unsubscribe(e){const t={type:D.DELETE,url:pe.getUrl(this.route,e,"subscribe"),dataType:R.TEXT};return this.proxy.ajax(t)}unsubscribeFromPublic=this.unsubscribe;async updateNotificationsSettings(e,t){const s={type:D.PUT,url:pe.getUrl(this.route,e,"notifications"),data:{enabled:t?1:0}};return this.proxy.ajax(s)}async getNotificationsSettings(e){const t={type:D.GET,url:pe.getUrl(this.route,e,"notifications")};return this.proxy.ajax(t)}async getPublicOccupants(e,t={}){const s={type:D.GET,url:pe.getUrl(this.route,e,"occupants"),data:t};return this.proxy.ajax(s)}async clearHistory(e){const t={type:D.DELETE,url:pe.getUrl(this.route,"clearHistory",e),dataType:R.TEXT};return this.proxy.ajax(t)}}class ws{proxy;route=`${he.urls.chat}/Message`;constructor(e){this.proxy=e}async list(e={}){const t={url:pe.getUrl(this.route),data:e};return this.proxy.ajax(t)}async create(e={}){const t={url:pe.getUrl(this.route),type:D.POST,data:e};return this.proxy.ajax(t)}async update(e,t={}){const s={type:D.PUT,dataType:R.TEXT,url:pe.getUrl(this.route,e),data:t};return this.proxy.ajax(s)}async delete(e,t){const s=pe.isArray(e)?e.join(","):e,n={url:pe.getUrl(this.route,s),type:D.DELETE,dataType:R.TEXT,data:t};return this.proxy.ajax(n)}async createSystem(e){const t={type:D.POST,url:pe.getUrl(this.route,"system"),data:e};return this.proxy.ajax(t)}async unreadCount(e={}){const t=pe.cloneObject(e);t&&t.chat_dialog_ids&&pe.isArray(t.chat_dialog_ids)&&(t.chat_dialog_ids=t.chat_dialog_ids.join(", "));const s={url:pe.getUrl(this.route,"unread"),data:t};return this.proxy.ajax(s)}async listReactions(e="_"){const t={type:D.GET,dataType:R.JSON,url:pe.getUrl(this.route,e,"reactions")};return this.proxy.ajax(t)}async addReaction(e,t){return this.updateReaction(e,t)}async removeReaction(e,t){return this.updateReaction(e,void 0,t)}async updateReaction(e,t,s){return this.putReaction(e,{add:t,remove:s})}async putReaction(e,t){const s={type:D.PUT,dataType:R.TEXT,url:pe.getUrl(this.route,e,"reactions"),data:t};return this.proxy.ajax(s)}}class Es{delegate;constructor(e){this.delegate=e}onMessage=(e,t)=>{const s=t?.sessionID??"",n=t?.signalType;switch(delete t?.moduleIdentifier,delete t?.sessionID,delete t?.signalType,n){case a.CALL:this.delegate.onCallHandler(e,s,t);break;case a.ACCEPT:this.delegate.onAcceptHandler(e,s,t);break;case a.REJECT:this.delegate.onRejectHandler(e,s,t);break;case a.STOP:this.delegate.onStopHandler(e,s,t);break;case a.CANDIDATE:this.delegate.onIceCandidatesHandler(e,s,t);break;case a.RESTART:this.delegate.onIceRestartHandler(e,s,t);break;case a.RESTART_ACCEPT:this.delegate.onIceRestartAcceptHandler(e,s,t)}}}class Ts{proxy;dialog;message;webrtcSignalingProcessor;isConnected=!1;isConnecting=!1;isLogout=!1;isReconnect=!1;onChatStatusListener;onConnectionErrorListener;onDisconnectedListener;onReconnectListener;onMessageListener;onSystemMessageListener;onMessageTypingListener;onMessageUpdateListener;onMessageDeleteListener;onMessageReactionsListener;onReadStatusListener;onLastUserActivityListener;constructor(e){this.proxy=e,this.dialog=new Ss(e),this.message=new ws(e)}async search(e){const t=Object.assign({},e);t.start_date&&(t.start_date=new Date(t.start_date).toISOString()),t.end_date&&(t.end_date=new Date(t.end_date).toISOString()),pe.isArray(t.chat_dialog_ids)&&(t.chat_dialog_ids=t.chat_dialog_ids.join(","));const s={type:D.GET,url:pe.getUrl(`${he.urls.chat}/search`),data:t};return this.proxy.ajax(s)}async pingWithTimeout(e=5e3){return new Promise(async(t,s)=>{const n=`Failed to ping chat server ${he.chatProtocol.websocket}. Timed out after ${e}ms`,r=setTimeout(()=>{pe.safeCallbackCall(this.onConnectionErrorListener)(n),s(n)},e);try{const e=await this.ping();clearTimeout(r),t(e)}catch{clearTimeout(r),s(n)}})}getListenerByName(e){switch(e){case p.STATUS:return"onChatStatusListener";case p.ERROR:return"onConnectionErrorListener";case p.DISCONNECTED:return"onDisconnectedListener";case p.RECONNECTED:return"onReconnectListener";case p.MESSAGE:return"onMessageListener";case p.SYSTEM_MESSAGE:return"onSystemMessageListener";case p.ERROR_MESSAGE:return"onMessageErrorListener";case p.TYPING_MESSAGE:return"onMessageTypingListener";case p.UPDATE_MESSAGE:return"onMessageUpdateListener";case p.DELETE_MESSAGE:return"onMessageDeleteListener";case p.REACTIONS_MESSAGE:return"onMessageReactionsListener";case p.DELIVERED_MESSAGE:return"onDeliveredStatusListener";case p.READ_MESSAGE:return"onReadStatusListener";case p.SENT_MESSAGE:return"onSentMessageCallback";case p.USER_LAST_ACTIVITY:return"onLastUserActivityListener";case p.JOIN:return"onJoinOccupant";case p.LEAVE:return"onLeaveOccupant";case p.KICK:return"onKickOccupant";default:return null}}addListener(e,t){const s=this.getListenerByName(e);return s&&(this[s]=t),this.removeListener.bind(this,e)}removeListener(e){const t=this.getListenerByName(e);t&&(this[t]=void 0)}removeAllListeners(){Object.keys(this).forEach(e=>{e.startsWith("on")&&e.endsWith("Listener")&&"function"==typeof this[e]&&(this[e]=void 0)})}}class ks extends Ts{onMessageErrorListener;onSentMessageCallback;onDeliveredStatusListener;onJoinOccupant;onLeaveOccupant;onKickOccupant;xmppClient;helpers;privacylist;muc;streamManagement;stanzasCallbacks={};xmppClientListeners=new Map;connectPromise=null;earlyIncomingMessagesQueue=[];constructor(e){super(e),this.helpers=new ys,this.xmppClient=fs({service:he.chatProtocol.websocket,credentials:(e,t)=>e({username:this.xmppClient?.options?.username,password:this.xmppClient?.options?.password},t)}),he.chat.reconnect.enable&&(this.xmppClient.reconnect.delay=1e3*he.chat.reconnect.timeInterval);const t={xmppClient:this.xmppClient,helpers:this.helpers,stanzasCallbacks:this.stanzasCallbacks};this.muc=new Cs(t),this.privacylist=new vs(t),this.streamManagement=new bs(this)}get connectionStatus(){return this.xmppClient.status}get currentUserId(){const e=this.xmppClient.jid?.toString()??"";return this.helpers.getUserIdFromJID(e)??0}async connect(e){return this.connectPromise=new Promise((t,s)=>(pe.DLog("[Chat]","Connect with parameter:",e),this.isConnecting?(pe.DLog("[Chat]","Warning! Already in CONNECTING state"),void t(!1)):this.isConnected?(pe.DLog("[Chat]","Warning! Chat is already connected!"),void t(!1)):(this.isConnecting=!0,this.isLogout=!1,this.removeAllXMPPClientListeners(),this.addXMPPClientListener("connect",()=>{pe.DLog("[Chat]",this.isReconnect?"RECONNECTING":"CONNECTING")}),this.addXMPPClientListener("online",()=>{pe.DLog("[Chat]","ONLINE"),this.postConnectActions(),t(!0),this.connectPromise=null}),this.addXMPPClientListener("offline",()=>{pe.DLog("[Chat]","OFFLINE")}),this.addXMPPClientListener("disconnect",()=>{pe.DLog("[Chat]","DISCONNECTED"),pe.safeCallbackCall(this.onDisconnectedListener)(),he.chat.reconnect.enable?(this.isConnected=!1,this.isConnecting=!1):this.disconnect()}),this.addXMPPClientListener("status",(e,t)=>{pe.DLog("[Chat]",`status - ${String(e)}`,"object"==typeof t?JSON.stringify(t):""),pe.safeCallbackCall(this.onChatStatusListener)(e)}),this.addXMPPClientListener("stanza",e=>{if(e.is("message")&&!this.isConnected)return this.earlyIncomingMessagesQueue.push(e),void pe.DLog("[Chat]","on 'stanza': enqueue incoming stanza (isConnected=false)");e.is("presence")?this.onPresence(e):e.is("iq")?this.onIQ(e):e.is("message")&&("headline"===e.attrs.type?this.onSystemMessage(e):"error"===e.attrs.type?this.onMessageError(e):this.onMessage(e))}),this.addXMPPClientListener("error",e=>{pe.DLog("[Chat]","ERROR:",e,{isReconnect:this.isReconnect,connectPromise:!!this.connectPromise}),this.connectPromise?this.isReconnect||(s("SASLError"==e.name?e.condition:e),this.connectPromise=null):pe.safeCallbackCall(this.onConnectionErrorListener)(e)}),this.addXMPPClientListener("output",e=>{pe.callTrafficUsageCallback("xmppDataWrite",{body:e}),pe.DLog("[Chat]","SENT:",e)}),this.addXMPPClientListener("input",e=>{pe.callTrafficUsageCallback("xmppDataRead",{body:e}),pe.DLog("[Chat]","RECV:",e)}),this.xmppClient.options.username=gs.buildUserJidLocalPart(e.userId),this.xmppClient.options.password=e.password,void this.xmppClient.start().catch(e=>{console.error("[Chat] xmppClient.start error",e),this.connectPromise?(s(e),this.connectPromise=null):pe.safeCallbackCall(this.onConnectionErrorListener)(e)})))),this.connectPromise}async ping(){return new Promise((e,t)=>{const s=gs.getUniqueId("ping"),n=gs.createIqStanza({id:s,type:"get",to:he.endpoints.chat});n.c("ping",{xmlns:"urn:xmpp:ping"}),this.stanzasCallbacks[s]=s=>{const n=gs.getElement(s,"error");n?t(gs.buildErrorFromXMPPErrorStanza(n)):e()},this.xmppClient.sendOnline(n)})}send(e,t={}){const s=t.id??pe.getBsonObjectId(),n=gs.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:t.type??this.helpers.typeChat(e),id:s});return t.id||(t.id=s),t.body&&n.c("body").t(t.body).up(),t.extension&&(n.c("extraParams",{xmlns:"jabber:client"}),gs.assignExtraParamsToXml(n,t.extension)),this.streamManagement.supported?this.streamManagement.sendAndCount(n,t):this.xmppClient.sendOnline(n),s}sendSystemMessage(e,t){const s=t.id??pe.getBsonObjectId(),n=gs.createMessageStanza({type:"headline",id:s,to:this.helpers.jidOrUserId(e)});return t.body&&n.c("body").t(t.body).up(),t.extension&&(n.c("extraParams",{xmlns:"jabber:client"}).c("moduleIdentifier").t("SystemNotifications").up(),gs.assignExtraParamsToXml(n,t.extension)),this.xmppClient.sendOnline(n),s}sendWebRTCSignalingMessage(e,t){const s=t.id??pe.getBsonObjectId();let n=gs.createMessageStanza({to:this.helpers.jidOrUserId(e),type:"headline",id:s}).c("extraParams",{xmlns:"jabber:client"});return Object.keys(t.extension).forEach(e=>{const s=t.extension[e];"iceCandidates"===e?(n=n.c("iceCandidates"),s.forEach(e=>{n=n.c("iceCandidate"),Object.keys(e).forEach(t=>{n=n.c(t).t(e[t]).up()}),n=n.up()}),n=n.up()):"opponentsIDs"===e?(n=n.c("opponentsIDs"),s.forEach(e=>{n=n.c("opponentID").t(e).up()}),n=n.up()):"object"==typeof s?gs.assignObjectToXml(n,s,e):n=n.c(e).t(s).up()}),n=n.up(),this.xmppClient.sendOnline(n),s}sendIsTypingStatus(e){const t=gs.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:this.helpers.typeChat(e)});t.c("composing",{xmlns:"http://jabber.org/protocol/chatstates"}),this.xmppClient.sendOnline(t)}sendIsStopTypingStatus(e){const t=gs.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),type:this.helpers.typeChat(e)});t.c("paused",{xmlns:"http://jabber.org/protocol/chatstates"}),this.xmppClient.sendOnline(t)}sendDeliveredStatus(e){const t=gs.createMessageStanza({type:"chat",from:this.helpers.userCurrentJid,id:pe.getBsonObjectId(),to:this.helpers.jidOrUserId(e.userId)});t.c("received",{xmlns:"urn:xmpp:chat-markers:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.sendOnline(t)}sendReadStatus(e){const t=gs.createMessageStanza({type:"chat",from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.userId),id:pe.getBsonObjectId()});t.c("displayed",{xmlns:"urn:xmpp:chat-markers:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.sendOnline(t)}editMessage(e){const t=gs.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.to),type:this.helpers.typeChat(e.to),id:pe.getBsonObjectId()});t.c("body").t(e.body).up(),t.c("replace",{xmlns:"urn:xmpp:message-correct:0",id:e.originMessageId,last:e.last?"true":"false"}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),e.extension&&gs.assignExtraParamsToXml(t,e.extension),this.xmppClient.sendOnline(t)}deleteMessage(e){const t=gs.createMessageStanza({from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e.to),type:this.helpers.typeChat(e.to),id:pe.getBsonObjectId()});t.c("remove",{xmlns:"urn:xmpp:message-delete:0",id:e.messageId}).up(),t.c("extraParams",{xmlns:"jabber:client"}).c("dialog_id").t(e.dialogId),this.xmppClient.sendOnline(t)}getLastUserActivity(e){return new Promise((t,s)=>{const n=gs.getUniqueId("lastActivity"),r=gs.createIqStanza({type:"get",from:this.helpers.userCurrentJid,to:this.helpers.jidOrUserId(e),id:n});r.c("query",{xmlns:"jabber:iq:last"}),this.stanzasCallbacks[n]=e=>{gs.getElement(e,"error")?s(gs.buildErrorFromXMPPErrorStanza(e)):t(this.onLastActivityStanza(e))},this.xmppClient.sendOnline(r)})}onLastActivityStanza(e){const t=gs.getAttr(e,"from"),s=this.helpers.getUserIdFromJID(t),n=gs.getElement(e,"query"),r=n?parseInt(gs.getAttr(n,"seconds")):0;return pe.safeCallbackCall(this.onLastUserActivityListener)(s,r),{userId:s,seconds:r}}markActive(){const e=gs.createIqStanza({id:this.helpers.getUniqueId("markActive"),type:"set"});e.c("mobile",{xmlns:"http://tigase.org/protocol/mobile#v2",enable:"false"}),this.xmppClient.sendOnline(e)}markInactive(){const e=gs.createIqStanza({id:this.helpers.getUniqueId("markActive"),type:"set"});e.c("mobile",{xmlns:"http://tigase.org/protocol/mobile#v2",enable:"true"}),this.xmppClient.sendOnline(e)}async disconnect(){if(pe.DLog("[Chat]","disconnect"),this.isLogout)return pe.DLog("[Chat]","Warning! Chat is already disconnected!"),!0;this.isLogout=!0,this.isReconnect=!1,this.isConnected=!1,this.isConnecting=!1,this.muc.joinedRooms={},this.helpers.userCurrentJid="",this.streamManagement.stop();try{return await this.xmppClient.stop(),!0}catch{return!1}}terminate(){pe.DLog("[Chat]","terminated"),this.isConnected=!1,this.isConnecting=!1,this.streamManagement.stop(),this.xmppClient.socket.end()}onMessage(e){const t=gs.getElementTreePath(e,["sent","forwarded","message"]),s=t||e,n=gs.getAttr(s,"from"),r=gs.getAttr(s,"type"),i=gs.getElement(s,"invite"),a=this.xmppClient.jid?.getResource()||"",o="chat"===r;if(o&&n.includes(a)||i)return;const c=gs.getAttr(s,"id"),l=gs.getElement(s,"received"),d=gs.getElement(s,"displayed"),u=gs.getElement(s,"replace"),h=gs.getElement(s,"reactions"),p=gs.getElement(s,"remove"),m=Boolean(gs.getElement(s,"composing")),g=gs.getElement(s,"paused"),f=gs.getElement(s,"delay"),y=gs.getElement(s,"extraParams"),b=gs.getElementText(s,"body"),v=Boolean(t),C="groupchat"===r,S=o?gs.getAttr(s,"to"):null,w=S?this.helpers.getUserIdFromJID(S):null,E=y?gs.parseExtraParams(y):null,T=E?E.extension:null,k=C?this.helpers.getDialogIdFromJID(n):E?.dialogId??null,I=C?this.helpers.getIdFromResource(n):this.helpers.getUserIdFromJID(n),x=this.xmppClient.jid?.toString(),A=x?this.helpers.getUserIdFromJID(x):0;if(m||g)return void((o||C||!f)&&pe.safeCallbackCall(this.onMessageTypingListener)(m,I,k));if(u)return void pe.safeCallbackCall(this.onMessageUpdateListener)(gs.getAttr(u,"id"),"true"===gs.getAttr(u,"last"),b,k,I,T);if(h){if(v&&C)return;const e=gs.getAttr(h,"message_id"),t=parseInt(gs.getAttr(h,"user_id")),{add:s,remove:n}=gs.parseReactions(h);return void pe.safeCallbackCall(this.onMessageReactionsListener)(e,t,k,s,n)}if(p){const e=gs.getAttr(p,"id");return void pe.safeCallbackCall(this.onMessageDeleteListener)(e,k,I)}if(l||d){if(l&&o){const e=gs.getAttr(l,"id");pe.safeCallbackCall(this.onDeliveredStatusListener)(e,k,I)}if(d&&o){const e=gs.getAttr(d,"id");pe.safeCallbackCall(this.onReadStatusListener)(e,k,I)}return}k&&I&&I!==A&&this.sendDeliveredStatus({messageId:c,dialogId:k,userId:I});const L={id:c,dialog_id:k,recipient_id:w,is_forwarded:v,type:r,body:b,extension:T,delay:f};(o||C)&&pe.safeCallbackCall(this.onMessageListener)(I,L)}onPresence(e){const t=gs.getAttr(e,"from"),s=gs.getAttr(e,"id"),n=gs.getAttr(e,"type"),r=this.xmppClient.jid?.toString(),i=this.helpers.getUserIdFromJID(r),a=gs.getElement(e,"x"),o=a?gs.getAttr(a,"xmlns"):null,c=a?gs.getElement(a,"xmlns"):null,l=c?gs.getElementText(c,"code"):null;if(o&&o.startsWith("http://jabber.org/protocol/muc")){if("error"===n)return void(s.endsWith(":join")&&pe.safeCallbackCall(this.stanzasCallbacks[s])(e));const r=this.helpers.getDialogIdFromJID(t),a=this.helpers.getUserIdFromRoomJid(t);if(c){if("301"===l){const s=gs.getElement(e,"item"),n=s?gs.getElement(s,"actor"):null,i=n?gs.getAttr(n,"jid"):null,a=this.helpers.getUserIdFromJID(i),o=this.helpers.getRoomJidFromRoomFullJid(t);return pe.safeCallbackCall(this.onKickOccupant)(r,a),void(o&&delete this.muc.joinedRooms[o])}if("unavailable"===n)return void(c&&"110"===l&&pe.safeCallbackCall(this.stanzasCallbacks["muc:leave"])(null));if(s.endsWith(":join")&&c&&"110"===l)return void this.stanzasCallbacks[s]?.(e)}else if(a!=i){const e="unavailable"===n?"onLeaveOccupant":"onJoinOccupant";return void pe.safeCallbackCall(this[e])(r,a)}}}onIQ(e){const t=gs.getAttr(e,"id");if(this.stanzasCallbacks[t])pe.safeCallbackCall(this.stanzasCallbacks[t])(e),delete this.stanzasCallbacks[t];else{const t=gs.getAttr(e,"from"),s=gs.getElement(e,"query");t&&s&&this.onLastActivityStanza(e)}}onSystemMessage(e){const t=gs.getElementTreePath(e,["sent","forwarded","message"])||e,s=gs.getAttr(t,"from"),n=gs.getAttr(t,"id"),r=gs.getElement(t,"extraParams"),a=this.helpers.getUserIdFromJID(s),o=gs.getElement(t,"delay"),c=r?gs.getElementText(r,"moduleIdentifier"):null,l=gs.getElementText(t,"body"),d=r?gs.parseExtraParams(r):null,u=d?d.extension:null;switch(c){case"SystemNotifications":pe.safeCallbackCall(this.onSystemMessageListener)({id:n,userId:a,body:l,extension:u});break;case i:o||this.onWebRTCSignalingMessage(a,r),this.webrtcSignalingProcessor&&!o&&pe.safeCallbackCall(this.webrtcSignalingProcessor.onMessage)(a,r)}}onWebRTCSignalingMessage(e,t){if(!this.webrtcSignalingProcessor)return;const s=this.getCallExtension(t);pe.safeCallbackCall(this.webrtcSignalingProcessor.onMessage)(e,s)}getCallExtension(e){if(!e)return{};const t={iceCandidates:[],opponentsIDs:[]};return gs.getChildElements(e).forEach(e=>{const s=gs.getChildElements(e),n=gs.getName(e)??"";switch(n){case"callerID":t[n]=parseInt(gs.getText(e)||"0");break;case"callType":const r=gs.getText(e);t[n]="1"===r?l.VIDEO:"2"===r?l.AUDIO:void 0;break;case"iceCandidates":s.forEach(e=>{const s={};gs.getChildElements(e).forEach(e=>{const t=gs.getName(e)||"",n=gs.getText(e);s[t]="sdpMLineIndex"===t?parseInt(n||"0"):n}),t.iceCandidates?.push(s)});break;case"opponentsIDs":s.forEach(e=>{t.opponentsIDs?.push(parseInt(gs.getText(e)||"0"))});break;default:s.length>1?(gs.getText(e)||"").length>4096?t[n]=s.reduce((e,t)=>e+gs.getText(t),""):gs.assignXmlToObject(e,t):"userInfo"===n?gs.assignXmlToObject(e,t):t[n]=gs.getText(e)}}),0===t.iceCandidates?.length&&delete t.iceCandidates,0===t.opponentsIDs?.length&&delete t.opponentsIDs,t}onMessageError(e){const t=gs.getAttr(e,"id"),s=gs.buildErrorFromXMPPErrorStanza(e);pe.safeCallbackCall(this.onMessageErrorListener)(t,s)}postConnectActions(){pe.DLog("[Chat]",this.isReconnect?"RECONNECTED":"CONNECTED");const e=gs.createPresenceStanza();if(this.streamManagement.start(),this.helpers.userCurrentJid=this.xmppClient.jid?.toString()??null,this.isConnected=!0,this.isConnecting=!1,this.enableCarbons(),this.xmppClient.sendOnline(e),this.isReconnect?pe.safeCallbackCall(this.onReconnectListener)():this.isReconnect=!0,this.earlyIncomingMessagesQueue.length>0){pe.DLog("[Chat]",`Flush 'earlyIncomingMessagesQueue' (length=${this.earlyIncomingMessagesQueue.length})`);const e=this.xmppClientListeners.get("stanza");this.earlyIncomingMessagesQueue.forEach(t=>{e?.(t)}),this.earlyIncomingMessagesQueue=[]}}enableCarbons(){const e=gs.createIqStanza({type:"set",from:this.helpers.userCurrentJid,id:gs.getUniqueId("enableCarbons")});e.c("enable",{xmlns:"urn:xmpp:carbons:2"}),this.xmppClient.sendOnline(e)}setSubscriptionToUserLastActivity(e,t){const s=gs.createIqStanza({id:this.helpers.getUniqueId("statusStreaming"),type:"set"});s.c("subscribe",{xmlns:"https://connectycube.com/protocol/status_streaming",user_jid:this.helpers.jidOrUserId(e),enable:t}),this.xmppClient.sendOnline(s)}subscribeToUserLastActivityStatus(e){this.setSubscriptionToUserLastActivity(e,!0)}unsubscribeFromUserLastActivityStatus(e){this.setSubscriptionToUserLastActivity(e,!1)}getListenerByName(e){switch(e){case p.ERROR_MESSAGE:return"onMessageErrorListener";case p.DELIVERED_MESSAGE:return"onDeliveredStatusListener";case p.SENT_MESSAGE:return"onSentMessageCallback";case p.JOIN:return"onJoinOccupant";case p.LEAVE:return"onLeaveOccupant";case p.KICK:return"onKickOccupant";default:return super.getListenerByName(e)}}addXMPPClientListener(e,t){switch(e){case"output":this.xmppClient.middleware.filter(async(e,s)=>{t(e.stanza?.toString()),await s()});break;case"input":const s=e=>{t(e.toString())};this.xmppClient.on("element",s),this.xmppClientListeners.set(e,s);break;default:this.xmppClient.on(e,t),this.xmppClientListeners.set(e,t)}}removeXMPPClientListener(e){const t=this.xmppClientListeners.get(e);t&&this.xmppClient.removeListener(e,t),this.xmppClientListeners.delete(e)}removeAllXMPPClientListeners(){this.xmppClientListeners.forEach((e,t)=>this.removeXMPPClientListener(t))}}var Is=Object.defineProperty,xs=(e,t,s)=>((e,t,s)=>t in e?Is(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);function As(e){const t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)});return void 0!==e?`${t}:${e}`:t}const Ls=globalThis.WebSocket??r.default;class Ds{constructor(e){xs(this,"socket"),xs(this,"config"),xs(this,"currentUserId"),xs(this,"responsesPromises",{}),xs(this,"deviceId"),xs(this,"onMessageListener"),xs(this,"onMessageStatusListener"),xs(this,"onMessageEditListener"),xs(this,"onMessageDeleteListener"),xs(this,"onMessageReactionsListener"),xs(this,"onUserActivityListener"),xs(this,"onUserTypingListener"),xs(this,"onConversationCreateListener"),xs(this,"onConversationUpdateListener"),xs(this,"onConversationDeleteListener"),xs(this,"onConnectEvent"),xs(this,"onMessageEvent"),xs(this,"onSystemMessageEvent"),xs(this,"onDisconnectEvent"),this.config=e}async connect(){return new Promise((e,t)=>{this.socket=new Ls(this.config.endpoint.ws),this.socket.onopen=()=>{var t;console.log("[socket.open]"),null==(t=this.onConnectEvent)||t.call(this),e()},this.socket.onmessage=e=>{var t,s,n,r,i,a,o,c,l,d,u,h,p,m;const g=JSON.parse(e.data);if(console.log("[socket.message]",g),g.typing)return void(null==(t=this.onUserTypingListener)||t.call(this,g.typing));if(g.system_message||null!=(s=g.message)&&s.system_message){const e=g.system_message??(null==(n=g.message)?void 0:n.system_message),{conversation_created:t,conversation_updated:s,conversation_kicked:c}=(null==e?void 0:e.x)??{};return t?void(null==(r=this.onConversationCreateListener)||r.call(this,t)):s?void(null==(i=this.onConversationUpdateListener)||i.call(this,s)):c?void(null==(a=this.onConversationDeleteListener)||a.call(this,c)):void(null==(o=this.onSystemMessageEvent)||o.call(this,e))}if(g.last_activity)return void(null==(c=this.onUserActivityListener)||c.call(this,g.last_activity));if(g.message_read)return void(null==(l=this.onMessageStatusListener)||l.call(this,g.message_read));if(g.message_edit)return void(null==(d=this.onMessageEditListener)||d.call(this,g.message_edit));if(g.message_delete)return void(null==(u=this.onMessageDeleteListener)||u.call(this,g.message_delete));if(g.message_reactions_update)return void(null==(h=this.onMessageReactionsListener)||h.call(this,g.message_reactions_update));if(g.message)return g.message.error?void this.responsesPromises[Object.keys(this.responsesPromises).slice(-1)[0]].reject(g.message.error):(null==(p=this.onMessageListener)||p.call(this,g.message),void(g.message.from.toString()!==this.currentUserId&&(null==(m=this.onMessageEvent)||m.call(this,g.message))));if(g.ask){const e=g.ask.mid;return this.responsesPromises[e].resolve(g.ask),void delete this.responsesPromises[e]}const f=g.response;if(f){const e=f.id;if(!e)return void console.error(f.error);const{resolve:t,reject:s,resObjKey:n}=this.responsesPromises[e];if(f.error)403===f.error.status?this.responsesPromises[e].reject(f.error):s(f.error);else if(Array.isArray(n)){const e=n.reduce((e,t)=>(void 0!==f[t]&&(e[t]=f[t]),e),{});n.every(t=>t in e)?t(e):s({message:"Server error."})}else n?f[n]?t(f[n]):s({message:"Server error."}):t(f);delete this.responsesPromises[e]}},this.socket.onerror=e=>{console.log("[socket.error]",e),t(e)},this.socket.onclose=()=>{var e;console.log("[socket.close]"),null==(e=this.onDisconnectEvent)||e.call(this),this.config.disableAutoReconnect||this.reconnect()}})}reconnect(){const e=()=>{navigator.onLine&&"visible"===document.visibilityState&&(this.connect(),window.removeEventListener("online",e),document.removeEventListener("visibilitychange",e))};navigator.onLine&&"visible"===document.visibilityState?this.connect():(window.addEventListener("online",e),document.addEventListener("visibilitychange",e))}async disconnect(){var e;return null==(e=this.socket)?void 0:e.close()}async sendRequest(e,t={},s="success"){const n={request:{[e]:t,id:As(e)}};return this.sendPromise(n,s)}async sendPromise(e,t){return new Promise((s,n)=>{this.socket?(this.socket.send(JSON.stringify(e)),console.log("[socket.send]",e),this.responsesPromises[e.request.id]={resolve:s,reject:n,resObjKey:t}):n("Socket is not connected.")})}async sendHttpPromise(e,t,s){console.log("[http.request]",{request:s});const n={"Content-Type":"application/json"},r=localStorage.getItem("sessionId");r&&(n.Authorization=`Bearer ${r}`);const i={method:e,credentials:"include",headers:n};s&&(i.body=JSON.stringify(s));const a=await fetch(`${this.config.endpoint.http}/${t}`,i),o=await a.text();if(!a.ok)throw console.error("[http.error]",o),o||a.statusText;const c=o?JSON.parse(o):{};return console.log("[http.response]",{response:c}),c}async connectSocket(e){return this.sendRequest("connect",{token:e.token,device_id:e.deviceId??this.deviceId})}async socketLogin(e){return this.sendRequest("user_login",{organization_id:this.config.organization_id,...e.user,device_id:e.deviceId??this.deviceId,token:e.token},"user")}async disconnectSocket(){return this.sendRequest("user_logout")}async userCreate(e){return this.sendRequest("user_create",{organization_id:this.config.organization_id,login:e.login,email:e.email,password:e.password},"user")}async userEdit(e){return this.sendRequest("user_edit",e,"user")}async userLogin(e){const{login:t,password:s}=e||{},n=Date.now();parseInt(localStorage.getItem("sessionExpiredAt")||`${n}`,10)-n<=0&&localStorage.removeItem("sessionId");const r={organization_id:this.config.organization_id,device_id:this.deviceId};return t&&s&&(r.login=t,r.password=s),await this.sendHttpPromise("POST","login",r)}async userLogout(){return await this.sendHttpPromise("POST","logout",null)}async userSendOTPToken(e){const t={organization_id:this.config.organization_id,device_id:this.deviceId,email:e.email};return this.sendRequest("user_send_otp",t)}async userResetPassword(e){const t={organization_id:this.config.organization_id,device_id:this.deviceId,email:e.email,token:e.token,new_password:e.new_password};return this.sendRequest("user_reset_password",t)}async userDelete(){return localStorage.removeItem("sessionId"),this.sendRequest("user_delete")}async userSearch(e){const t={keyword:e.keyword,ignore_ids:e.ignore_ids||[],...e.limit&&{limit:e.limit},...e.updated_at&&{updated_at:e.updated_at}};return this.sendRequest("user_search",t,"users")}async getUsersByIds(e){return this.sendRequest("get_users_by_ids",{ids:e.ids},"users")}async getParticipantsByCids(e){return this.sendRequest("get_participants_by_cids",{cids:e.cids},["users","conversations"])}async createUploadUrlForFiles(e){return this.sendRequest("create_files",e.files,"files")}async getDownloadUrlForFiles(e){return this.sendRequest("get_file_urls",{file_ids:e.file_ids},"file_urls")}async messageCreate(e){return new Promise((t,s)=>{var n;const r={message:{id:e.mid,body:e.body,cid:e.cid,x:e.x,attachments:e.attachments,replied_message_id:e.replied_message_id,forwarded_message_id:e.forwarded_message_id}};this.responsesPromises[r.message.id]={resolve:t,reject:s},null==(n=this.socket)||n.send(JSON.stringify(r)),console.log("[socket.send]",r)})}async messageSystem(e){return new Promise((t,s)=>{var n;const r={system_message:{id:e.mid,uids:e.uids,cid:e.cid,x:e.x}};this.responsesPromises[r.system_message.id]={resolve:t,reject:s},null==(n=this.socket)||n.send(JSON.stringify(r)),console.log("[socket.send]",r)})}async messageList(e){const t={cid:e.cid,...e.ids&&{ids:e.ids},...e.limit&&{limit:e.limit},...e.updated_at&&{updated_at:e.updated_at}};return this.sendRequest("message_list",t,"messages")}async messageSummary(e){return this.sendRequest("message_summary",{cid:e.cid,filter:e.filter},"message")}async messageTone(e){return this.sendRequest("message_tone",{body:e.body,tone:e.tone},"message")}async markConversationAsRead(e){return this.sendRequest("message_read",{cid:e.cid,ids:e.mids})}async messageEdit(e){return this.sendRequest("message_edit",{id:e.mid,body:e.body})}async messageDelete(e){return this.sendRequest("message_delete",{cid:e.cid,ids:e.mids,type:e.type??"myself"})}async getUserActivity(e){return this.sendRequest("user_last_activity",{ids:e},"last_activity")}async subscribeToUserActivity(e){return this.sendRequest("user_last_activity_subscribe",{id:e},"last_activity")}async unsubscribeFromUserActivity(){return this.sendRequest("user_last_activity_unsubscribe")}async sendTypingStatus(e){return new Promise((t,s)=>{var n;const r={typing:{cid:e.cid,status:e.status}};null==(n=this.socket)||n.send(JSON.stringify(r)),console.log("[socket.send]",r),t()})}async conversationCreate(e){return this.sendRequest("conversation_create",e,"conversation")}async conversationUpdate(e){var t,s;return this.sendRequest("conversation_update",{id:e.cid,name:e.name,description:e.description,participants:{add:null==(t=e.participants)?void 0:t.add,remove:null==(s=e.participants)?void 0:s.remove},image_object:e.image_object},"conversation")}async conversationList(e){const t={...e.limit&&{limit:e.limit},...e.updated_at&&{updated_at:{gt:e.updated_at.gt,lt:e.updated_at.lt}}};return this.sendRequest("conversation_list",t,"conversations")}async conversationDelete(e){return this.sendRequest("conversation_delete",{id:e.cid})}async conversationSearch(e){return this.sendRequest("conversation_search",{name:e.name},"conversations")}async conversationHandlerCreate(e){return this.sendRequest("conversation_handler_create",{cid:e.cid,content:e.content})}async getConversationHandler(e){return this.sendRequest("get_conversation_handler",{cid:e.cid},"conversation_handler")}async conversationHandlerDelete(e){return this.sendRequest("conversation_handler_delete",{cid:e.cid})}async pushSubscriptionCreate(e){return this.sendRequest("push_subscription_create",{platform:"web",web_endpoint:e.web_endpoint,web_key_auth:e.web_key_auth,web_key_p256dh:e.web_key_p256dh,device_udid:this.deviceId},"subscription")}async pushSubscriptionDelete(){return this.sendRequest("push_subscription_delete",{device_udid:this.deviceId})}async ping(){return this.sendRequest("ping",{},"pong")}async setActivityStatus(e){return this.sendRequest("activity_status",{isInactive:!!e},"success")}async blockList(){return this.sendRequest("list_blocked_users",{},"users")}async blockUsers(e){return this.sendRequest("block_user",{ids:e},"success")}async unblockUsers(e){return this.sendRequest("unblock_user",{ids:e},"success")}async reactionsUpdate(e,t,s){return this.sendRequest("message_reactions_update",{mid:e,add:t,remove:s},"success")}async reactionsList(e){return this.sendRequest("message_reactions_list",{mid:e},"reactions")}}class Rs{samaClient;constructor(e){this.samaClient=e}async block(e){Array.isArray(e)||(e=[e]),await this.samaClient.blockUsers(e)}async unblock(e){Array.isArray(e)||(e=[e]),await this.samaClient.unblockUsers(e)}async list(){return await this.samaClient.blockList()}}class Os extends Ts{samaClient;blockList;currentUserNativeId;constructor(e){super(e),this.samaClient=new Ds({endpoint:{ws:he.chatProtocol.websocket,http:`https://${he.endpoints.api}`},organization_id:`${he.creds.appId}`,disableAutoReconnect:!0}),this.blockList=new Rs(this.samaClient)}get connectionStatus(){return""}get currentUserId(){return this.currentUserNativeId}async connect(e){pe.DLog("[Chat]","Connect with parameter:",e),this.samaClient.deviceId=e.deviceId??pe.getBsonObjectId(),this.removeAllSamaListeners(),this.addAllSamaListeners(),this.isConnected||(await this.samaClient.connect(),this.isConnected=!0);const t=await this.samaClient.socketLogin({user:{userId:e.userId,password:e.password}});return this.currentUserNativeId=t.native_id,this.isLogout=!1,!0}async disconnect(){pe.DLog("[Chat]","disconnect"),this.isConnected=!1;try{return await this.samaClient.disconnectSocket(),await this.samaClient.disconnect(),this.currentUserNativeId=void 0,!0}catch{return!1}}terminate(){pe.DLog("[Chat]","terminated"),this.isConnected=!1,this.currentUserNativeId=void 0,this.samaClient.disconnect()}onSamaConnectedListener(){pe.DLog("[Chat]",this.samaClient.deviceId,"[connected]"),this.isConnected=!0,pe.safeCallbackCall(this.onChatStatusListener)("connect")}onSamaDisconnectListener(){pe.DLog("[Chat]",this.samaClient.deviceId,"[disconnect]"),this.isConnected=!1,this.isLogout=!0,pe.safeCallbackCall(this.onChatStatusListener)("disconnect"),pe.safeCallbackCall(this.onDisconnectedListener)()}onSamaMessageEventListener(e){pe.DLog("[Chat]","[packet]",this.samaClient.deviceId,e)}onSamaMessageListener(e){pe.DLog("[Chat]","[onMessage]",this.samaClient.deviceId,e);const{_id:t,cid:s,c_type:n,from:r,body:i,t:a,x:o,attachments:c,created_at:l}=e,d={id:t,dialog_id:s,body:i,extension:Object.assign({date_sent:a,attachments:c},o)};pe.safeCallbackCall(this.onMessageListener)(r,d)}onSamaSystemMessageListener(e){pe.DLog("[Chat]","[onSystem]",this.samaClient.deviceId,e);const{_id:t,from:s,t:n,x:r}=e,a={id:t,body:null,userId:s,extension:Object.assign({date_sent:n},r)};if(a.extension.moduleIdentifier===i)return this.onWebRTCSignalingSystemMessage(a);pe.safeCallbackCall(this.onSystemMessageListener)(a)}onWebRTCSignalingSystemMessage(e){const t=e.extension;return Object.keys(t).forEach(e=>{switch(e){case"callerID":t[e]=parseInt(t[e]||"0");break;case"callType":const s=t[e];t[e]="1"===s?l.VIDEO:"2"===s?l.AUDIO:void 0;break;case"opponentsIDs":t[e].map(e=>+e);break;case"iceCandidates":t[e].forEach(e=>{Object.keys(e).forEach(t=>{"sdpMLineIndex"===t&&(e[t]=parseInt(e[t]||"0"))})})}}),pe.safeCallbackCall(this.webrtcSignalingProcessor.onMessage)(e.userId,e.extension)}onSamaMessageStatusListener(e){pe.DLog("[Chat]","[onStatus]",this.samaClient.deviceId,e);const{ids:t,cid:s,from:n}=e;for(const e of t)pe.safeCallbackCall(this.onReadStatusListener)(e,s,n)}onSamaUserLastActivityListener(e){pe.DLog("[Chat]","[onLastActivity]",this.samaClient.deviceId,e),Object.entries(e).forEach(([e,t])=>{pe.safeCallbackCall(this.onLastUserActivityListener)(+e,+t)})}onSamaTypingListener(e){pe.DLog("[Chat]","[onTyping]",this.samaClient.deviceId,e);const{cid:t,from:s,status:n}=e,r="start"===n;pe.safeCallbackCall(this.onMessageTypingListener)(r,s,t)}onSamaMessageEditListener(e){pe.DLog("[Chat]","[onEdit]",this.samaClient.deviceId,e);const{id:t,cid:s,from:n,body:r}=e,i={messageId:t,isLast:!1,updatedBody:r,dialogId:s,userId:n,extraParams:{}};pe.safeCallbackCall(this.onMessageUpdateListener)(i.messageId,i.isLast,i.updatedBody,i.dialogId,i.userId,i.extraParams)}onSamaDeleteListener(e){pe.DLog("[Chat]","[onDelete]",this.samaClient.deviceId,e);const{ids:t,cid:s,from:n}=e;for(const e of t)pe.safeCallbackCall(this.onMessageDeleteListener)(e,s,n)}onSamaMessageReactionListener(e){pe.DLog("[Chat]","[onReaction]",this.samaClient.deviceId,e);const{mid:t,cid:s,from:n,add:r,remove:i}=e;pe.safeCallbackCall(this.onMessageReactionsListener)(t,n,s,r,i)}async ping(){await this.samaClient.ping()}async sendIsTypingStatus(e){const t={cid:e,status:"start"};await this.samaClient.sendTypingStatus(t)}async sendIsStopTypingStatus(e){const t={cid:e,status:"stop"};await this.samaClient.sendTypingStatus(t)}async send(e,t){const s=t.id??pe.getBsonObjectId(),n=t.extension??{},r=n?.attachments;delete n?.attachments;const i={mid:s,body:t.body,x:n,attachments:r,cid:e},a=await this.samaClient.messageCreate(i);return a?.server_mid??s}async sendSystemMessage(e,t){const s=t.id??pe.getBsonObjectId(),n=Array.isArray(e)?{uids:e}:"number"==typeof e?{uids:[e]}:{cid:e},r={mid:s,x:t.extension??{},...n};return this.samaClient.messageSystem(r),s}async sendWebRTCSignalingMessage(e,t){return await this.sendSystemMessage(e,t)}async sendDeliveredStatus(e){}async sendReadStatus(e){const t={cid:e.dialogId,mids:[e.messageId]};await this.samaClient.markConversationAsRead(t)}async markDialogAsRead(e){const t={cid:e.dialogId};await this.samaClient.markConversationAsRead(t)}async updateReaction(e,t,s){await this.samaClient.reactionsUpdate(e,t,s)}async editMessage(e){const t={mid:e.originMessageId,body:e.body};await this.samaClient.messageEdit(t)}async deleteMessage(e){const t={cid:e.dialogId,mids:[e.messageId],type:"all"};await this.samaClient.messageDelete(t)}async getLastUserActivity(e){const t=await this.samaClient.getUserActivity([e]);if(!(e in t))throw new Error("User not found");const s=t[e];return 0===s?{userId:e,seconds:s}:{userId:e,seconds:s?Math.ceil(+new Date/1e3)-s:s}}async subscribeToUserLastActivityStatus(e){return await this.samaClient.subscribeToUserActivity(e)}async unsubscribeFromUserLastActivityStatus(e){return await this.samaClient.unsubscribeFromUserActivity()}async markActive(){return await this.samaClient.setActivityStatus(!1)}async markInactive(){return await this.samaClient.setActivityStatus(!0)}addAllSamaListeners(){this.samaClient.onConnectEvent=this.onSamaConnectedListener.bind(this),this.samaClient.onDisconnectEvent=this.onSamaDisconnectListener.bind(this),this.samaClient.onMessageListener=this.onSamaMessageEventListener.bind(this),this.samaClient.onMessageEvent=this.onSamaMessageListener.bind(this),this.samaClient.onSystemMessageEvent=this.onSamaSystemMessageListener.bind(this),this.samaClient.onMessageStatusListener=this.onSamaMessageStatusListener.bind(this),this.samaClient.onMessageReactionsListener=this.onSamaMessageReactionListener.bind(this),this.samaClient.onMessageEditListener=this.onSamaMessageEditListener.bind(this),this.samaClient.onMessageDeleteListener=this.onSamaDeleteListener.bind(this),this.samaClient.onUserActivityListener=this.onSamaUserLastActivityListener.bind(this),this.samaClient.onUserTypingListener=this.onSamaTypingListener.bind(this)}removeAllSamaListeners(){this.samaClient.onConnectEvent=void 0,this.samaClient.onDisconnectEvent=void 0,this.samaClient.onMessageListener=void 0,this.samaClient.onMessageEvent=void 0,this.samaClient.onSystemMessageEvent=void 0,this.samaClient.onMessageStatusListener=void 0,this.samaClient.onMessageReactionsListener=void 0,this.samaClient.onMessageEditListener=void 0,this.samaClient.onMessageDeleteListener=void 0,this.samaClient.onUserActivityListener=void 0,this.samaClient.onUserTypingListener=void 0}}var Ps,_s,Ms=be(de);var Ns=function(){if(_s)return Ps;_s=1;const{adapter:e,navigator:t,MediaStream:s,MediaStreamTrack:n,RTCPeerConnection:r,RTCRtpReceiver:i,RTCRtpSender:a,isReactNative:o}=Ms;l.sessions={},l.mobile=o,l.isExtensionEnabled=function(){if(l.mobile)return!1;if(t.mediaDevices&&t.mediaDevices.getDisplayMedia)return!0;if(window.navigator.userAgent.match("Chrome")){let e=parseInt(window.navigator.userAgent.match(/Chrome\/(.*) /)[1],10),t=33;return window.navigator.userAgent.match("Linux")&&(t=35),e>=26&&e<=t||l.extension.isInstalled()}return!0};const c={extensionId:"hapfgfdkleiggjjpfpenajgdnfckjpaj",isInstalled:function(){return!l.mobile&&null!==document.querySelector("#janus-extension-installed")},getScreen:function(e){if(l.mobile)e();else{let t=window.setTimeout(function(){let t=new Error("NavigatorUserMediaError");return t.name='The required Chrome extension is not installed: click <a href="#">here</a> to install it. (NOTE: this will need you to refresh the page)',e(t)},1e3);this.cache[t]=e,window.postMessage({type:"janusGetScreen",id:t},"*")}},init:function(){let e={};this.cache=e,l.mobile||window.addEventListener("message",function(t){if(t.origin==window.location.origin)if("janusGotScreen"==t.data.type&&e[t.data.id]){let s=e[t.data.id];if(delete e[t.data.id],""===t.data.sourceId){let e=new Error("NavigatorUserMediaError");e.name="You cancelled the request for permission, giving up...",s(e)}else s(null,t.data.sourceId)}else"janusGetScreenPending"==t.data.type&&window.clearTimeout(t.data.id)})}};function l(e){if((e=e||{}).success="function"==typeof e.success?e.success:l.noop,e.error="function"==typeof e.error?e.error:l.noop,e.destroyed="function"==typeof e.destroyed?e.destroyed:l.noop,!l.initDone)return e.error("Library not initialized"),{};if(!l.isWebrtcSupported())return e.error("WebRTC not supported by this browser"),{};if(l.log("Library initialized: "+l.initDone),!e.server)return e.error("Invalid server url"),{};let o=!1,c=null,d={},u=null,h=null,p=0,m=e.server;l.isArray(m)?(l.log("Multiple servers provided ("+m.length+"), will use the first that works"),m=null,h=e.server,l.debug(h)):0===m.indexOf("ws")?(o=!0,l.log("Using WebSockets to contact Janus: "+m)):(o=!1,l.log("Using REST API to contact Janus: "+m));let g=e.iceServers||[{urls:"stun:stun.l.google.com:19302"}],f=e.iceTransportPolicy,y=e.bundlePolicy,b=!1;void 0!==e.withCredentials&&null!==e.withCredentials&&(b=!0===e.withCredentials);let v=10;void 0!==e.max_poll_events&&null!==e.max_poll_events&&(v=e.max_poll_events),v<1&&(v=1);let C=null;void 0!==e.token&&null!==e.token&&(C=e.token);let S=null;void 0!==e.apisecret&&null!==e.apisecret&&(S=e.apisecret),this.destroyOnUnload=!0,void 0!==e.destroyOnUnload&&null!==e.destroyOnUnload&&(this.destroyOnUnload=!0===e.destroyOnUnload);let w=25e3;void 0!==e.keepAlivePeriod&&null!==e.keepAlivePeriod&&(w=e.keepAlivePeriod),isNaN(w)&&(w=25e3);let E=6e4;function T(e){let t={high:9e5,medium:3e5,low:1e5};return null!=e&&(e.high&&(t.high=e.high),e.medium&&(t.medium=e.medium),e.low&&(t.low=e.low)),t}void 0!==e.longPollTimeout&&null!==e.longPollTimeout&&(E=e.longPollTimeout),isNaN(E)&&(E=6e4);let k=!1,I=null,x={},A=this,L=0,D={};function R(){if(null==I)return;if(l.debug("Long poll..."),!k)return void l.warn("Is the server down? (connected=false)");let t=m+"/"+I+"?rid="+(new Date).getTime();v&&(t=t+"&maxev="+v),C&&(t=t+"&token="+encodeURIComponent(C)),S&&(t=t+"&apisecret="+encodeURIComponent(S)),l.httpAPICall(t,{verb:"GET",withCredentials:b,success:O,timeout:E,error:function(t,s){if(l.error(t+":",s),L++,L>3)return k=!1,void e.error("Lost connection to the server (is it down?)");R()}})}function O(e,t){if(L=0,o||null==I||!0===t||R(),o||!l.isArray(e))if("keepalive"!==e.janus){if("server_info"===e.janus){l.debug("Got info on the Janus instance"),l.debug(e);const t=e.transaction;if(t){const s=D[t];s&&s(e),delete D[t]}return}if("ack"===e.janus){l.debug("Got an ack on session "+I),l.debug(e);const t=e.transaction;if(t){const s=D[t];s&&s(e),delete D[t]}return}if("success"===e.janus){l.debug("Got a success on session "+I),l.debug(e);const t=e.transaction;if(t){const s=D[t];s&&s(e),delete D[t]}return}if("trickle"===e.janus){const t=e.sender;if(!t)return void l.warn("Missing sender...");const s=x[t];if(!s)return void l.debug("This handle is not attached to this session");let n=e.candidate;l.debug("Got a trickled candidate on session "+I),l.debug(n);let r=s.webrtcStuff;r.pc&&r.remoteSdp?(l.debug("Adding remote candidate:",n),n&&!0!==n.completed?r.pc.addIceCandidate(n):r.pc.addIceCandidate(l.endOfCandidates)):(l.debug("We didn't do setRemoteDescription (trickle got here before the offer?), caching candidate"),r.candidates||(r.candidates=[]),r.candidates.push(n),l.debug(r.candidates))}else{if("webrtcup"===e.janus){l.debug("Got a webrtcup event on session "+I),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const s=x[t];return s?void s.webrtcState(!0):void l.debug("This handle is not attached to this session")}if("hangup"===e.janus){l.debug("Got a hangup event on session "+I),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const s=x[t];if(!s)return void l.debug("This handle is not attached to this session");s.webrtcState(!1,e.reason),s.hangup()}else if("detached"===e.janus){l.debug("Got a detached event on session "+I),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const s=x[t];if(!s)return;s.ondetached(),s.detach()}else if("media"===e.janus){l.debug("Got a media event on session "+I),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const s=x[t];if(!s)return void l.debug("This handle is not attached to this session");s.mediaState(e.type,e.receiving,e.mid)}else if("slowlink"===e.janus){l.debug("Got a slowlink event on session "+I),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");const s=x[t];if(!s)return void l.debug("This handle is not attached to this session");s.slowLink(e.uplink,e.lost,e.mid)}else{if("error"===e.janus){l.error("Ooops: "+e.error.code+" "+e.error.reason),l.debug(e);let t=e.transaction;if(t){let s=D[t];s&&s(e),delete D[t]}return}if("event"===e.janus){l.debug("Got a plugin event on session "+I),l.debug(e);const t=e.sender;if(!t)return void l.warn("Missing sender...");let s=e.plugindata;if(!s)return void l.warn("Missing plugindata...");l.debug("  -- Event is coming from "+t+" ("+s.plugin+")");let n=s.data;l.debug(n);const r=x[t];if(!r)return void l.warn("This handle is not attached to this session");let i=e.jsep;i&&(l.debug("Handling SDP as well..."),l.debug(i));let a=r.onmessage;a?(l.debug("Notifying application..."),a(n,i)):l.debug("No provided notification callback")}else{if("timeout"===e.janus)return l.error("Timeout on session "+I),l.debug(e),void(o&&c.close(3504,"Gateway timeout"));l.warn("Unknown message/event  '"+e.janus+"' on session "+I),l.debug(e)}}}}else l.vdebug("Got a keepalive on session "+I);else for(let t=0;t<e.length;t++)O(e[t],!0)}function P(){if(!m||!o||!k)return;u=setTimeout(P,w);let e={janus:"keepalive",session_id:I,transaction:l.randomString(12)};C&&(e.token=C),S&&(e.apisecret=S),c.send(JSON.stringify(e))}function _(t){let s=l.randomString(12),n={janus:"create",transaction:s};if(t.reconnect&&(k=!1,n.janus="claim",n.session_id=I,c&&(c.onopen=null,c.onerror=null,c.onclose=null,u&&(clearTimeout(u),u=null))),C&&(n.token=C),S&&(n.apisecret=S),!m&&l.isArray(h)&&(m=h[p],0===m.indexOf("ws")?(o=!0,l.log("Server #"+(p+1)+": trying WebSockets to contact Janus ("+m+")")):(o=!1,l.log("Server #"+(p+1)+": trying REST API to contact Janus ("+m+")"))),o){c=l.newWebSocket(m,"janus-protocol"),d={error:function(){if(l.error("Error connecting to the Janus WebSockets server... "+m),l.isArray(h)&&!t.reconnect)return p++,p===h.length?void t.error("Error connecting to any of the provided Janus servers: Is the server down?"):(m=null,void setTimeout(function(){_(t)},200));t.error("Error connecting to the Janus WebSockets server: Is the server down?")},open:function(){D[s]=function(e){if(l.debug(e),"success"!==e.janus)return l.error("Ooops: "+e.error.code+" "+e.error.reason),void t.error(e.error.reason);u=setTimeout(P,w),k=!0,I=e.session_id?e.session_id:e.data.id,t.reconnect?l.log("Claimed session: "+I):l.log("Created session: "+I),l.sessions[I]=A,t.success()},c.send(JSON.stringify(n))},message:function(e){O(JSON.parse(e.data))},close:function(){m&&k&&(k=!1,e.error("Lost connection to the server (is it down?)"))}};for(let e in d)c.addEventListener(e,d[e])}else l.httpAPICall(m,{verb:"POST",withCredentials:b,body:n,success:function(e){if(l.debug(e),"success"!==e.janus)return l.error("Ooops: "+e.error.code+" "+e.error.reason),void t.error(e.error.reason);k=!0,I=e.session_id?e.session_id:e.data.id,t.reconnect?l.log("Claimed session: "+I):l.log("Created session: "+I),l.sessions[I]=A,R(),t.success()},error:function(e,s){if(l.error(e+":",s),l.isArray(h)&&!t.reconnect)return p++,p===h.length?void t.error("Error connecting to any of the provided Janus servers: Is the server down?"):(m=null,void setTimeout(function(){_(t)},200));""===s?t.error(e+": Is the server down?"):s&&s.error?t.error(e+": "+s.error.message):t.error(e+": "+s)}})}function M(e,t){if((t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop,!k)return l.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");let s=x[e];if(!s||!s.webrtcStuff)return l.warn("Invalid handle"),void t.error("Invalid handle");let n=t.message,r=t.jsep,i=l.randomString(12),a={janus:"message",body:n,transaction:i};if(s.token&&(a.token=s.token),S&&(a.apisecret=S),r&&(a.jsep={type:r.type,sdp:r.sdp},r.e2ee&&(a.jsep.e2ee=!0),"hml"!==r.rid_order&&"lmh"!==r.rid_order||(a.jsep.rid_order=r.rid_order),r.force_relay&&(a.jsep.force_relay=!0)),l.debug("Sending message to plugin (handle="+e+"):"),l.debug(a),o)return a.session_id=I,a.handle_id=e,D[i]=function(e){if(l.debug("Message sent!"),l.debug(e),"success"===e.janus){let s=e.plugindata;if(!s)return l.warn("Request succeeded, but missing plugindata..."),void t.success();l.log("Synchronous transaction successful ("+s.plugin+")");let n=s.data;return l.debug(n),void t.success(n)}"ack"===e.janus?t.success():e.error?(l.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(l.error("Unknown error"),t.error("Unknown error"))},void c.send(JSON.stringify(a));l.httpAPICall(m+"/"+I+"/"+e,{verb:"POST",withCredentials:b,body:a,success:function(e){if(l.debug("Message sent!"),l.debug(e),"success"===e.janus){let s=e.plugindata;if(!s)return l.warn("Request succeeded, but missing plugindata..."),void t.success();l.log("Synchronous transaction successful ("+s.plugin+")");let n=s.data;return l.debug(n),void t.success(n)}"ack"===e.janus?t.success():e.error?(l.error("Ooops: "+e.error.code+" "+e.error.reason),t.error(e.error.code+" "+e.error.reason)):(l.error("Unknown error"),t.error("Unknown error"))},error:function(e,s){l.error(e+":",s),t.error(e+": "+s)}})}function N(e,t){if(!k)return void l.warn("Is the server down? (connected=false)");let s=x[e];if(!s||!s.webrtcStuff)return void l.warn("Invalid handle");let n={janus:"trickle",candidate:t,transaction:l.randomString(12)};if(s.token&&(n.token=s.token),S&&(n.apisecret=S),l.vdebug("Sending trickle candidate (handle="+e+"):"),l.vdebug(n),o)return n.session_id=I,n.handle_id=e,void c.send(JSON.stringify(n));l.httpAPICall(m+"/"+I+"/"+e,{verb:"POST",withCredentials:b,body:n,success:function(e){l.vdebug("Candidate sent!"),l.vdebug(e),"ack"===e.janus||l.error("Ooops: "+e.error.code+" "+e.error.reason)},error:function(e,t){l.error(e+":",t)}})}function j(e,t,s,n,r){let i=x[e];if(!i||!i.webrtcStuff)return void l.warn("Invalid handle");let a=i.webrtcStuff;if(!a.pc)return void l.warn("Invalid PeerConnection");let o=function(e){l.log("Received state change on data channel:",e);let t=e.target.label,s=e.target.protocol,n=a.dataChannel[t]?a.dataChannel[t].readyState:"null";if(l.log("State change on <"+t+"> data channel: "+n),"open"===n){if(a.dataChannel[t].pending&&a.dataChannel[t].pending.length>0){l.log("Sending pending messages on <"+t+">:",a.dataChannel[t].pending.length);for(let e of a.dataChannel[t].pending)l.log("Sending data on data channel <"+t+">"),l.debug(e),a.dataChannel[t].send(e);a.dataChannel[t].pending=[]}i.ondataopen(t,s)}};if(n)a.dataChannel[t]=n;else{let e=a.dataChannelOptions;s&&(e.protocol=s),a.dataChannel[t]=a.pc.createDataChannel(t,e)}a.dataChannel[t].onmessage=function(e){l.log("Received message on data channel:",e);let t=e.target.label;i.ondata(e.data,t)},a.dataChannel[t].onopen=o,a.dataChannel[t].onclose=o,a.dataChannel[t].onerror=function(e){l.error("Got error on data channel:",e)},a.dataChannel[t].pending=[],r&&a.dataChannel[t].pending.push(r)}function U(e,t){(t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop;let s=x[e];if(!s||!s.webrtcStuff)return l.warn("Invalid handle"),void t.error("Invalid handle");let n=s.webrtcStuff,r=t.text||t.data;if(!r)return l.warn("Invalid data"),void t.error("Invalid data");let i=t.label?t.label:l.dataChanDefaultLabel;return n.dataChannel[i]?"open"!==n.dataChannel[i].readyState?(n.dataChannel[i].pending.push(r),void t.success()):(l.log("Sending data on data channel <"+i+">"),l.debug(r),n.dataChannel[i].send(r),void t.success()):(j(e,i,t.protocol,!1,r,t.protocol),void t.success())}function J(e,t){(t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop;let s=x[e];if(!s||!s.webrtcStuff)return l.warn("Invalid handle"),void t.error("Invalid handle");let n=s.webrtcStuff;if(!n.dtmfSender){if(n.pc){let e=n.pc.getSenders().find(function(e){return e.track&&"audio"===e.track.kind});if(!e)return l.warn("Invalid DTMF configuration (no audio track)"),void t.error("Invalid DTMF configuration (no audio track)");n.dtmfSender=e.dtmf,n.dtmfSender&&(l.log("Created DTMF Sender"),n.dtmfSender.ontonechange=function(e){l.debug("Sent DTMF tone: "+e.tone)})}if(!n.dtmfSender)return l.warn("Invalid DTMF configuration"),void t.error("Invalid DTMF configuration")}let r=t.dtmf;if(!r)return l.warn("Invalid DTMF parameters"),void t.error("Invalid DTMF parameters");let i=r.tones;if(!i)return l.warn("Invalid DTMF string"),void t.error("Invalid DTMF string");let a="number"==typeof r.duration?r.duration:500,o="number"==typeof r.gap?r.gap:50;l.debug("Sending DTMF string "+i+" (duration "+a+"ms, gap "+o+"ms)"),n.dtmfSender.insertDTMF(i,a,o),t.success()}function F(e,t){(t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop;let s=!0===t.noRequest;l.log("Destroying handle "+e+" (only-locally="+s+")"),ee(e);let n=x[e];if(!n||n.detached)return delete x[e],void t.success();if(n.detached=!0,s)return delete x[e],void t.success();if(!k)return l.warn("Is the server down? (connected=false)"),void t.error("Is the server down? (connected=false)");let r={janus:"detach",transaction:l.randomString(12)};if(n.token&&(r.token=n.token),S&&(r.apisecret=S),o)return r.session_id=I,r.handle_id=e,c.send(JSON.stringify(r)),delete x[e],void t.success();l.httpAPICall(m+"/"+I+"/"+e,{verb:"POST",withCredentials:b,body:r,success:function(s){l.log("Destroyed handle:"),l.debug(s),"success"!==s.janus&&l.error("Ooops: "+s.error.code+" "+s.error.reason),delete x[e],t.success()},error:function(s,n){l.error(s+":",n),delete x[e],t.success()}})}function $(e,t){let s=x[e];if(!s||!s.webrtcStuff)throw l.warn("Invalid handle"),"Invalid handle";let n=s.webrtcStuff;if(n.pc)return;let i={iceServers:g,iceTransportPolicy:f,bundlePolicy:y,sdpSemantics:"unified-plan"},o=!1;if(t.tracks)for(let e of t.tracks)if(e.transforms&&(e.transforms.sender||e.transforms.receiver)){o=!0;break}a&&(a.prototype.createEncodedStreams||a.prototype.createEncodedAudioStreams&&a.prototype.createEncodedVideoStreams)&&o&&(n.insertableStreams=!0,i.forceEncodedAudioInsertableStreams=!0,i.forceEncodedVideoInsertableStreams=!0,i.encodedInsertableStreams=!0),l.log("Creating PeerConnection"),n.pc=new r(i),l.debug(n.pc),n.pc.getStats&&(n.volume={},n.bitrate.value="0 kbits/sec"),l.log("Preparing local SDP and gathering candidates (trickle="+n.trickle+")"),n.pc.oniceconnectionstatechange=function(){n.pc&&s.iceState(n.pc.iceConnectionState)},n.pc.onicecandidate=function(s){if(!s.candidate||s.candidate.candidate&&s.candidate.candidate.indexOf("endOfCandidates")>0)l.log("End of candidates."),n.iceDone=!0,!0===n.trickle?N(e,{completed:!0}):function(e,t){t=t||{},t.success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop;let s=x[e];if(!s||!s.webrtcStuff)return void l.warn("Invalid handle, not sending anything");let n=s.webrtcStuff;if(l.log("Sending offer/answer SDP..."),!n.mySdp)return void l.warn("Local SDP instance is invalid, not sending anything...");n.mySdp={type:n.pc.localDescription.type,sdp:n.pc.localDescription.sdp},!1===n.trickle&&(n.mySdp.trickle=!1);l.debug(t),n.sdpSent=!0,t.success(n.mySdp)}(e,t);else{let t={candidate:s.candidate.candidate,sdpMid:s.candidate.sdpMid,sdpMLineIndex:s.candidate.sdpMLineIndex};!0===n.trickle&&N(e,t)}},n.pc.ontrack=function(e){if(l.log("Handling Remote Track",e),!e.streams)return;if(!e.track)return;let t=e.transceiver?e.transceiver.mid||e.transceiver._mid:e.track.id;try{s.onremotetrack(e.track,t,!0,{reason:"created"})}catch(e){l.error("Error calling onremotetrack",e)}if(e.track.onended)return;let r=null;l.log("Adding onended callback to track:",e.track),e.track.onended=function(e){l.log("Remote track removed:",e),clearTimeout(r);let t=n.pc?n.pc.getTransceivers():null,i=t?t.find(t=>{const s=t.receiver||t._receiver;return(s.track||s._track)===e.target}):null,a=i?i.mid||i._mid:e.target.id;try{s.onremotetrack(e.target,a,!1,{reason:"ended"})}catch(e){l.error("Error calling onremotetrack on removal",e)}},e.track.onmute=function(e){if(l.log("Remote track muted:",e),!r){const t=e.target;r=setTimeout(function(){l.log("Removing remote track");let e=n.pc?n.pc.getTransceivers():null,i=e?e.find(e=>{const s=e.receiver||e._receiver;return(s.track||s._track)===t}):null,a=i?i.mid||i._mid:t.id;try{s.onremotetrack(t,a,!1,{reason:"mute"})}catch(e){l.error("Error calling onremotetrack on mute",e)}r=null},2520)}},e.track.onunmute=function(e){if(l.log("Remote track flowing again:",e),null!=r)clearTimeout(r),r=null;else try{let t=n.pc?n.pc.getTransceivers():null,r=t?t.find(t=>{const s=t.receiver||t._receiver;return(s.track||s._track)===e.target}):null,i=r?r.mid||r._mid:e.target.id;s.onremotetrack(e.target,i,!0,{reason:"unmute"})}catch(e){l.error("Error calling onremotetrack on unmute",e)}}}}async function q(e,t,s){(s=s||{}).success="function"==typeof s.success?s.success:l.noop,s.error="function"==typeof s.error?s.error:Z;let n=s.jsep;if(t&&n)return l.error("Provided a JSEP to a createOffer"),void s.error("Provided a JSEP to a createOffer");if(!(t||n&&n.type&&n.sdp))return l.error("A valid JSEP is required for createAnswer"),void s.error("A valid JSEP is required for createAnswer");if(s.media&&!s.tracks){if(s.tracks=l.mediaToTracks(s.media),!0===s.simulcast||!0===s.simulcast2||s.svc)for(let e of s.tracks)if("video"===e.type){!0===s.simulcast||!0===s.simulcast2?e.simulcast=!0:s.svc&&(e.svc=s.svc);break}l.warn("Deprecated media object passed, use tracks instead. Automatically translated to:",s.tracks)}if(s.tracks&&!Array.isArray(s.tracks))return l.error("Tracks must be an array"),void s.error("Tracks must be an array");let r=x[e];if(!r||!r.webrtcStuff)return l.warn("Invalid handle"),void s.error("Invalid handle");let i=r.webrtcStuff;var a;i.trickle=(a=s.trickle,l.debug("isTrickleEnabled:",a),!1!==a);try{if($(e,s),t&&await W(e,s),n){if(await i.pc.setRemoteDescription(n),l.log("Remote description accepted!"),i.remoteSdp=n.sdp,i.candidates&&i.candidates.length>0){for(let e=0;e<i.candidates.length;e++){let t=i.candidates[e];l.debug("Adding remote candidate:",t),t&&!0!==t.completed?i.pc.addIceCandidate(t):i.pc.addIceCandidate(l.endOfCandidates)}i.candidates=[]}await W(e,s);let t=await async function(e,t){t=t||{},t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:l.noop;let s=x[e];if(!s||!s.webrtcStuff)throw l.warn("Invalid handle"),"Invalid handle";let n=s.webrtcStuff;l.log("Creating answer (iceDone="+n.iceDone+")");let r=await n.pc.createAnswer();l.debug(r);let i={type:"answer",sdp:r.sdp};if(t.customizeSdp(i),r.sdp=i.sdp,l.log("Setting local description"),n.mySdp={type:"answer",sdp:r.sdp},await n.pc.setLocalDescription(r),!n.iceDone&&!n.trickle)return l.log("Waiting for all candidates..."),null;n.insertableStreams&&(r.e2ee=!0);return r}(e,s);s.success(t)}else{let t=await async function(e,t){t=t||{},t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:l.noop;let s=x[e];if(!s||!s.webrtcStuff)throw l.warn("Invalid handle"),"Invalid handle";let n=s.webrtcStuff;l.log("Creating offer (iceDone="+n.iceDone+")");let r={},i=!0===t.iceRestart;i&&(r.iceRestart=!0);l.debug(r);let a=await n.pc.createOffer(r);l.debug(a);let o={type:"offer",sdp:a.sdp};if(t.customizeSdp(o),a.sdp=o.sdp,l.log("Setting local description"),n.mySdp={type:"offer",sdp:a.sdp},await n.pc.setLocalDescription(a),n.mediaConstraints=r,!n.iceDone&&!n.trickle)return l.log("Waiting for all candidates..."),null;n.insertableStreams&&(a.e2ee=!0);return a}(e,s);s.success(t)}}catch(e){l.error(e),s.error(e)}}function V(e,t){(t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:Z,t.customizeSdp="function"==typeof t.customizeSdp?t.customizeSdp:l.noop;let s=t.jsep,n=x[e];if(!n||!n.webrtcStuff)return l.warn("Invalid handle"),void t.error("Invalid handle");let r=n.webrtcStuff;if(s){if(!r.pc)return l.warn("Wait, no PeerConnection?? if this is an answer, use createAnswer and not handleRemoteJsep"),void t.error("No PeerConnection: if this is an answer, use createAnswer and not handleRemoteJsep");t.customizeSdp(s),r.pc.setRemoteDescription(s).then(function(){if(l.log("Remote description accepted!"),r.remoteSdp=s.sdp,r.candidates&&r.candidates.length>0){for(let e=0;e<r.candidates.length;e++){let t=r.candidates[e];l.debug("Adding remote candidate:",t),t&&!0!==t.completed?r.pc.addIceCandidate(t):r.pc.addIceCandidate(l.endOfCandidates)}r.candidates=[]}t.success()},t.error)}else t.error("Invalid JSEP")}async function z(e,t){if((t=t||{}).success="function"==typeof t.success?t.success:l.noop,t.error="function"==typeof t.error?t.error:l.noop,t.tracks&&!Array.isArray(t.tracks))return l.error("Tracks must be an array"),void t.error("Tracks must be an array");for(let e of t.tracks)(e.add||!e.replace&&!e.remove)&&(e.replace=!0);try{await W(e,t),t.success()}catch(e){l.error(e),t.error(e)}}async function W(e,r){let o=x[e];if(!o||!o.webrtcStuff)throw l.warn("Invalid handle, not sending anything"),"Invalid handle";let c=o.webrtcStuff;if(!c.pc)throw l.warn("Invalid PeerConnection"),"Invalid PeerConnection";let d=r.tracks;if(!d||!Array.isArray(d)||0===d.length)return;let u=!1,h={};for(let e of d){if(delete e.gumGroup,!e.type||!["audio","video"].includes(e.type))continue;if(!e.capture||e.capture instanceof n)continue;let t=e.group?e.group:"default";h[t]||(h[t]={}),h[t][e.type]||(e.gumGroup=t,h[t][e.type]=e)}let p=Object.keys(h);for(let e of p){let t=h[e];t.audio&&t.video||(t.audio&&delete t.audio.gumGroup,t.video&&delete t.video.gumGroup,delete h[e])}let m=!!r.jsep;for(let r of d){if(!r.type){l.warn("Missing track type:",r);continue}if("data"===r.type){if(c.pc.ondatachannel){l.warn("Data channel exists already, not creating another one");continue}l.log("Creating default data channel"),j(e,l.dataChanDefaultLabel,null,!1),c.pc.ondatachannel=function(t){l.log("Data channel created by Janus:",t),j(e,t.channel.label,t.channel.protocol,t.channel)};continue}if(void 0===r.add&&null===r.add&&void 0===r.remove&&null===r.remove&&void 0===r.replace&&null===r.replace&&(r.add=!0),r.add&&r.remove||r.add&&r.remove&&r.replace){l.warn("Conflicting actions for track, ignoring:",r);continue}r.add&&r.replace?(l.warn("Both add and replace provided, falling back to replace:",r),delete r.add):r.remove&&r.replace&&(l.warn("Both remove and replace provided, falling back to remove:",r),delete r.replace);let d=r.type;"screen"===r.type&&(d="video");let p=null,g=null;if(p=r.mid?c.pc.getTransceivers().find(e=>e.mid===r.mid&&e.receiver.track.kind===d):c.pc.getTransceivers().find(e=>e.receiver.track.kind===d),r.replace||r.remove){if(!p){l.warn("Couldn't find a transceiver for track:",r);continue}if(!p.sender){l.warn("No sender in the transceiver for track:",r);continue}g=p.sender}if(m&&!p&&(p=c.pc.getTransceivers().find(e=>e.receiver.track.kind===d),!p)){l.warn("Couldn't find a transceiver for track:",r);continue}let f=null,y=null;if(r.remove)l.log("Removing track from PeerConnection",r),y=g.track?g.track.id:null,await g.replaceTrack(null);else if(r.capture){if(r.gumGroup&&h[r.gumGroup]&&h[r.gumGroup].stream){let e=h[r.gumGroup].stream;f="audio"===r.type?e.getAudioTracks()[0]:e.getVideoTracks()[0],delete h[r.gumGroup].stream,delete h[r.gumGroup],delete r.gumGroup}else if(r.capture instanceof n)f=r.capture;else{u||(u=!0,o.consentDialog(!0));let e=l.trackConstraints(r),s=null;if("audio"===r.type||"video"===r.type){if(r.gumGroup){let t="audio"===r.type?"video":"audio";if(h[r.gumGroup]&&h[r.gumGroup][t]){let s=h[r.gumGroup][t],n=l.trackConstraints(s);e[t]=n[t]}}s=await t.mediaDevices.getUserMedia(e),r.gumGroup&&e.audio&&e.video&&(h[r.gumGroup].stream=s,delete r.gumGroup)}else s=await t.mediaDevices.getDisplayMedia(e);f="audio"===r.type?s.getAudioTracks()[0]:s.getVideoTracks()[0]}if(r.replace){await g.replaceTrack(f);let e="sendrecv";!1!==r.recv&&"inactive"!==p.direction&&"sendonly"!==p.direction||(e="sendonly"),p.setDirection?p.setDirection(e):p.direction=e}else{if(c.myStream||(c.myStream=new s),"audio"===d||!r.simulcast&&!r.svc)g=c.pc.addTrack(f,c.myStream),p=c.pc.getTransceivers().find(e=>e.sender===g);else if(r.simulcast){if("firefox"!==l.webRTCAdapter.browserDetails.browser){l.log("Enabling rid-based simulcasting:",f);let e=T(r.simulcastMaxBitrates);p=c.pc.addTransceiver(f,{direction:"sendrecv",streams:[c.myStream],sendEncodings:r.sendEncodings||[{rid:"h",active:!0,maxBitrate:e.high},{rid:"m",active:!0,maxBitrate:e.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:e.low,scaleResolutionDownBy:4}]})}else if(l.log("Enabling Simulcasting for Firefox (RID)"),p=c.pc.addTransceiver(f,{direction:"sendrecv",streams:[c.myStream]}),g=p?p.sender:null,g){let e=g.getParameters();e||(e={});let t=T(r.simulcastMaxBitrates);e.encodings=r.sendEncodings||[{rid:"h",active:!0,maxBitrate:t.high},{rid:"m",active:!0,maxBitrate:t.medium,scaleResolutionDownBy:2},{rid:"l",active:!0,maxBitrate:t.low,scaleResolutionDownBy:4}],g.setParameters(e)}}else l.log("Enabling SVC ("+r.svc+"):",f),p=c.pc.addTransceiver(f,{direction:"sendrecv",streams:[c.myStream],sendEncodings:[{scalabilityMode:r.svc}]});if(g||(g=p?p.sender:null),r.codec)if("firefox"===l.webRTCAdapter.browserDetails.browser)l.warn("setCodecPreferences not supported in Firefox, ignoring codec for track:",r);else if("string"!=typeof r.codec)l.warn("Invalid codec value, ignoring for track:",r);else{let e=d+"/"+r.codec.toLowerCase(),t=i.getCapabilities(d).codecs.filter(function(t){return t.mimeType.toLowerCase()===e});if(t&&0!==t.length){if(p)try{p.setCodecPreferences(t)}catch(e){l.warn("Failed enforcing codec for this "+d+" track:",e)}}else l.warn("Codec not supported in this browser for this track, ignoring:",r)}if(r.bitrate)if(r.simulcast||r.svc)l.warn("Ignoring bitrate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(r.bitrate)||r.bitrate<0)l.warn("Ignoring invalid bitrate for track:",r);else if(g){let e=g.getParameters();e&&e.encodings&&0!==e.encodings.length?(e.encodings[0].maxBitrate=r.bitrate,await g.setParameters(e)):l.warn("No encodings in the sender parameters, ignoring bitrate for track:",r)}if("video"===d&&r.framerate)if(r.simulcast||r.svc)l.warn("Ignoring framerate for simulcast/SVC track, use sendEncodings for that");else if(isNaN(r.framerate)||r.framerate<0)l.warn("Ignoring invalid framerate for track:",r);else if(g){let e=g.getParameters();e&&e.encodings&&0!==e.encodings.length?(e.encodings[0].maxFramerate=r.framerate,await g.setParameters(e)):l.warn("No encodings in the sender parameters, ignoring framerate for track:",r)}if(r.transforms){if(g&&r.transforms.sender){let e=null;a.prototype.createEncodedStreams?e=g.createEncodedStreams():(a.prototype.createAudioEncodedStreams||a.prototype.createEncodedVideoStreams)&&("audio"===d?e=g.createEncodedAudioStreams():"video"===d&&(e=g.createEncodedVideoStreams())),e&&(l.log("Insertable Streams sender transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(r.transforms.sender).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(r.transforms.sender).pipeTo(e.writable))}if(p&&p.receiver&&r.transforms.receiver){let e=null;i.prototype.createEncodedStreams?e=p.receiver.createEncodedStreams():(i.prototype.createAudioEncodedStreams||i.prototype.createEncodedVideoStreams)&&("audio"===d?e=p.receiver.createEncodedAudioStreams():"video"===d&&(e=p.receiver.createEncodedVideoStreams())),e&&(l.log("Insertable Streams receiver transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(r.transforms.receiver).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(r.transforms.receiver).pipeTo(e.writable))}}}f&&!0===r.dontStop&&(f.dontStop=!0)}else if(r.recv&&!p&&(p=c.pc.addTransceiver(d),p)){if(r.codec)if("firefox"===l.webRTCAdapter.browserDetails.browser)l.warn("setCodecPreferences not supported in Firefox, ignoring codec for track:",r);else if("string"!=typeof r.codec)l.warn("Invalid codec value, ignoring for track:",r);else{let e=d+"/"+r.codec.toLowerCase(),t=i.getCapabilities(d).codecs.filter(function(t){return t.mimeType.toLowerCase()===e});if(t&&0!==t.length)try{p.setCodecPreferences(t)}catch(e){l.warn("Failed enforcing codec for this "+d+" track:",e)}else l.warn("Codec not supported in this browser for this track, ignoring:",r)}if(p.receiver&&r.transforms&&r.transforms.receiver){let e=null;i.prototype.createEncodedStreams?e=p.receiver.createEncodedStreams():(i.prototype.createAudioEncodedStreams||i.prototype.createEncodedVideoStreams)&&("audio"===d?e=p.receiver.createEncodedAudioStreams():"video"===d&&(e=p.receiver.createEncodedVideoStreams())),e&&(l.log("Insertable Streams receiver transform:",e),e.readableStream&&e.writableStream?e.readableStream.pipeThrough(r.transforms.receiver).pipeTo(e.writableStream):e.readable&&e.writable&&e.readable.pipeThrough(r.transforms.receiver).pipeTo(e.writable))}}if(y&&c.myStream){let e=null;if("audio"===d&&c.myStream.getAudioTracks()&&c.myStream.getAudioTracks().length)for(let t of c.myStream.getAudioTracks())t.id===y&&(e=t,l.log("Removing audio track:",e));else if("video"===d&&c.myStream.getVideoTracks()&&c.myStream.getVideoTracks().length)for(let t of c.myStream.getVideoTracks())t.id===y&&(e=t,l.log("Removing video track:",e));if(e){try{c.myStream.removeTrack(e),o.onlocaltrack(e,!1)}catch(e){l.error("Error calling onlocaltrack on removal for renegotiation",e)}if(!0!==e.dontStop)try{e.stop()}catch(e){}}}if(f){c.myStream.addTrack(f),f.onended=function(e){l.log("Local track removed:",e);try{o.onlocaltrack(e.target,!1)}catch(e){l.error("Error calling onlocaltrack following end",e)}};try{o.onlocaltrack(f,!0)}catch(e){l.error("Error calling onlocaltrack for track add",e)}}if(p){let e=p.direction,t=null,s=f&&p.sender.track,n=!1!==r.recv&&p.receiver.track;s&&n?t="sendrecv":s&&!n?t="sendonly":!s&&n?t="recvonly":s||n||(t="inactive"),t&&t!==e&&(l.warn("Changing direction of transceiver to "+t+" (was "+e+")",r),p.setDirection?p.setDirection(t):p.direction=t)}}u&&o.consentDialog(!1)}function B(e){let t=x[e];if(!t||!t.webrtcStuff)return l.warn("Invalid handle"),null;let s=t.webrtcStuff;if(!s.pc)return l.warn("Invalid PeerConnection"),null;let n=[],r=s.pc.getTransceivers();for(let e of r){let t=null;e.sender&&e.sender.track&&(t={mid:e.mid},t.type=e.sender.track.kind,t.id=e.sender.track.id,t.label=e.sender.track.label),t&&n.push(t)}return n}function G(e){let t=x[e];if(!t||!t.webrtcStuff)return l.warn("Invalid handle"),null;let s=t.webrtcStuff;if(!s.pc)return l.warn("Invalid PeerConnection"),null;let n=[],r=s.pc.getTransceivers();for(let e of r){let t=null;e.receiver&&e.receiver.track&&(t={mid:e.mid},t.type=e.receiver.track.kind,t.id=e.receiver.track.id,t.label=e.receiver.track.label),t&&n.push(t)}return n}function H(e,t,s,n){n="function"==typeof n?n:l.noop;let r=x[e];if(!r||!r.webrtcStuff)return l.warn("Invalid handle"),void n(0);let i=s?"remote":"local",a=r.webrtcStuff;if(a.volume[i]||(a.volume[i]={value:0}),a.pc&&a.pc.getStats&&("chrome"===l.webRTCAdapter.browserDetails.browser||"safari"===l.webRTCAdapter.browserDetails.browser)){let e=a.pc;if(t){let r=a.pc.getTransceivers().find(e=>e.mid===t&&"audio"===e.receiver.track.kind);if(!r)return l.warn("No audio transceiver with mid "+t),void n(0);if(s&&!r.receiver)return l.warn("Remote transceiver track unavailable"),void n(0);if(!s&&!r.sender)return l.warn("Local transceiver track unavailable"),void n(0);e=s?r.receiver:r.sender}return e.getStats().then(function(e){e.forEach(function(e){e&&"audio"===e.kind&&(s&&!e.remoteSource||!s&&"media-source"!==e.type||n(e.audioLevel?e.audioLevel:0))})}),a.volume[i].value}return l.warn("Getting the "+i+" volume unsupported by browser"),void n(0)}function X(e,t,s){let n=x[e];if(!n||!n.webrtcStuff)return l.warn("Invalid handle"),!0;let r=n.webrtcStuff;if(!r.pc)return l.warn("Invalid PeerConnection"),!0;if(!r.myStream)return l.warn("Invalid local MediaStream"),!0;if(s){if(!r.myStream.getVideoTracks()||0===r.myStream.getVideoTracks().length)return l.warn("No video track"),!0;if(t){let e=r.pc.getTransceivers().find(e=>e.mid===t&&"video"===e.receiver.track.kind);return e?e.sender&&e.sender.track?!e.sender.track.enabled:(l.warn("No video sender with mid "+t),!0):(l.warn("No video transceiver with mid "+t),!0)}return!r.myStream.getVideoTracks()[0].enabled}if(!r.myStream.getAudioTracks()||0===r.myStream.getAudioTracks().length)return l.warn("No audio track"),!0;if(t){let e=r.pc.getTransceivers().find(e=>e.mid===t&&"audio"===e.receiver.track.kind);return e?e.sender&&e.sender.track?!e.sender.track.enabled:(l.warn("No audio sender with mid "+t),!0):(l.warn("No audio transceiver with mid "+t),!0)}return!r.myStream.getAudioTracks()[0].enabled}function K(e,t,s,n){let r=x[e];if(!r||!r.webrtcStuff)return l.warn("Invalid handle"),!1;let i=r.webrtcStuff;if(!i.pc)return l.warn("Invalid PeerConnection"),!1;if(!i.myStream)return l.warn("Invalid local MediaStream"),!1;if(s){if(!i.myStream.getVideoTracks()||0===i.myStream.getVideoTracks().length)return l.warn("No video track"),!1;if(t){let e=i.pc.getTransceivers().find(e=>e.mid===t&&"video"===e.receiver.track.kind);if(!e)return l.warn("No video transceiver with mid "+t),!1;if(!e.sender||!e.sender.track)return l.warn("No video sender with mid "+t),!1;e.sender.track.enabled=!n}else for(const e of i.myStream.getVideoTracks())e.enabled=!n}else{if(!i.myStream.getAudioTracks()||0===i.myStream.getAudioTracks().length)return l.warn("No audio track"),!1;if(t){let e=i.pc.getTransceivers().find(e=>e.mid===t&&"audio"===e.receiver.track.kind);if(!e)return l.warn("No audio transceiver with mid "+t),!1;if(!e.sender||!e.sender.track)return l.warn("No audio sender with mid "+t),!1;e.sender.track.enabled=!n}else for(const e of i.myStream.getAudioTracks())e.enabled=!n}return!0}function Q(e,t){let s=x[e];if(!s||!s.webrtcStuff)return l.warn("Invalid handle"),"Invalid handle";let n=s.webrtcStuff;if(!n.pc)return"Invalid PeerConnection";if(n.pc.getStats){let e=n.pc,s=t||"default";if(t){let s=n.pc.getTransceivers().find(e=>e.mid===t&&"video"===e.receiver.track.kind);if(!s)return l.warn("No video transceiver with mid "+t),"No video transceiver with mid "+t;if(!s.receiver)return l.warn("No video receiver with mid "+t),"No video receiver with mid "+t;e=s.receiver}return n.bitrate[s]||(n.bitrate[s]={timer:null,bsnow:null,bsbefore:null,tsnow:null,tsbefore:null,value:"0 kbits/sec"}),n.bitrate[s].timer?n.bitrate[s].value:(l.log("Starting bitrate timer"+(t?" for mid "+t:"")+" (via getStats)"),n.bitrate[s].timer=setInterval(function(){e.getStats().then(function(e){e.forEach(function(e){if(!e)return;let t=!1;if(("video"===e.mediaType||e.id.toLowerCase().indexOf("video")>-1)&&"inbound-rtp"===e.type&&e.id.indexOf("rtcp")<0?t=!0:"ssrc"!=e.type||!e.bytesReceived||"VP8"!==e.googCodecName&&""!==e.googCodecName||(t=!0),t)if(n.bitrate[s].bsnow=e.bytesReceived,n.bitrate[s].tsnow=e.timestamp,null===n.bitrate[s].bsbefore||null===n.bitrate[s].tsbefore)n.bitrate[s].bsbefore=n.bitrate[s].bsnow,n.bitrate[s].tsbefore=n.bitrate[s].tsnow;else{let e=n.bitrate[s].tsnow-n.bitrate[s].tsbefore;"safari"===l.webRTCAdapter.browserDetails.browser&&(e/=1e3);let t=Math.round(8*(n.bitrate[s].bsnow-n.bitrate[s].bsbefore)/e);"safari"===l.webRTCAdapter.browserDetails.browser&&(t=parseInt(t/1e3)),n.bitrate[s].value=t+" kbits/sec",n.bitrate[s].bsbefore=n.bitrate[s].bsnow,n.bitrate[s].tsbefore=n.bitrate[s].tsnow}})})},1e3),"0 kbits/sec")}return l.warn("Getting the video bitrate unsupported by browser"),"Feature unsupported by browser"}function Y(e,t,s){let n=x[e];if(!n||!n.webrtcStuff)return void l.warn("Invalid handle");let r=n.webrtcStuff;if(!r.pc)return void l.warn("Invalid PeerConnection");let i=r.pc.getTransceivers().find(e=>e.mid===t);if(!i)return void l.warn("No transceiver with mid",t);if(!i.sender)return void l.warn("No sender for transceiver with mid",t);let a=i.sender.getParameters();a&&a.encodings&&0!==a.encodings.length?a.encodings.length>1?l.warn("Ignoring bitrate for simulcast track, use sendEncodings for that"):isNaN(s)||s<0?l.warn("Invalid bitrate (must be a positive integer)"):(a.encodings[0].maxBitrate=s,i.sender.setParameters(a)):l.warn("No parameters encodings")}function Z(e){l.error("WebRTC error:",e)}function ee(e,t){l.log("Cleaning WebRTC stuff");let s=x[e];if(!s)return;let n=s.webrtcStuff;if(n){if(!0===t){let t={janus:"hangup",transaction:l.randomString(12)};s.token&&(t.token=s.token),S&&(t.apisecret=S),l.debug("Sending hangup request (handle="+e+"):"),l.debug(t),o?(t.session_id=I,t.handle_id=e,c.send(JSON.stringify(t))):l.httpAPICall(m+"/"+I+"/"+e,{verb:"POST",withCredentials:b,body:t})}n.volume&&(n.volume.local&&n.volume.local.timer&&clearInterval(n.volume.local.timer),n.volume.remote&&n.volume.remote.timer&&clearInterval(n.volume.remote.timer));for(let e in n.bitrate)n.bitrate[e].timer&&clearInterval(n.bitrate[e].timer);n.bitrate={},!n.streamExternal&&n.myStream&&(l.log("Stopping local stream tracks"),l.stopAllTracks(n.myStream)),n.streamExternal=!1,n.myStream=null;try{n.pc.close()}catch(e){}n.pc=null,n.candidates=null,n.mySdp=null,n.remoteSdp=null,n.iceDone=!1,n.dataChannel={},n.dtmfSender=null,n.insertableStreams=!1}s.oncleanup()}_(e),this.getServer=function(){return m},this.isConnected=function(){return k},this.reconnect=function(e){(e=e||{}).success="function"==typeof e.success?e.success:l.noop,e.error="function"==typeof e.error?e.error:l.noop,e.reconnect=!0,_(e)},this.getSessionId=function(){return I},this.getInfo=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:l.noop,e.error="function"==typeof e.error?e.error:l.noop,l.log("Getting info on Janus instance"),!k)return l.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");let t=l.randomString(12),s={janus:"info",transaction:t};C&&(s.token=C);S&&(s.apisecret=S);if(o)return D[t]=function(t){l.log("Server info:"),l.debug(t),"server_info"!==t.janus&&l.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},void c.send(JSON.stringify(s));l.httpAPICall(m,{verb:"POST",withCredentials:b,body:s,success:function(t){l.log("Server info:"),l.debug(t),"server_info"!==t.janus&&l.error("Ooops: "+t.error.code+" "+t.error.reason),e.success(t)},error:function(t,s){l.error(t+":",s),""===s?e.error(t+": Is the server down?"):e.error(t+": "+s)}})}(e)},this.destroy=function(s){!function(s){s=s||{},s.success="function"==typeof s.success?s.success:l.noop,s.error="function"==typeof s.error?s.error:l.noop;let n=!0===s.unload,r=!0;void 0!==s.notifyDestroyed&&null!==s.notifyDestroyed&&(r=!0===s.notifyDestroyed);let i=!0===s.cleanupHandles;if(l.log("Destroying session "+I+" (unload="+n+")"),!I)return l.warn("No session to destroy"),s.success(),void(r&&e.destroyed());if(i)for(let e in x)F(e,{noRequest:!0});if(!k)return l.warn("Is the server down? (connected=false)"),I=null,void s.success();let a={janus:"destroy",transaction:l.randomString(12)};C&&(a.token=C);S&&(a.apisecret=S);if(n)return o?(c.onclose=null,c.close(),c=null):t.sendBeacon(m+"/"+I,JSON.stringify(a)),l.log("Destroyed session:"),I=null,k=!1,s.success(),void(r&&e.destroyed());if(o){a.session_id=I;let t=function(){for(let e in d)c.removeEventListener(e,d[e]);c.removeEventListener("message",n),c.removeEventListener("error",i),u&&clearTimeout(u),c.close()},n=function(n){let i=JSON.parse(n.data);i.session_id==a.session_id&&i.transaction==a.transaction&&(t(),s.success(),r&&e.destroyed())},i=function(){t(),s.error("Failed to destroy the server: Is the server down?"),r&&e.destroyed()};return c.addEventListener("message",n),c.addEventListener("error",i),void(1===c.readyState?c.send(JSON.stringify(a)):i())}l.httpAPICall(m+"/"+I,{verb:"POST",withCredentials:b,body:a,success:function(t){l.log("Destroyed session:"),l.debug(t),I=null,k=!1,"success"!==t.janus&&l.error("Ooops: "+t.error.code+" "+t.error.reason),s.success(),r&&e.destroyed()},error:function(t,n){l.error(t+":",n),I=null,k=!1,s.success(),r&&e.destroyed()}})}(s)},this.attach=function(e){!function(e){if(e=e||{},e.success="function"==typeof e.success?e.success:l.noop,e.error="function"==typeof e.error?e.error:l.noop,e.dataChannelOptions=e.dataChannelOptions||{ordered:!0},e.consentDialog="function"==typeof e.consentDialog?e.consentDialog:l.noop,e.iceState="function"==typeof e.iceState?e.iceState:l.noop,e.mediaState="function"==typeof e.mediaState?e.mediaState:l.noop,e.webrtcState="function"==typeof e.webrtcState?e.webrtcState:l.noop,e.slowLink="function"==typeof e.slowLink?e.slowLink:l.noop,e.onmessage="function"==typeof e.onmessage?e.onmessage:l.noop,e.onlocaltrack="function"==typeof e.onlocaltrack?e.onlocaltrack:l.noop,e.onremotetrack="function"==typeof e.onremotetrack?e.onremotetrack:l.noop,e.ondata="function"==typeof e.ondata?e.ondata:l.noop,e.ondataopen="function"==typeof e.ondataopen?e.ondataopen:l.noop,e.oncleanup="function"==typeof e.oncleanup?e.oncleanup:l.noop,e.ondetached="function"==typeof e.ondetached?e.ondetached:l.noop,!k)return l.warn("Is the server down? (connected=false)"),void e.error("Is the server down? (connected=false)");let t=e.plugin;if(!t)return l.error("Invalid plugin"),void e.error("Invalid plugin");let s=e.opaqueId,n=e.loopIndex,r=e.token?e.token:C,i=l.randomString(12),a={janus:"attach",plugin:t,opaque_id:s,loop_index:n,transaction:i};r&&(a.token=r);S&&(a.apisecret=S);if(o)return D[i]=function(s){if(l.debug(s),"success"!==s.janus)return l.error("Ooops: "+s.error.code+" "+s.error.reason),void e.error("Ooops: "+s.error.code+" "+s.error.reason);let n=s.data.id;l.log("Created handle: "+n);let i={session:A,plugin:t,id:n,token:r,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return n},getPlugin:function(){return t},getVolume:function(e,t){return H(n,e,!0,t)},getRemoteVolume:function(e,t){return H(n,e,!0,t)},getLocalVolume:function(e,t){return H(n,e,!1,t)},isAudioMuted:function(e){return X(n,e,!1)},muteAudio:function(e){return K(n,e,!1,!0)},unmuteAudio:function(e){return K(n,e,!1,!1)},isVideoMuted:function(e){return X(n,e,!0)},muteVideo:function(e){return K(n,e,!0,!0)},unmuteVideo:function(e){return K(n,e,!0,!1)},getBitrate:function(e){return Q(n,e)},setMaxBitrate:function(e,t){return Y(n,e,t)},send:function(e){M(n,e)},data:function(e){U(n,e)},dtmf:function(e){J(n,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){q(n,!0,e)},createAnswer:function(e){q(n,!1,e)},handleRemoteJsep:function(e){V(n,e)},replaceTracks:function(e){z(n,e)},getLocalTracks:function(){return B(n)},getRemoteTracks:function(){return G(n)},onlocaltrack:e.onlocaltrack,onremotetrack:e.onremotetrack,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){ee(n,!0===e)},detach:function(e){F(n,e)}};x[n]=i,e.success(i)},a.session_id=I,void c.send(JSON.stringify(a));l.httpAPICall(m+"/"+I,{verb:"POST",withCredentials:b,body:a,success:function(s){if(l.debug(s),"success"!==s.janus)return l.error("Ooops: "+s.error.code+" "+s.error.reason),void e.error("Ooops: "+s.error.code+" "+s.error.reason);let n=s.data.id;l.log("Created handle: "+n);let i={session:A,plugin:t,id:n,token:r,detached:!1,webrtcStuff:{started:!1,myStream:null,streamExternal:!1,mySdp:null,mediaConstraints:null,pc:null,dataChannelOptions:e.dataChannelOptions,dataChannel:{},dtmfSender:null,trickle:!0,iceDone:!1,bitrate:{}},getId:function(){return n},getPlugin:function(){return t},getVolume:function(e,t){return H(n,e,!0,t)},getRemoteVolume:function(e,t){return H(n,e,!0,t)},getLocalVolume:function(e,t){return H(n,e,!1,t)},isAudioMuted:function(e){return X(n,e,!1)},muteAudio:function(e){return K(n,e,!1,!0)},unmuteAudio:function(e){return K(n,e,!1,!1)},isVideoMuted:function(e){return X(n,e,!0)},muteVideo:function(e){return K(n,e,!0,!0)},unmuteVideo:function(e){return K(n,e,!0,!1)},getBitrate:function(e){return Q(n,e)},setMaxBitrate:function(e,t){return Y(n,e,t)},send:function(e){M(n,e)},data:function(e){U(n,e)},dtmf:function(e){J(n,e)},consentDialog:e.consentDialog,iceState:e.iceState,mediaState:e.mediaState,webrtcState:e.webrtcState,slowLink:e.slowLink,onmessage:e.onmessage,createOffer:function(e){q(n,!0,e)},createAnswer:function(e){q(n,!1,e)},handleRemoteJsep:function(e){V(n,e)},replaceTracks:function(e){z(n,e)},getLocalTracks:function(){return B(n)},getRemoteTracks:function(){return G(n)},onlocaltrack:e.onlocaltrack,onremotetrack:e.onremotetrack,ondata:e.ondata,ondataopen:e.ondataopen,oncleanup:e.oncleanup,ondetached:e.ondetached,hangup:function(e){ee(n,!0===e)},detach:function(e){F(n,e)}};x[n]=i,e.success(i)},error:function(t,s){l.error(t+":",s),""===s?e.error(t+": Is the server down?"):e.error(t+": "+s)}})}(e)}}return l.useDefaultDependencies=function(t){let s=t&&t.fetch||fetch,n=t&&t.Promise||Promise,r=t&&t.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new r(e,t)},extension:t&&t.extension||c,isArray:function(e){return Array.isArray(e)},webRTCAdapter:t&&t.adapter||e,httpAPICall:function(e,t){let r={method:t.verb,headers:{Accept:"application/json, text/plain, */*"},cache:"no-cache"};"POST"===t.verb&&(r.headers["Content-Type"]="application/json"),void 0!==t.withCredentials&&(r.credentials=!0===t.withCredentials?"include":t.withCredentials?t.withCredentials:"omit"),t.body&&(r.body=JSON.stringify(t.body));let i=s(e,r).catch(function(e){return n.reject({message:"Probably a network error, is the server down?",error:e})});if(t.timeout){let e=new n(function(e,s){let n=setTimeout(function(){return clearTimeout(n),s({message:"Request timed out",timeout:t.timeout})},t.timeout)});i=n.race([i,e])}return i.then(function(e){return e.ok?typeof t.success==typeof l.noop?e.json().then(function(e){try{t.success(e)}catch(e){l.error("Unhandled httpAPICall success callback error",e)}},function(t){return n.reject({message:"Failed to parse response body",error:t,response:e})}):void 0:n.reject({message:"API call failed",response:e})}).catch(function(e){typeof t.error==typeof l.noop&&t.error(e.message||"<< internal error >>",e)}),i}}},l.useOldDependencies=function(t){let s=t&&t.jQuery||jQuery,n=t&&t.WebSocket||WebSocket;return{newWebSocket:function(e,t){return new n(e,t)},isArray:function(e){return s.isArray(e)},extension:t&&t.extension||c,webRTCAdapter:t&&t.adapter||e,httpAPICall:function(e,t){let n=void 0!==t.body?{contentType:"application/json",data:JSON.stringify(t.body)}:{},r=void 0!==t.withCredentials?{xhrFields:{withCredentials:t.withCredentials}}:{};return s.ajax(s.extend(n,r,{url:e,type:t.verb,cache:!1,dataType:"json",async:t.async,timeout:t.timeout,success:function(e){typeof t.success==typeof l.noop&&t.success(e)},error:function(e,s,n){typeof t.error==typeof l.noop&&t.error(s,n)}}))}}},l.mediaToTracks=function(e){let t=[];if(e){if(!e.keepAudio&&!1!==e.audio&&(void 0===e.audio||e.audio||e.audioSend||e.audioRecv||e.addAudio||e.replaceAudio||e.removeAudio)){let s={type:"audio"};e.removeAudio?s.remove=!0:(e.addAudio?s.add=!0:e.replaceAudio&&(s.replace=!0),!1!==e.audioSend&&(s.capture=e.audio||!0),!1!==e.audioRecv&&(s.recv=!0)),(s.remove||s.capture||s.recv)&&t.push(s)}if(!e.keepVideo&&!1!==e.video&&(void 0===e.video||e.video||e.videoSend||e.videoRecv||e.addVideo||e.replaceVideo||e.removeVideo)){let s={type:"video"};e.removeVideo?s.remove=!0:(e.addVideo?s.add=!0:e.replaceVideo&&(s.replace=!0),!1!==e.videoSend&&(s.capture=e.video||!0,["screen","window","desktop"].includes(s.capture)&&(s.type="screen",s.capture={video:{}},e.screenshareFrameRate&&(s.capture.frameRate=e.screenshareFrameRate),e.screenshareHeight&&(s.capture.height=e.screenshareHeight),e.screenshareWidth&&(s.capture.width=e.screenshareWidth))),!1!==e.videoRecv&&(s.recv=!0)),(s.remove||s.capture||s.recv)&&t.push(s)}e.data&&t.push({type:"data"})}else t.push({type:"audio",capture:!0,recv:!0}),t.push({type:"video",capture:!0,recv:!0});return t},l.trackConstraints=function(e){let t={};if(!e||!e.capture)return t;if("audio"===e.type)t.audio=e.capture;else if("video"===e.type)if((e.simulcast||e.svc)&&!0===e.capture&&(e.capture="hires"),!0===e.capture||"object"==typeof e.capture)t.video=e.capture;else{let s=0,n=0;"lowres"===e.capture?(s=320,n=240):"lowres-16:9"===e.capture?(s=320,n=180):"hires"===e.capture||"hires-16:9"===e.capture||"hdres"===e.capture?(s=1280,n=720):"fhdres"===e.capture?(s=1920,n=1080):"4kres"===e.capture?(s=3840,n=2160):"stdres"===e.capture?(s=640,n=480):"stdres-16:9"===e.capture?(s=640,n=360):(l.log("Default video setting is stdres 4:3"),s=640,n=480),t.video={width:{ideal:s},height:{ideal:n}}}else"screen"===e.type&&(t.video=e.capture);return t},l.noop=function(){},l.dataChanDefaultLabel="JanusDataChannel",l.endOfCandidates=null,l.stopAllTracks=function(e){try{let t=e.getTracks();for(let e of t)l.log(e),e&&!0!==e.dontStop&&e.stop()}catch(e){}},l.init=function(e){if((e=e||{}).callback="function"==typeof e.callback?e.callback:l.noop,l.initDone)e.callback();else{if(void 0===console.log&&(console.log=function(){}),l.trace=l.noop,l.debug=l.noop,l.vdebug=l.noop,l.log=l.noop,l.warn=l.noop,l.error=l.noop,!0===e.debug||"all"===e.debug)l.trace=console.trace.bind(console),l.debug=console.debug.bind(console),l.vdebug=console.debug.bind(console),l.log=console.log.bind(console),l.warn=console.warn.bind(console),l.error=console.error.bind(console);else if(Array.isArray(e.debug))for(let t of e.debug)switch(t){case"trace":l.trace=console.trace.bind(console);break;case"debug":l.debug=console.debug.bind(console);break;case"vdebug":l.vdebug=console.debug.bind(console);break;case"log":l.log=console.log.bind(console);break;case"warn":l.warn=console.warn.bind(console);break;case"error":l.error=console.error.bind(console);break;default:console.error("Unknown debugging option '"+t+"' (supported: 'trace', 'debug', 'vdebug', 'log', warn', 'error')")}l.log("Initializing library");let s=e.dependencies||l.useDefaultDependencies();if(l.isArray=s.isArray,l.webRTCAdapter=s.webRTCAdapter,l.httpAPICall=s.httpAPICall,l.newWebSocket=s.newWebSocket,l.extension=s.extension,l.extension.init(),l.listDevices=function(e,s){e="function"==typeof e?e:l.noop,s||(s={audio:!0,video:!0}),l.isGetUserMediaAvailable()?t.mediaDevices.getUserMedia(s).then(function(s){t.mediaDevices.enumerateDevices().then(function(t){l.debug(t),e(t),l.stopAllTracks(s)})}).catch(function(t){l.error(t),e([])}):(l.warn("navigator.mediaDevices unavailable"),e([]))},l.safariVp8=!1,"safari"===l.webRTCAdapter.browserDetails.browser&&l.webRTCAdapter.browserDetails.version>=605)if(a&&a.getCapabilities&&a.getCapabilities("video")&&a.getCapabilities("video").codecs&&a.getCapabilities("video").codecs.length){for(let e of a.getCapabilities("video").codecs)if(e&&e.mimeType&&"video/vp8"===e.mimeType.toLowerCase()){l.safariVp8=!0;break}l.safariVp8?l.log("This version of Safari supports VP8"):l.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu")}else{let e=new r({});e.createOffer({offerToReceiveVideo:!0}).then(function(t){l.safariVp8=-1!==t.sdp.indexOf("VP8"),l.safariVp8?l.log("This version of Safari supports VP8"):l.warn("This version of Safari does NOT support VP8: if you're using a Technology Preview, try enabling the 'WebRTC VP8 codec' setting in the 'Experimental Features' Develop menu"),e.close(),e=null})}l.initDone=!0,e.callback()}},l.isWebrtcSupported=function(){return!!r},l.isGetUserMediaAvailable=function(){return t.mediaDevices&&t.mediaDevices.getUserMedia},l.randomString=function(e){let t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",s="";for(let n=0;n<e;n++){let e=Math.floor(62*Math.random());s+=t.charAt(e)}return s},Ps=l}(),js=ye(Ns);class Us{token;server;debug;engine;videoRoomPlugin=null;isOnlyAudio=!1;currentRoomId=null;currentUserId=null;remoteFeeds={};remoteJseps={};remoteFeedsAttachingInProgress={};bitrateTimers={};emitter=new Ue;constructor(e){if(!pe.env.isReactNative&&!Z)throw"Error: in order to use this library please connect adapter.js. More info https://github.com/webrtc/adapter";if(this.token=e,this.server=he.conference.server,this.debug=he.conference.debug??f.ALL,!this.server)throw"'server' parameter is mandatory";this.server.includes("http")&&(this.server+="/janus")}createSession({success:e=()=>{},error:t=()=>{},destroyed:s=()=>{},timeoutSessionCallback:n=()=>{}}){js.init({debug:this.debug,callback:()=>{js.isWebrtcSupported()?this.engine=new js({server:this.server,iceServers:he.videochat.iceServers,token:this.token,success:()=>pe.safeCallbackCall(e)(),error:e=>pe.safeCallbackCall(t)(e),destroyed:()=>pe.safeCallbackCall(s)(),timeoutSessionCallback:()=>pe.safeCallbackCall(n)()}):pe.safeCallbackCall(t)("Your browser does not support WebRTC, so you can't use this functionality.")}})}getSessionId(){return this.engine?.getSessionId()??null}destroySession({success:e=()=>{},error:t=()=>{}}){this.engine.destroy({success:()=>pe.safeCallbackCall(e)(),error:e=>pe.safeCallbackCall(t)(e)})}attachVideoConferencingPlugin(e,t,s,n){let r=null;const i=n.localStream;delete n.localStream;const a=n.displayName;delete n.displayName,this.engine.attach({plugin:"janus.plugin.videoroom",success:s=>{if(e){r=s,r.userId=t,this.remoteFeedsAttachingInProgress[t]=r;const e={request:"join",room:this.currentRoomId,ptype:"listener",feed:t,display:a};r?.send({message:e})}else this.videoRoomPlugin=s;pe.safeCallbackCall(n.success)()},error:e=>{pe.safeCallbackCall(n.error)(e)},consentDialog:e=>{pe.safeCallbackCall(n.consentDialog)(e)},mediaState:(e,t)=>{pe.safeCallbackCall(n.mediaState)(e,t)},webrtcState:e=>{pe.safeCallbackCall(n.webrtcState)(e)},slowLink:(e,t)=>{pe.safeCallbackCall(n.slowLink)(e,t)},iceState:e=>{pe.safeCallbackCall(n.iceState)(e)},onmessage:(t,r)=>{const a=t.videoroom;if(e){if(a)if("attached"===a){const e=t.id;this.remoteFeeds[e]=this.remoteFeedsAttachingInProgress[e],this.remoteFeedsAttachingInProgress[e]=null}else t.error&&pe.safeCallbackCall(n.error)(t.error);if(r){const e=t.id;this.remoteJseps[e]=r,this.createAnswer({remoteFeed:this.remoteFeeds[e],jsep:r},i,{success:()=>{},error:e=>{pe.safeCallbackCall(n.error)(e)}})}}else{if(a)if("joined"===a){const e={media:s?{audio:!1,video:!1}:{audio:!0,video:!0},stream:s?void 0:i};this.createOffer(e,{success:()=>{if(t.publishers){const e=t.publishers;for(const t in e){const s=e[t].id,n=e[t].display;this.emitter.emit(T.PARTICIPANT_JOINED,s,n,!0)}}},error:e=>{pe.safeCallbackCall(n.error)(e)}})}else if("event"===a)if(t.publishers){const e=t.publishers;for(const t in e){const s=e[t].id,n=e[t].display;this.emitter.emit(T.PARTICIPANT_JOINED,s,n,!1)}}else if(t.leaving){const e=t.leaving;this.detachRemoteFeed(e)&&this.emitter.emit(T.PARTICIPANT_LEFT,e,null)}else if(t.unpublished){const e=t.unpublished;if("ok"!=e){this.detachRemoteFeed(e)&&this.emitter.emit(T.PARTICIPANT_LEFT,e,null)}}else t.error&&(pe.DLog("[janus error message]",t.error),this.emitter.emit(T.ERROR,t),pe.safeCallbackCall(n.error)(t.error));r&&this.videoRoomPlugin.handleRemoteJsep({jsep:r})}},onlocaltrack:(e,t)=>{pe.DLog("[onlocaltrack]",e,t),this.onLocalTrack(e,t)},onremotetrack:(e,t,s,n)=>{pe.DLog("[onremotetrack]",e,t,s,n),this.onRemoteTrack(r,e,t,s,n)},ondataopen:e=>{pe.DLog("[ondataopen]",e),this.emitter.emit(T.DATA_CHANNEL_OPEN,e)},ondata:(e,t)=>{pe.DLog("[ondata]",t,e),this.emitter.emit(T.DATA_CHANNEL_MESSAGE,t,e)},oncleanup:()=>{pe.safeCallbackCall(n.oncleanup)()},detached:()=>{}})}onLocalTrack(e,t){}onRemoteTrack(e,t,s,n,r){const i=r&&r.reason;if(i===I.CREATED){const n=!e.stream||!e.tracks;n?(e.tracks={[s]:t},e.stream=new se([t])):(e.tracks[s]=t,e.stream.addTrack(t)),n&&this.emitter.emit(T.REMOTE_STREAM,e.userId,e.stream)}else if(i===I.ENDED){delete e.tracks[s];const n=e.stream.getTracks().find(e=>e.kind===t.kind);e.stream.removeTrack(n)}this.emitter.emit(T.REMOTE_TRACKS_UPDATED,e.userId,t,i)}getPluginId(){return this.videoRoomPlugin?.getId()??null}detachVideoConferencingPlugin(e){const t=()=>{this.videoRoomPlugin=null,Object.keys(this.remoteFeeds).forEach(e=>{this.detachRemoteFeed(Number(e))}),this.remoteFeeds={},this.remoteJseps={}};this.videoRoomPlugin.detach({success:()=>{t(),pe.safeCallbackCall(e.success)()},error:s=>{t(),pe.safeCallbackCall(e.error)(s)}})}join(e,t,s,n){const r=n.displayName;delete n.displayName,this.isOnlyAudio=s,pe.DLog("isOnlyAudio: "+this.isOnlyAudio);const i={request:"join",room:e,ptype:"publisher",id:t,display:r};this.videoRoomPlugin.send({message:i,success:s=>{this.currentRoomId=e,this.currentUserId=t,pe.safeCallbackCall(n.success)()},error:e=>{pe.safeCallbackCall(n.error)(e)}})}leave(e){if(pe.DLog("leave"),!this.engine.isConnected())return void pe.safeCallbackCall(e.success)();const t={request:"leave",room:this.currentRoomId,id:this.currentUserId};this.videoRoomPlugin&&this.videoRoomPlugin.send({message:t}),this.currentRoomId=null,this.currentUserId=null,pe.safeCallbackCall(e.success)()}listOnlineParticipants(e,t){const s={request:"listparticipants",room:e};this.videoRoomPlugin.send({message:s,success:e=>{const s=e?e.participants:[];pe.safeCallbackCall(t.success)(s)},error:e=>{pe.safeCallbackCall(t.error)(e)}})}toggleAudioMute(){return this.videoRoomPlugin.isAudioMuted()?this.videoRoomPlugin.unmuteAudio():this.videoRoomPlugin.muteAudio(),this.videoRoomPlugin.isAudioMuted()}isAudioMuted(){try{return this.videoRoomPlugin.isAudioMuted()}catch(e){throw"Unknown audio mute/unmute state. Join the room to manage these settings"}}toggleRemoteAudioMute(e){const t=this.remoteFeeds[e];if(!t)return!1;const s=t.stream.getAudioTracks();if(s&&s.length>0){for(let e=0;e<s.length;++e)s[e].enabled=!s[e].enabled;return!s[0].enabled}return!1}isRemoteAudioMuted(e){const t=this.remoteFeeds[e];if(!t)return!1;const s=t.stream.getAudioTracks();return!!(s&&s.length>0)&&!s[0].enabled}toggleVideoMute(){return this.videoRoomPlugin.isVideoMuted()?this.videoRoomPlugin.unmuteVideo():this.videoRoomPlugin.muteVideo(),this.videoRoomPlugin.isVideoMuted()}isVideoMuted(){try{return this.videoRoomPlugin.isVideoMuted()}catch(e){throw"Unknown video mute/unmute state. Join the room to manage these settings"}}toggleRemoteVideoMute(e){const t=this.remoteFeeds[e];if(!t)return!1;const s=t.stream.getVideoTracks();if(s&&s.length>0){for(let e=0;e<s.length;++e)s[e].enabled=!s[e].enabled;return!s[0].enabled}return!1}isRemoteVideoMuted(e){const t=this.remoteFeeds[e];if(!t)return!1;const s=t.stream.getVideoTracks();return!!(s&&s.length>0)&&!s[0].enabled}sendKeyframeRequest(e,t){const s={request:"configure",room:e,keyframe:!0};this.videoRoomPlugin.send({message:s,success:e=>{pe.safeCallbackCall(t.success)(e)},error:e=>{pe.safeCallbackCall(t.error)(e)}})}getTracksFromStream(e){const t=[],s=e.getAudioTracks();if(s.length){const e=s[0];t.push({type:"audio",capture:e,recv:!1})}const n=e.getVideoTracks();if(n.length){const e=n[0];t.push({type:"video",capture:e,recv:!1})}return t}createOffer(e,t){pe.DLog("[JanusWrapper][createOffer]",e);const{stream:s,media:n,replace:r}=e,i={tracks:[{type:"data"}]};if(s){const e=this.getTracksFromStream(s);i.tracks=i.tracks.concat(e)}else if(n){const e=[];n.audio&&e.push({type:"audio",capture:n.audio,recv:!1,replace:!!r}),n.video&&e.push({type:"video",capture:n.video,recv:!1,replace:!!r}),i.tracks=i.tracks.concat(e)}else i.tracks=i.tracks.concat([{type:"audio",capture:!0,recv:!1,replace:!!r},{type:"video",capture:!0,recv:!1,replace:!!r}]);pe.DLog("[JanusWrapper][createOffer][params]",i),i.customizeSdp=e=>{},i.success=e=>{const s={request:"configure",audio:!!n.audio,video:!!n.video};pe.DLog("[JanusWrapper][createOffer][success]",s),this.videoRoomPlugin.send({message:s,jsep:e}),pe.safeCallbackCall(t.success)()},i.error=e=>{pe.DLog("[JanusWrapper][createOffer][error]",e),n.audio?this.createOffer({media:{video:!1,audio:!1}},t):pe.safeCallbackCall(t.error)(e)},this.videoRoomPlugin.createOffer(i)}getTracksMidsFromStream(e){const t=[],s=e.getAudioTracks();if(s.length){const e=s[0];t.push({type:"audio",mid:e.id,recv:!0})}const n=e.getVideoTracks();if(n.length){const e=n[0];t.push({type:"video",mid:e.id,recv:!0})}return t}createAnswer({remoteFeed:e,jsep:t},s,n){pe.DLog("[JanusWrapper][createAnswer]",t,s);let r=[{type:"data"}];if(s){const e=this.getTracksMidsFromStream(s);r=r.concat(e)}pe.DLog("[JanusWrapper][createAnswer][tracks]",r),e.createAnswer({jsep:t,tracks:r,success:t=>{const s={request:"start",room:this.currentRoomId};pe.DLog("[JanusWrapper][createAnswer][success]",s),e.send({message:s,jsep:t}),pe.safeCallbackCall(n.success)()},error:e=>{pe.DLog("[JanusWrapper][createAnswer][error]",e),pe.safeCallbackCall(n.error)(e)}})}detachRemoteFeed(e){const t=this.remoteFeeds[e];return!!t&&(t.detach(),this.remoteFeeds[e]=null,this.remoteJseps[e]=null,!0)}getUserBitrate(e){return this.remoteFeeds[e].getBitrate()}getVolume(e){return this.videoRoomPlugin.getLocalVolume(null,e)}getUserVolume(e,t){return this.remoteFeeds[e].getRemoteVolume(null,t)}showBitrate(e,t){const s=this.remoteFeeds[e];pe.env.isReactNative||"chrome"!==Z.browserDetails.browser&&"firefox"!==Z.browserDetails.browser||(this.bitrateTimers[e]=setInterval(()=>{const e=s.getBitrate();t.text(e)},1e3))}hideBitrate(e,t){this.bitrateTimers[e]&&clearInterval(this.bitrateTimers[e]),this.bitrateTimers[e]=null,t.text=null}on(e,t){return this.emitter.addListener(e,t)}removeAllListeners(e){return this.emitter.removeAllListeners(e)}}class Js{client;id=`${Math.random()}`;currentUserDisplayName;localStream;mediaParams={};onParticipantJoinedListener;onParticipantLeftListener;onSlowLinkListener;onRemoteStreamListener;onRemoteTracksUpdatedListener;onRemoteConnectionStateChangedListener;onDataChannelOpenedListener;onDataChannelMessageListener;onSessionConnectionStateChangedListener;onErrorListener;constructor(e){this.client=new Us(e),this.client.on(T.PARTICIPANT_JOINED,this.onParticipantJoined),this.client.on(T.PARTICIPANT_LEFT,this.onParticipantLeft),this.client.on(T.REMOTE_STREAM,this.onRemoteStream),this.client.on(T.REMOTE_TRACKS_UPDATED,this.onRemoteTracksUpdated),this.client.on(T.DATA_CHANNEL_OPEN,this.onDataChannelOpen),this.client.on(T.DATA_CHANNEL_MESSAGE,this.onDataChannelMessage),this.client.on(T.ERROR,this.onError)}get currentRoomId(){return this.client.currentRoomId}set currentRoomId(e){this.client.currentRoomId=e}get currentPublisherPC(){return this.client.videoRoomPlugin.webrtcStuff.pc}async createSession(){let e=!1;return new Promise((t,s)=>{this.client.createSession({success:()=>{e=!0,t(void 0)},error:t=>{e?this.onError(t):s(t)}})})}async join(e,t,s){this.currentUserDisplayName=s,this.currentRoomId=e,await this.createSession(),await this.createHandler(t,!1,!1),await this.joinInternal(this.currentRoomId,t)}async joinAsListener(e,t,s){this.currentUserDisplayName=s,this.currentRoomId=e,await this.createSession(),await this.createHandler(t,!1,!0),await this.joinInternal(this.currentRoomId,t)}async sendKeyframeRequest(e){return new Promise((t,s)=>{this.client.sendKeyframeRequest(e,{success:t,error:s})})}async createHandler(e,t,s=!1){return new Promise((n,r)=>{this.client.attachVideoConferencingPlugin(t,e,s,{success:n,error:r,iceState:t?t=>this.onRemoteIceStateChanged(e,t):e=>this.onLocalIceStateChanged(e),slowLink:t?(t,s)=>this.onSlowLink(e,t,s):(e,t)=>this.onSlowLink(null,e,t),localStream:this.localStream,displayName:this.currentUserDisplayName})})}async joinInternal(e,t){return new Promise((s,n)=>{this.client.join(e,t,!1,{success:s,error:n,displayName:this.currentUserDisplayName})})}onParticipantJoined=(e,t,s)=>{pe.DLog("[onParticipantJoined]",e,t,s),this.createHandler(e,!0,!1),pe.safeCallbackCall(this.onParticipantJoinedListener)(this,e,t,s)};onParticipantLeft=(e,t)=>{pe.DLog("[onParticipantLeft]",e,t),pe.safeCallbackCall(this.onParticipantLeftListener)(this,e,t)};onError=e=>{pe.DLog("[onError]",JSON.stringify(e)),pe.safeCallbackCall(this.onErrorListener)(this,e)};onDataChannelOpen=e=>{pe.DLog("[onDataChannelOpen]",e),pe.safeCallbackCall(this.onDataChannelOpenedListener)(this,e)};onDataChannelMessage=(e,t)=>{pe.DLog("[onDataChannelMessage]",e,t),pe.safeCallbackCall(this.onDataChannelMessageListener)(this,e,t)};onLocalIceStateChanged=e=>{pe.DLog("[onLocalIceStateChanged]",e),pe.safeCallbackCall(this.onSessionConnectionStateChangedListener)(this,e)};onRemoteIceStateChanged=(e,t)=>{pe.DLog("[onRemoteIceStateChanged]",e,t),pe.safeCallbackCall(this.onRemoteConnectionStateChangedListener)(this,e,t)};onRemoteStream=(e,t)=>{pe.DLog("[onRemoteStream]",e,t),pe.safeCallbackCall(this.onRemoteStreamListener)(this,e,t)};onRemoteTracksUpdated=(e,t,s)=>{pe.DLog("[onRemoteTracksUpdated]",e,t,s),pe.safeCallbackCall(this.onRemoteTracksUpdatedListener)(this,e,t,s)};onSlowLink=(e,t,s)=>{pe.DLog("[onSlowLink]",e,t,s),pe.safeCallbackCall(this.onSlowLinkListener)(this,e,t,s)};async listOfOnlineParticipants(){return new Promise((e,t)=>{this.currentRoomId?this.client.listOnlineParticipants(this.currentRoomId,{success:e,error:t}):t("Room ID is not set")})}async leave(){this.currentRoomId=null,this.currentUserDisplayName=void 0,await this.leaveGroup(),await this.detachVideoConferencingPlugin(),await this.destroy(),this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=void 0,this.mediaParams={})}async leaveGroup(){return new Promise((e,t)=>{this.client.leave({success:e,error:t})})}async destroy(){return new Promise((e,t)=>{this.client.destroySession({success:e,error:t})})}async detachVideoConferencingPlugin(){return new Promise((e,t)=>{this.client.detachVideoConferencingPlugin({success:e,error:t})})}async getDisplayMedia(e){if(!te.getDisplayMedia)throw new Error("Your environment does not support 'getDisplayMedia' API");const t=e&&e.elementId,s=e&&e.options,n={...e};this.mediaParams=n,delete n.elementId,delete n.options;try{const e=await te.getDisplayMedia(n);return this.upsertStream(e,t,s)}catch(e){throw e}}async getUserMedia(e){const t=e&&e.elementId,s=e&&e.options,n={...e};this.mediaParams=n,delete n.elementId,delete n.options;try{const e=await te.getUserMedia(n);return this.upsertStream(e,t,s)}catch(e){throw e}}upsertStream(e,t=null,s={}){const n=!!this.localStream;if(n?this.replaceTracks(e):this.localStream=e,!this.localStream)throw new Error("Local stream is not defined");return t&&(n&&this.detachMediaStream(t,s),this.attachMediaStream(t,this.localStream,s)),this.localStream.getTracks().forEach(e=>{const t=e.kind,s=e.getSettings().deviceId;s&&("object"==typeof this.mediaParams[t]?this.mediaParams[t].deviceId=s:this.mediaParams[t]={deviceId:s})}),this.localStream}replaceTracks(e){if(this.localStream?.getTracks().forEach(t=>{t.kind===k.AUDIO&&0===e.getAudioTracks().length||(t.stop(),this.localStream?.removeTrack(t))}),e.getTracks().forEach(e=>{const t=this.currentPublisherPC.getSenders().find(({track:t})=>e.kind===t.kind);e.kind===k.AUDIO?e.enabled=this.localStream?.getAudioTracks().every(({enabled:e})=>e)??!0:e.enabled=this.localStream?.getVideoTracks().every(({enabled:e})=>e)??!0,t?(t.replaceTrack(e),this.localStream?.addTrack(e)):console.warn(`No sender found for track kind: ${e.kind}`)}),!this.localStream)throw new Error("Local stream is not defined");return this.localStream}async switchMediaTracks(e){[k.AUDIO,k.VIDEO].forEach(t=>{const s=t===k.AUDIO?e.audio:t===k.VIDEO?e.video:{},n="string"==typeof s?s:s?.deviceId??null;n&&("object"==typeof this.mediaParams[t]?this.mediaParams[t].deviceId=n:this.mediaParams[t]={deviceId:n})});try{const e={audio:this.mediaParams?.audio??!1,video:this.mediaParams?.video??!1},t=await te.getUserMedia(e);return this.replaceTracks(t)}catch(e){throw e}}muteVideo(){this.isVideoMuted()||this.client.toggleVideoMute()}unmuteVideo(){this.isVideoMuted()&&this.client.toggleVideoMute()}muteAudio(){this.isAudioMuted()||this.client.toggleAudioMute()}unmuteAudio(){this.isAudioMuted()&&this.client.toggleAudioMute()}isVideoMuted(){return this.client.isVideoMuted()}isAudioMuted(){return this.client.isAudioMuted()}async getUserVolume(){return new Promise((e,t)=>this.client.getVolume(e))}getRemoteUserBitrate(e){return this.client.getUserBitrate(e)}async getRemoteUserVolume(e){return new Promise((t,s)=>this.client.getUserVolume(e,t))}attachMediaStream(e,t,s){const n=document.getElementById(e);if(!("srcObject"in n))throw new Error(`Unable to attach media stream, element #${e} is undefined`);n.srcObject=t,n.style.transform=s?.mirror?"scaleX(-1)":"none","boolean"==typeof s?.muted&&(n.muted=s?.muted),n.onloadedmetadata=async e=>{try{await n.play()}catch(e){console.error("[VideoChatConference]:",e)}}}detachMediaStream(e,t){const s=document.getElementById(e);if(!("srcObject"in s))throw new Error(`Unable to attach media stream, element #${e} is undefined`);s.pause(),s.srcObject=null,s.style.transform=t?.mirror?"scaleX(-1)":"none","boolean"==typeof t?.muted&&(s.muted=t?.muted)}async sendData(e,t){return new Promise((s,n)=>{this.client.videoRoomPlugin.data({data:e,label:t,success:s,error:n})})}}class Fs{proxy;DeviceInputType=E;JanusCallType=k;sessionsStore={};onParticipantJoinedListener;onParticipantLeftListener;onSlowLinkListener;onRemoteStreamListener;onRemoteTracksUpdatedListener;onRemoteConnectionStateChangedListener;onDataChannelOpenedListener;onDataChannelMessageListener;onSessionConnectionStateChangedListener;onErrorListener;constructor(e){this.proxy=e}createNewSession(){const e=new Js(this.getCurrentSessionToken());return this.sessionsStore[e.id]=e,e.onParticipantJoinedListener=this.onParticipantJoinedListener,e.onParticipantLeftListener=this.onParticipantLeftListener,e.onSlowLinkListener=this.onSlowLinkListener,e.onRemoteStreamListener=this.onRemoteStreamListener,e.onRemoteTracksUpdatedListener=this.onRemoteTracksUpdatedListener,e.onRemoteConnectionStateChangedListener=this.onRemoteConnectionStateChangedListener,e.onDataChannelOpenedListener=this.onDataChannelOpenedListener,e.onDataChannelMessageListener=this.onDataChannelMessageListener,e.onSessionConnectionStateChangedListener=this.onSessionConnectionStateChangedListener,e.onErrorListener=this.onErrorListener,e}async getMediaDevices(e){if(te?.enumerateDevices){const t=await te.enumerateDevices();return e?t.filter(t=>t.kind===e):t}throw new Error("No 'enumerateDevices' API supported")}clearSession(e){delete this.sessionsStore[e]}getCurrentSessionToken(){const e=this.proxy.getSession();if(e?.token)return e.token;throw new Error("Session does not exist")}getListenerByName(e){switch(e){case x.JOIN:return"onParticipantJoinedListener";case x.LEFT:return"onParticipantLeftListener";case x.SLOW_LINK:return"onSlowLinkListener";case x.REMOTE_STREAM:return"onRemoteStreamListener";case x.REMOTE_TRACKS_UPDATED:return"onRemoteTracksUpdatedListener";case x.REMOTE_CONNECTION_STATE:return"onRemoteConnectionStateChangedListener";case x.DATA_CHANNEL_OPENED:return"onDataChannelOpenedListener";case x.DATA_CHANNEL_MESSAGE:return"onDataChannelMessageListener";case x.SESSION_CONNECTION_STATE:return"onSessionConnectionStateChangedListener";case x.ERROR:return"onErrorListener";default:return null}}addListener(e,t){const s=this.getListenerByName(e);return s&&(this[s]=t),this.removeListener.bind(this,e)}removeListener(e){const t=this.getListenerByName(e);t&&(this[t]=void 0)}removeAllListeners(){Object.keys(this).forEach(e=>{e.startsWith("on")&&e.endsWith("Listener")&&"function"==typeof this[e]&&(this[e]=void 0)})}}class $s{proxy;route=he.urls.data;constructor(e){this.proxy=e}async create(e,t={}){const s=pe.isArray(t),n=s?"multi":void 0,r={type:D.POST,url:pe.getUrl(this.route,e,n),data:s?{record:this.createRecord(t)}:t};return this.proxy.ajax(r)}async list(e,t={}){const s="string"==typeof t?t:pe.isArray(t)?t.toString():void 0,n={url:pe.getUrl(this.route,e,s),data:s?void 0:t};return this.proxy.ajax(n)}async readPermissions(e,t){const s={url:pe.getUrl(this.route,e,t),data:{permissions:1}};return this.proxy.ajax(s)}async update(e,t={}){const s=pe.isArray(t),n=!s&&t.search_criteria,r=s?"multi":n?"by_criteria":t.id||t._id,i={type:D.PUT,url:pe.getUrl(this.route,e,r),data:s?{record:this.createRecord(t)}:t};return this.proxy.ajax(i)}async delete(e,t){const s=pe.isObject(t),n="string"==typeof t||pe.isArray(t)&&1===t.length,r=s?"by_criteria":t.toString(),i={type:D.DELETE,url:pe.getUrl(this.route,e,r),data:s?t:void 0,dataType:n?R.TEXT:void 0};return this.proxy.ajax(i)}createRecord(e=[]){return e.reduce((e,t,s)=>{const n=s+1,r=t.id||t._id,i=r?{...t,id:r}:t;return{...e,[n]:i}},{})}}class qs{proxy;route=he.urls.meetings;constructor(e){this.proxy=e}async get(e={}){const t={type:D.GET,url:pe.getUrl(this.route),data:e};return this.proxy.ajax(t)}async create(e={}){const t=Math.ceil(Date.now()/1e3),s=t+3600,n={name:new Date(t).toLocaleString("en",{year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"}),start_date:t,end_date:s,attendees:[],record:!1,chat:!1},r={type:D.POST,url:pe.getUrl(this.route),data:{...n,...e}};return this.proxy.ajax(r)}async update(e,t){const s={type:D.PUT,url:pe.getUrl(this.route,e),data:t};return this.proxy.ajax(s)}async delete(e){const t={type:D.DELETE,url:pe.getUrl(this.route,e),dataType:R.TEXT};return this.proxy.ajax(t)}async getRecordings(e){const t={type:D.GET,url:pe.getUrl(this.route,"recordings",e)};return this.proxy.ajax(t)}}class Vs{proxy;subscriptions;events;constructor(e){this.proxy=e,this.subscriptions=new zs(e),this.events=new Ws(e)}base64Encode=W}class zs{proxy;route=he.urls.subscriptions;constructor(e){this.proxy=e}async create(e){const t={type:D.POST,url:pe.getUrl(this.route),data:e};return this.proxy.ajax(t)}async list(){const e={type:D.GET,url:pe.getUrl(this.route)};return this.proxy.ajax(e)}async delete(e){const t={type:D.DELETE,dataType:R.TEXT,url:pe.getUrl(this.route,e)};return this.proxy.ajax(t)}}class Ws{proxy;route=he.urls.events;constructor(e){this.proxy=e}async create(e){const t={type:D.POST,url:pe.getUrl(this.route),data:{event:e}};return this.proxy.ajax(t)}}class Bs{proxy;route=he.urls.blobs;constructor(e){this.proxy=e}async list(e={}){const t={type:D.GET,url:pe.getUrl(this.route),data:e};return this.proxy.ajax(t)}async create(e){const t={type:D.POST,url:pe.getUrl(this.route),data:{blob:e}};return this.proxy.ajax(t)}async delete(e){const t={type:D.DELETE,url:pe.getUrl(this.route,e),dataType:R.TEXT};return this.proxy.ajax(t)}async createAndUpload(e){const{name:t,file:s,size:n,abort_id:r,type:i,public:a=!0}=e,o={name:t,content_type:i,public:a};let c;return this.create(o).then(({blob:e})=>{c=e;const t=this.parseUri(c.blob_object_access?.params),n={url:`${t.protocol}://${t.authority}${t.path}`,data:{}};return r&&(n.abort_id=r),Object.keys(t.queryKey).forEach(e=>{n.data[e]=decodeURIComponent(t.queryKey[e])}),n.data.file=s,this.upload(n).then(()=>c)}).then(e=>this.markUploaded({id:e.id,size:n}).then(()=>e)).then(e=>({...e,size:n}))}async upload(e){const t={...e,type:D.POST,dataType:R.TEXT,contentType:!1};return this.proxy.ajax(t)}async markUploaded(e){const t={type:D.PUT,url:pe.getUrl(this.route,e.id,"complete"),data:{size:e.size},dataType:R.TEXT};return this.proxy.ajax(t)}async getInfo(e){const t={url:pe.getUrl(this.route,e)};return this.proxy.ajax(t)}async getFile(e){const t={url:pe.getUrl(this.route,e)};return this.proxy.ajax(t)}async getFileObject(e,t){const s={type:D.GET,url:pe.getUrl(this.route,e,"object"),data:t};return this.proxy.ajax(s)}async update(e){const t={blob:{}};void 0!==e.name&&(t.blob.name=e.name);const s={url:pe.getUrl(this.route,e.id),data:t};return this.proxy.ajax(s)}privateUrl(e=""){return`${he.endpoints.api_url??`https://${he.endpoints.api}`}/blobs/${e}?token=${this.proxy.getSession()?.token}`}publicUrl(e=""){return`${he.endpoints.api_url??`https://${he.endpoints.api}`}/blobs/${e}`}parseUri(e=""){const t={key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},s=t.parser.loose.exec(e)??{},n={};let r=14;for(;r--;)n[t.key[r]]=s[r]||"";return n[t.q.name]={},n[t.key[12]].replace(t.q.parser,(e,s,r)=>{s&&(n[t.q.name][s]=r)}),n}}class Gs{proxy;route=he.urls.users;constructor(e){this.proxy=e}async getV2(e){const t={type:D.GET,url:pe.getUrl(this.route,"v2"),useArrayQuery:!0,data:e};return this.proxy.ajax(t)}async signup(e,t){const s={authKey:t??he.creds.authKey,type:D.POST,url:pe.getUrl(this.route),data:{user:e}};return this.proxy.ajax(s)}async update(e={}){const t={type:D.PUT,url:pe.getUrl(this.route,this.proxy.getCurrentUserId()),data:{user:e}};return this.proxy.ajax(t)}async delete(){const e={type:D.DELETE,url:pe.getUrl(this.route,this.proxy.getCurrentUserId()),dataType:R.TEXT};return this.proxy.ajax(e)}async resetPassword(e=""){const t={type:D.POST,url:pe.getUrl(this.route,"password","reset"),data:{email:e},dataType:R.TEXT};return this.proxy.ajax(t)}async listOnline(e={}){const t={type:D.GET,url:pe.getUrl(this.route,"online"),data:e};return this.proxy.ajax(t)}async getOnlineCount(){const e={type:D.GET,url:pe.getUrl(this.route,"online"),data:{count:!0}};return this.proxy.ajax(e)}async get(e){let t=pe.cloneObject(e),s="";const n=[],r=["created_at","updated_at","last_request_at"],i=["id","external_user_id"],a={login:"by_login",full_name:"by_full_name",facebook_id:"by_facebook_id",twitter_id:"by_twitter_id",phone:"phone",email:"by_email",tags:"by_tags",external:"external"};function o(e){const t=pe.cloneObject(e);let s=r.includes(t.field)?"date":typeof t.value;return pe.isArray(t.value)&&("object"===s&&(s=typeof t.value[0]),t.value=t.value.toString()),[s,t.field,t.param,t.value].join(" ")}if(t.order){const e=t.order.field in r?"date":t.order.field in i?"number":"string";t.order=[t.order.sort,e,t.order.field].join(" ")}if(t&&t.filter&&(pe.isArray(t.filter)?t.filter.forEach(e=>{n.push(o(e))}):n.push(o(t.filter)),t.filter=n),"number"==typeof t)s=t,t=void 0;else for(const e in a)if(t[e]){s=a[e],e===a.external&&(s+=`/${t[a.external]}`,t=void 0);break}const c={type:D.GET,url:pe.getUrl(this.route,s),data:t};return this.proxy.ajax(c)}}class Hs{static getUserJid(e){return`${e}-${he.creds.appId}@${he.endpoints.chat}`}static getUserIdFromJID(e){return e?.includes("@")?parseInt(e.split("@")[0].split("-")[0]):null}static trace(e){he.debug&&console.log("[VideoChat]:",e)}static traceWarning(e){he.debug&&console.warn("[VideoChat]:",e)}static traceError(e){he.debug&&console.error("[VideoChat]:",e)}static get getVersionFirefox(){const e=ee?.userAgent??null;let t=0;if(e){const s=e.match(/(?:firefox)[ \/](\d+)/i)||[];t=s[1]?+s[1]:0}return"string"==typeof t?parseInt(t):t}static get getVersionSafari(){const e=ee?.userAgent??null;let t=0;if(e){if((e.match(/(?:safari)[ \/](\d+)/i)||[]).length){const s=e.match(/(?:version)[ \/](\d+)/i)||[];s&&(t=s[1]?+s[1]:0)}}return"string"==typeof t?parseInt(t):t}}class Xs{original;session;userID;type;remoteSDP=null;state=u.NEW;iceCandidates=[];remoteStream=new se;answerTimeInterval=0;onStatusClosedChecker=null;dialingTimer=null;statsReportTimer=null;waitingReconnectTimeoutCallback=null;released=!1;constructor(e,t,s){this.create(),this.setup(e,t,s)}create(){const e={iceTransportPolicy:he.videochat.alwaysRelayCalls?"relay":"all",iceServers:he.videochat.iceServers.map(e=>({urls:e.urls??e.url,username:e.username,credential:e.credential}))};this.original=ie?new ie(e):{},Hs.trace(`new RTCPeerConnection(${JSON.stringify(e,null,2)})`)}setup(e,t,s){this.type=s,this.userID=t,this.session=e,this.session.startCallTime=Date.now(),this.original.addEventListener("track",this.onMediaTrackHandler),this.original.addEventListener("icecandidate",this.onIceCandidateHandler),this.original.addEventListener("signalingstatechange",this.onSignalingStateHandler),this.original.addEventListener("iceconnectionstatechange",this.onIceConnectionStateHandler),Hs.trace(`RTCPeerConnection init. ${this.toString()}`)}onMediaTrackHandler=e=>{this.remoteStream.addTrack(e.track),(this.session.callType==l.VIDEO&&this.remoteStream.getVideoTracks().length||this.session.callType==l.AUDIO&&this.remoteStream.getAudioTracks().length)&&this.session.onRemoteStream(this.userID,this.remoteStream),this.getWrappedStats()};onIceCandidateHandler=e=>{if(e.candidate){const{sdpMLineIndex:t,sdpMid:s,candidate:n}=e.candidate,r={sdpMLineIndex:t,sdpMid:s,candidate:n};"stable"===this.signalingState&&this.original.canTrickleIceCandidates?this.session.processIceCandidates(this.userID,[r]):this.iceCandidates.push(r)}};onSignalingStateHandler=async()=>{Hs.trace(`onSignalingStateHandler: ${this.signalingState}`),"stable"===this.signalingState&&this.iceCandidates.length>0&&(this.session.processIceCandidates(this.userID,this.iceCandidates),this.iceCandidates.length=0)};onIceConnectionStateHandler=()=>{switch(Hs.trace(`onIceConnectionStateHandler: ${this.iceConnectionState}`),this.onStatusClosedChecker&&Hs.getVersionSafari>=11&&clearTimeout(this.onStatusClosedChecker),this.iceConnectionState){case"checking":this.state=u.CHECKING,this.session.onSessionConnectionStateChanged(this.userID,o.CONNECTING);break;case"connected":this.state=u.CONNECTED,this.clearWaitingReconnectTimer(),this.session.onSessionConnectionStateChanged(this.userID,o.CONNECTED);break;case"completed":this.state=u.COMPLETED,this.clearWaitingReconnectTimer(),this.session.onSessionConnectionStateChanged(this.userID,o.COMPLETED);break;case"failed":this.state=u.FAILED,this.session.onSessionConnectionStateChanged(this.userID,o.FAILED);break;case"disconnected":this.state=u.DISCONNECTED,this.startWaitingReconnectTimer(),this.session.onSessionConnectionStateChanged(this.userID,o.DISCONNECTED),Hs.getVersionSafari>=11&&(this.onStatusClosedChecker=setTimeout(()=>{this.onIceConnectionStateHandler()},500));break;case"closed":this.state=u.CLOSED,this.clearWaitingReconnectTimer(),this.session.onSessionConnectionStateChanged(this.userID,o.CLOSED)}};clearWaitingReconnectTimer(){this.waitingReconnectTimeoutCallback&&(Hs.trace("clearWaitingReconnectTimer"),clearTimeout(this.waitingReconnectTimeoutCallback),this.waitingReconnectTimeoutCallback=null)}startWaitingReconnectTimer(){const e=1e3*he.videochat.disconnectTimeInterval;Hs.trace(`startWaitingReconnectTimer, timeout: ${e}`),this.waitingReconnectTimeoutCallback=setTimeout(()=>{Hs.trace("waitingReconnectTimeoutCallback"),this.waitingReconnectTimeoutCallback&&clearTimeout(this.waitingReconnectTimeoutCallback),this.release(),this.session.closeSessionIfAllConnectionsClosed()},e)}clearStatsReportTimer(){this.statsReportTimer&&(clearInterval(this.statsReportTimer),this.statsReportTimer=null)}async addCandidates(e){for(const t of e)if(t?.candidate)try{await this.addIceCandidate(t),Hs.trace(`'addIceCandidate' success: ${this.signalingState}`)}catch(e){Hs.traceError(`'addIceCandidate' error: ${e}`)}}release(){this.clearDialingTimer(),this.clearStatsReportTimer(),this.close(),Hs.getVersionSafari>=11&&this.onIceConnectionStateHandler(),this.original.removeEventListener("track",this.onMediaTrackHandler),this.original.removeEventListener("icecandidate",this.onIceCandidateHandler),this.original.removeEventListener("signalingstatechange",this.onSignalingStateHandler),this.original.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateHandler),this.released=!0,Hs.trace(`RTCPeerConnection closed. ${this.toString()}`)}clearDialingTimer(){this.dialingTimer&&(Hs.trace("clearDialingTimer"),clearInterval(this.dialingTimer),this.dialingTimer=null,this.answerTimeInterval=0)}async getAndSetLocalSessionDescription(e,t=!1){this.state=u.CONNECTING;try{const s=t?{iceRestart:t}:void 0,n="offer"===this.type?await this.createOffer(s):await this.createAnswer();return await this.setLocalDescription(n),this.setRTCRtpSenderMaxBandwidth(e),n}catch(e){throw e}}setRTCRtpSenderMaxBandwidth(e){const t=this.getSenders()||[],s=e?Math.round(1e3*e):0;t.forEach(t=>{if(t.track?.kind===A.VIDEO){const n=t.getParameters();n.encodings??=[{}],n.encodings.forEach(e=>{s>0?e.maxBitrate=s:delete e.maxBitrate}),t.setParameters(n).then(()=>{Hs.trace(`Set 'maxBandwidth' for ${this.userID}: ${e>0?`${e} kbps`:"unlimited"}`)}).catch(e=>{Hs.traceWarning(`Set 'maxBandwidth' for ${this.userID}: ${e}`)})}})}startDialingTimer(e,t){const s=1e3*he.videochat.dialingTimeInterval;Hs.trace(`startDialingTimer, dialingTimeInterval: ${JSON.stringify(s)}`);const n=(e,t,s)=>{s||(this.answerTimeInterval+=1e3*he.videochat.dialingTimeInterval),Hs.trace(`dialingCallback, extension: ${JSON.stringify(e)}`),this.answerTimeInterval>=1e3*he.videochat.answerTimeInterval?(this.clearDialingTimer(),t&&this.session.processOnNotAnswer(this)):this.session.processCall(this,e)};this.dialingTimer=setInterval(n,s,e,t,!1),n(e,t,!0)}async setRemoteSessionDescription(e,t){const s=new ce({sdp:t,type:e});return this.setRemoteDescription(s)}getWrappedStats(){if(he.videochat.statsReportTimeInterval){let e;Hs.trace("Stats tracker has been started"),this.statsReportTimer=setInterval(()=>{this.getStatsCustom(e,(t,s)=>{e=s,this.session.onCallStatsReport(this.userID,t)},e=>{Hs.traceError(`Get stats error. ${e.name}: ${e.message}`),this.session.onCallStatsReport(this.userID,null,e)})},1e3*he.videochat.statsReportTimeInterval)}}set sdpRemote(e){e&&(this.remoteSDP=e)}get sdpRemote(){return this.remoteSDP}toString(){return`sessionID: ${this.session.ID}, userID: ${this.userID}, type: ${this.type}, state: ${this.state}`}getStatsCustom(e,t,s){const n={audio:{},video:{},candidate:{}},r={local:Object.assign({},n),remote:Object.assign({},n)};if(Hs.getVersionFirefox){const e=this.session.localStream,t=e?.getVideoTracks()[0].getSettings();t&&(r.local.video.frameHeight=t.height,r.local.video.frameWidth=t.width)}this.getStats().then(s=>{s.forEach(t=>{let s;t.bytesReceived&&"inbound-rtp"===t.type?(s=r.remote[t.mediaType],s.bitrate=this.getBitratePerSecond(t,e,!1),s.bytesReceived=t.bytesReceived,s.packetsReceived=t.packetsReceived,s.timestamp=t.timestamp,t.mediaType===A.VIDEO&&t.framerateMean&&(s.framesPerSecond=Math.round(10*t.framerateMean)/10)):t.bytesSent&&"outbound-rtp"===t.type?(s=r.local[t.mediaType],s.bitrate=this.getBitratePerSecond(t,e,!0),s.bytesSent=t.bytesSent,s.packetsSent=t.packetsSent,s.timestamp=t.timestamp,t.mediaType===A.VIDEO&&t.framerateMean&&(s.framesPerSecond=Math.round(10*t.framerateMean)/10)):"local-candidate"===t.type?(s=r.local.candidate,"host"===t.candidateType&&"udp"===t.mozLocalTransport&&"udp"===t.transport?(s.protocol=t.transport,s.ip=t.ipAddress,s.port=t.portNumber):Hs.getVersionFirefox||(s.protocol=t.protocol,s.ip=t.ip,s.port=t.port)):"remote-candidate"===t.type?(s=r.remote.candidate,s.protocol=t.protocol||t.transport,s.ip=t.ip||t.ipAddress,s.port=t.port||t.portNumber):"track"!==t.type||t.kind!==A.VIDEO||Hs.getVersionFirefox||(t.remoteSource?(s=r.remote.video,s.frameHeight=t.frameHeight,s.frameWidth=t.frameWidth,s.framesPerSecond=this.getFramesPerSecond(t,e,!1)):(s=r.local.video,s.frameHeight=t.frameHeight,s.frameWidth=t.frameWidth,s.framesPerSecond=this.getFramesPerSecond(t,e,!0)))}),t(r,s)},s)}getBitratePerSecond(e,t,s){const n=t.get(e.id),r=n?(e.timestamp-n.timestamp)/1e3:5,i=n?s?8*(e.bytesSent-n.bytesSent)/(1024*r):8*(e.bytesReceived-n.bytesReceived)/(1024*r):0;return Math.round(i)}getFramesPerSecond(e,t,s){const n=t&&t.get(e.id),r=n?(e.timestamp-n.timestamp)/1e3:5,i=n?s?(e.framesSent-n.framesSent)/r:(e.framesReceived-n.framesReceived)/r:0;return Math.round(10*i)/10}close(){this.original.close?.()}addTrack(e,t){return this.original.addTrack?.(e,t)??null}getSenders(){return this.original.getSenders?.()??null}async createOffer(e){return await(this.original.createOffer?.(e))??null}async createAnswer(e){return await(this.original.createAnswer?.(e))??null}async getStats(e){return await(this.original.getStats?.(e))??null}async addIceCandidate(e){await(this.original.addIceCandidate?.(e))}async setRemoteDescription(e){await(this.original.setRemoteDescription?.(e))}async setLocalDescription(e){await(this.original.setLocalDescription?.(e))}get localDescription(){return this.original.localDescription??null}get signalingState(){return this.original.signalingState??"closed"}get iceConnectionState(){return this.original.iceConnectionState??"closed"}}class Ks{chatService;constructor(e){this.chatService=e}sendCandidate(e,t,s={}){const n=Object.assign({},s,{iceCandidates:t});this.sendMessage(e,n,a.CANDIDATE)}sendMessage(e,t,s){const n=Object.assign({},t);n.moduleIdentifier=i,n.signalType=s,n.platform=pe.env.isBrowser?"web":pe.env.isReactNative||pe.env.isExpo?"mobile":"node",n.userInfo&&(Object.keys(n.userInfo).length?0===n.userInfo.maxBandwidth&&delete n.userInfo.maxBandwidth:delete n.userInfo);const r={id:pe.getBsonObjectId(),extension:n};this.chatService.sendWebRTCSignalingMessage(e,r)}}class Qs{ID=null;state=c.NEW;callType;initiatorID;currentUserID;opponentsIDs=[];maxBandwidth=0;peerConnections={};localStream;mediaParams={};signalingProvider;answerTimer=null;waitingOfferOrAnswerTimer=null;startCallTime=0;acceptCallTime=0;onUserNotAnswerListener;onRemoteStreamListener;onSessionCloseListener;onCallStatsReportListener;onSessionConnectionStateChangedListener;constructor(e){Object.assign(this,e,{ID:e.ID??Ys()})}async getDisplayMedia(e){if(!te.getDisplayMedia)throw new Error("Your environment does not support 'getDisplayMedia' API");const t=e&&e.elementId,s=e&&e.options,n={...e};this.mediaParams=n,delete n.elementId,delete n.options;try{const e=await te.getDisplayMedia(n);return this.upsertStream(e,t,s)}catch(e){throw e}}async getUserMedia(e){const t=e&&e.elementId,s=e&&e.options,n={...e};this.mediaParams=n,delete n.elementId,delete n.options;try{const e=await te.getUserMedia(n);return this.upsertStream(e,t,s)}catch(e){throw e}}upsertStream(e,t,s){const n=!!this.localStream;if(n?this.replaceTracks(e):this.localStream=e,!this.localStream)throw new Error("Local stream is not defined");return t&&(n&&this.detachMediaStream(t,s),this.attachMediaStream(t,this.localStream,s)),this.localStream.getTracks().forEach(e=>{const t=e.kind,s=e.getSettings().deviceId;s&&("object"==typeof this.mediaParams[t]?this.mediaParams[t].deviceId=s:this.mediaParams[t]={deviceId:s})}),this.localStream}replaceTracks(e){if(this.localStream?.getTracks().forEach(t=>{t.kind===A.AUDIO&&0===e.getAudioTracks().length||(t.stop(),this.localStream?.removeTrack(t))}),e.getTracks().forEach(e=>{e.kind===A.AUDIO?e.enabled=this.localStream?.getAudioTracks().every(({enabled:e})=>e)??!0:e.enabled=this.localStream?.getVideoTracks().every(({enabled:e})=>e)??!0,e&&(Object.values(this.peerConnections).forEach(t=>{t.getSenders().find(({track:t})=>e.kind===t?.kind)?.replaceTrack(e)}),this.localStream?.addTrack(e))}),!this.localStream)throw new Error("Local stream is not defined");return this.localStream}async setMaxBandwidth(e){const t=this.peerConnections,s=Object.keys(t);if(!(s.length<1))return Promise.all(s.map(s=>t[Number(s)].setRTCRtpSenderMaxBandwidth(e)));Hs.trace("No 'RTCPeerConnection' to set 'maxBandwidth'")}connectionStateForUser(e){const t=this.peerConnections[e];return t?t.state:null}attachMediaStream(e,t,s){const n=document.getElementById(e);if(!("srcObject"in n))throw new Error(`Unable to attach media stream, element #${e} is undefined`);n.srcObject=t,n.style.transform=s?.mirror?"scaleX(-1)":"none","boolean"==typeof s?.muted&&(n.muted=s?.muted),n.onloadedmetadata=async e=>{try{await n.play()}catch(e){console.error("[VideoChat]:",e)}}}detachMediaStream(e,t){const s=document.getElementById(e);if(!("srcObject"in s))throw new Error(`Unable to attach media stream, element #${e} is undefined`);s.pause(),s.srcObject=null,s.style.transform=t?.mirror?"scaleX(-1)":"none","boolean"==typeof t?.muted&&(s.muted=t?.muted)}async switchMediaTracks(e={}){pe.DLog("switchMediaTracks:",e),[A.AUDIO,A.VIDEO].forEach(t=>{const s=t===A.AUDIO?e.audio:t===A.VIDEO?e.video:{},n="string"==typeof s?s:s?.deviceId??null;n&&("object"!=typeof this.mediaParams[t]?this.mediaParams[t].deviceId=n:this.mediaParams[t]={deviceId:n})});try{const e={audio:this.mediaParams.audio||!1,video:this.mediaParams.video||!1},t=await te.getUserMedia(e);return this.replaceTracks(t)}catch(e){throw e}}call(e={}){const t=Zs(e);Hs.trace(`Call, extension: ${JSON.stringify(t)}`),this.state=c.ACTIVE,this.maxBandwidth=Number(t.userInfo?.maxBandwidth??0),this.opponentsIDs.forEach(e=>{this.callInternal(e,t,!0)})}async callInternal(e,t,s){const n=new Xs(this,e,"offer");this.localStream?.getTracks().forEach(e=>{n.addTrack(e,this.localStream)}),this.peerConnections[e]=n;try{await n.getAndSetLocalSessionDescription(this.maxBandwidth),Hs.trace("getAndSetLocalSessionDescription success"),n.startDialingTimer(t,s)}catch(e){Hs.traceError(`getAndSetLocalSessionDescription error: ${e}`)}}accept(e={}){const t=Zs(e);if(Hs.trace(`Accept, extension: ${JSON.stringify(t)}`),this.state===c.ACTIVE)return void Hs.traceError("Can't accept, the session is already active, return");if(this.state===c.CLOSED)return Hs.traceError("Can't accept, the session is already closed, return"),void this.stop({});this.state=c.ACTIVE,this.acceptCallTime=Date.now(),this.clearAnswerTimer(),this.acceptInternal(this.initiatorID,t);const s=this.opponentsIDs.filter(e=>e!==this.currentUserID);s.length>0&&(this.startWaitingOfferOrAnswerTimer(),s.forEach(e=>{this.currentUserID>e&&this.callInternal(e,t,!0)}))}async acceptInternal(e,t){const s=this.peerConnections[e];if(s&&s.sdpRemote){this.localStream?.getTracks().forEach(e=>{s.addTrack(e,this.localStream)});try{await s.setRemoteSessionDescription("offer",s.sdpRemote),Hs.trace("setRemoteSessionDescription - success"),await s.getAndSetLocalSessionDescription(this.maxBandwidth),Hs.trace("getAndSetLocalSessionDescription - success");const n=Object.assign({},t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs,sdp:s.localDescription.sdp});this.signalingProvider.sendMessage(e,n,a.ACCEPT)}catch(e){Hs.traceError(`[acceptInternal] Error: ${e}`)}}else Hs.traceError("Can't accept the call, there is no information about peer connection by some reason")}reject(e={}){const t=Zs(e);Hs.trace(`Reject, extension: ${JSON.stringify(t.userInfo)}`),this.state=c.REJECTED,this.clearAnswerTimer(),Object.assign(t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs}),Object.keys(this.peerConnections).forEach(e=>{this.signalingProvider.sendMessage(Number(e),t,a.REJECT)}),this.close()}stop(e={}){const t=Zs(e);Hs.trace(`Stop, extension: ${JSON.stringify(t.userInfo)}`),this.state=c.STOPPED,this.answerTimer&&this.clearAnswerTimer(),Object.assign(t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs}),Object.keys(this.peerConnections).forEach(e=>{this.signalingProvider.sendMessage(Number(e),t,a.STOP)}),this.close()}canInitiateIceRestart(e){return"offer"===this.peerConnections[e]?.type}async iceRestart(e){const t=this.peerConnections[e];if(t)try{const{sdp:s}=await t.getAndSetLocalSessionDescription(this.maxBandwidth,!0),n={sessionID:this.ID??"",sdp:s};this.signalingProvider.sendMessage(e,n,a.RESTART),Hs.trace("[iceRestart] OK")}catch(e){Hs.traceError(`[iceRestart] Error: ${e}`)}else Hs.traceError("Can't restart ice, there is no information about peer connection by some reason")}processOnCall(e,t){[this.initiatorID,...this.opponentsIDs.filter(e=>e!==this.currentUserID)].forEach(s=>{const n=this.peerConnections[s];if(n)s===e&&(n.sdpRemote=t.sdp,e!==this.initiatorID&&this.state===c.ACTIVE&&this.acceptInternal(e,t));else{const n=s!==e&&this.currentUserID>s?"offer":"answer",r=new Xs(this,s,n);this.peerConnections[s]=r,s===e&&(r.sdpRemote=t.sdp,this.startAnswerTimer())}})}async processOnAccept(e,t){const s=this.peerConnections[e];s||Hs.traceWarning("Ignore 'OnAccept', there is no information about peer connection by some reason");try{s.clearDialingTimer(),await s.setRemoteSessionDescription("answer",t.sdp),Hs.trace("'setRemoteSessionDescription' success")}catch(e){Hs.traceError(`'setRemoteSessionDescription' error: ${e}`)}}processOnReject(e){const t=this.peerConnections[e];this.clearWaitingOfferOrAnswerTimer(),t?t.release():Hs.traceWarning("Ignore 'OnReject', there is no information about peer connection by some reason"),this.closeSessionIfAllConnectionsClosed()}processOnStop(e){if(this.clearAnswerTimer(),e===this.initiatorID){const e=Object.keys(this.peerConnections);e.length>0?e.forEach(e=>{this.peerConnections[Number(e)].release()}):Hs.traceWarning("Ignore 'OnStop', there is no information about peer connections by some reason")}else{const t=this.peerConnections[e];t?t.release():Hs.traceWarning('Ignore "OnStop", there is no information about peer connection by some reason')}this.closeSessionIfAllConnectionsClosed()}async processOnIceCandidates(e,t){const s=this.peerConnections[e];s||Hs.traceWarning('Ignore "OnIceCandidates", there is no information about peer connection by some reason'),t.iceCandidates&&await s.addCandidates(t.iceCandidates)}async processOnIceRestart(e,t){const s=this.peerConnections[e];s||Hs.traceWarning('Ignore "OnIceRestart", there is no information about peer connection by some reason');try{await s.setRemoteSessionDescription("offer",t.sdp);const{sdp:n}=await s.getAndSetLocalSessionDescription(this.maxBandwidth),r={sessionID:this.ID??"",sdp:n};this.signalingProvider.sendMessage(e,r,a.RESTART_ACCEPT),Hs.trace("[processOnIceRestart] Success")}catch(e){Hs.traceError(`[processOnIceRestart] Error: ${e}`)}}async processOnIceRestartAccept(e,t){const s=this.peerConnections[e];s||Hs.traceWarning('Ignore "OnIceRestartAccept", there is no information about peer connection by some reason');try{await s.setRemoteSessionDescription("answer",t.sdp),Hs.trace("[processOnIceRestartAccept] Success")}catch(e){Hs.traceError(`[processOnIceRestartAccept] Error: ${e}`)}}processCall(e,t={}){const s=Object.assign({userInfo:{}},t,{sessionID:this.ID,callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs,sdp:e.localDescription.sdp});this.signalingProvider.sendMessage(e.userID,s,a.CALL)}processIceCandidates(e,t){const s={sessionID:this.ID??"",callType:this.callType,callerID:this.initiatorID,opponentsIDs:this.opponentsIDs};this.signalingProvider.sendCandidate(e,t,s)}processOnNotAnswer(e){Hs.trace(`Answer timeout callback for session ${this.ID} for user ${e.userID}`),this.clearWaitingOfferOrAnswerTimer(),e.release(),pe.safeCallbackCall(this.onUserNotAnswerListener)(this,e.userID),this.closeSessionIfAllConnectionsClosed()}onRemoteStream(e,t){pe.safeCallbackCall(this.onRemoteStreamListener)(this,e,t)}onCallStatsReport(e,t,s){pe.safeCallbackCall(this.onCallStatsReportListener)(this,e,t,s)}onSessionConnectionStateChanged(e,t){pe.safeCallbackCall(this.onSessionConnectionStateChangedListener)(this,e,t)}close(){Object.values(this.peerConnections).forEach(e=>{try{e.release()}catch(e){pe.DLog(`Peer close error: ${e}`)}}),this.closeLocalMediaStream(),this.state=c.CLOSED,pe.safeCallbackCall(this.onSessionCloseListener)(this)}closeSessionIfAllConnectionsClosed(){const e=Object.values(this.peerConnections).every(e=>{try{return"closed"===e.iceConnectionState||"closed"===e.signalingState||e.released}catch(e){return Hs.traceError(e),!0}});Hs.trace(`All peer connections closed: ${e}`),e&&(this.closeLocalMediaStream(),pe.safeCallbackCall(this.onSessionCloseListener)(this),this.state=c.CLOSED)}closeLocalMediaStream(){this.localStream&&(this.localStream.getTracks().forEach(e=>e.stop()),this.localStream=void 0,this.mediaParams={})}mute(e){this.muteStream(!1,e)}unmute(e){this.muteStream(!0,e)}muteStream(e,t=A.NONE){const s=t===A.AUDIO?this.localStream?.getAudioTracks():t===A.VIDEO?this.localStream?.getVideoTracks():[];s?.forEach(t=>{t.enabled=e})}clearAnswerTimer(){this.answerTimer&&(Hs.trace("clearAnswerTimer"),clearTimeout(this.answerTimer),this.answerTimer=null)}startAnswerTimer(){Hs.trace("startAnswerTimer"),this.answerTimer=setTimeout(()=>{Hs.trace("answerTimeoutCallback"),this.close(),this.answerTimer=null},1e3*he.videochat.answerTimeInterval)}clearWaitingOfferOrAnswerTimer(){this.waitingOfferOrAnswerTimer&&(Hs.trace("clearWaitingOfferOrAnswerTimer"),clearTimeout(this.waitingOfferOrAnswerTimer),this.waitingOfferOrAnswerTimer=null)}startWaitingOfferOrAnswerTimer(){const e=(this.acceptCallTime-this.startCallTime)/1e3,t=Math.min(e,he.videochat.answerTimeInterval/2),s=Math.max(he.videochat.answerTimeInterval-t,1);Hs.trace(`startWaitingOfferOrAnswerTimer, timeout: ${s}`),this.waitingOfferOrAnswerTimer=setTimeout(()=>{Hs.trace("waitingOfferOrAnswerTimeoutCallback"),Object.values(this.peerConnections).forEach(e=>{e.state!==u.CONNECTING&&e.state!==u.NEW||this.processOnNotAnswer(e)}),this.waitingOfferOrAnswerTimer=null},1e3*s)}toString(){return`ID: ${this.ID}, initiatorID: ${this.initiatorID}, opponentsIDs: ${this.opponentsIDs}, state: ${this.state}, callType: ${this.callType}`}}function Ys(){let e=Date.now();const t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const s=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?s:3&s|8).toString(16)});return t}function Zs(e={}){const t={userInfo:e};try{pe.isObject(e)?t.userInfo=pe.cloneObject(e,!0):Hs.traceWarning('Ignore "prepareExtension", must be an object')}catch(e){Hs.traceWarning(e.message)}return t}class en{chatService;proxy;signalingProcessor;signalingProvider;SessionConnectionState=o;PeerConnectionState=u;CallType=l;sessions={};onCallListener;onAcceptCallListener;onRejectCallListener;onStopCallListener;onInvalidEventsListener;onUserNotAnswerListener;onRemoteStreamListener;onSessionConnectionStateChangedListener;onSessionCloseListener;onCallStatsReport;onDevicesChangeListener=()=>{};constructor(e,t){this.chatService=e,this.proxy=t,this.signalingProcessor=new Es(this),this.signalingProvider=new Ks(this.chatService),te&&(te.ondevicechange=pe.safeCallbackCall(this.onDevicesChangeListener))}get currentUserID(){return this.chatService.currentUserId}async getMediaDevices(e){if(te?.enumerateDevices){const t=await te.enumerateDevices();return e?t.filter(t=>t.kind===e):t}throw new Error("No 'enumerateDevices' API supported")}createNewSession(e,t,s){const n=(s?.maxBandwidth||s?.bandwidth)??0;if(!e)throw new Error("Can't create a session without opponentsIDs");return this.createAndStoreSession(null,this.currentUserID,e,t,n)}createAndStoreSession(e,t,s,n,r=0){const i=new Qs({ID:e,initiatorID:t,opponentsIDs:s,callType:n,signalingProvider:this.signalingProvider,currentUserID:this.currentUserID,maxBandwidth:r});return i.onUserNotAnswerListener=this.onUserNotAnswerListener,i.onRemoteStreamListener=this.onRemoteStreamListener,i.onSessionConnectionStateChangedListener=this.onSessionConnectionStateChangedListener,i.onSessionCloseListener=this.onSessionCloseListener,i.onCallStatsReportListener=this.onCallStatsReport,i?.ID&&(this.sessions[i.ID]=i),i}clearSession(e){delete this.sessions[e]}callRejectRequest(e){const t={type:D.POST,url:pe.getUrl(he.urls.calls,"reject"),data:e};return this.proxy.ajax(t)}onCallHandler(e,t,s){const n=s.userInfo||{},r=Number(n.maxBandwidth??0);let i=this.sessions[t];Hs.trace(`onCall. userID: ${e}, sessionID: ${t}, extension: ${JSON.stringify(s)}`),i||(i=this.createAndStoreSession(t,s.callerID||0,s.opponentsIDs||[],s.callType||l.VIDEO,r),pe.safeCallbackCall(this.onCallListener)(i,n)),i.processOnCall(e,s)}onAcceptHandler(e,t,s){const n=this.sessions[t],r=s.userInfo||{};Hs.trace(`onAccept. UserID: ${e}, sessionID: ${t}, extension: ${JSON.stringify(s)}`),!n||n.state!==c.ACTIVE&&n.state!==c.NEW?Hs.traceWarning(`Ignore 'onAccept', there is no information about session ${t}`):(pe.safeCallbackCall(this.onAcceptCallListener)(n,e,r),n.processOnAccept(e,s))}onRejectHandler(e,t,s){const n=this.sessions[t];if(Hs.trace(`onReject. UserID: ${e}, sessionID: ${t}, extension: ${JSON.stringify(s)}`),n){const t=s.userInfo||{};pe.safeCallbackCall(this.onRejectCallListener)(n,e,t),n.processOnReject(e)}else Hs.traceWarning(`Ignore 'onReject', there is no information about session ${t}`)}onStopHandler(e,t,s){Hs.trace(`onStop. UserID: ${e}, sessionID: ${t}, extension: ${JSON.stringify(s)}`);const n=this.sessions[t],r=s.userInfo||{};!n||n.state!==c.ACTIVE&&n.state!==c.NEW?(pe.safeCallbackCall(this.onInvalidEventsListener)(n,e,r),Hs.traceWarning(`Ignore 'onStop', there is no information about session ${t} by some reason`)):(n.processOnStop(e),pe.safeCallbackCall(this.onStopCallListener)(n,e,r))}onIceCandidatesHandler(e,t,s){const n=this.sessions[t];Hs.trace(`onIceCandidates. UserID: ${e}. SessionID: ${t}. ICE candidates count: ${s.iceCandidates?.length??0}`),n?n.state===c.ACTIVE?n.processOnIceCandidates(e,s):Hs.traceWarning(`Ignore 'OnIceCandidates', the session ( ${t} ) has invalid state`):Hs.traceWarning(`Ignore 'OnIceCandidates', there is no information about session ${t}`)}onIceRestartHandler(e,t,s){const n=this.sessions[t];Hs.trace(`onIceRestart. UserID: ${e}. SessionID: ${t}. Extension: ${JSON.stringify(s)}`),n?n.state===c.ACTIVE?n.processOnIceRestart(e,s):Hs.traceWarning(`Ignore 'OnIceRestart', the session (${t}) has invalid state`):Hs.traceWarning(`Ignore 'OnIceRestart', there is no information about session ${t}`)}onIceRestartAcceptHandler(e,t,s){const n=this.sessions[t];Hs.trace(`onIceRestartAccept. UserID: ${e}. SessionID: ${t}. Extension: ${JSON.stringify(s)}`),n?n.state===c.ACTIVE?n.processOnIceRestartAccept(e,s):Hs.traceWarning(`Ignore 'onIceRestartAccept', the session (${t}) has invalid state`):Hs.traceWarning(`Ignore 'onIceRestartAccept', there is no information about session ${t}`)}getListenerByName(e){switch(e){case d.CALL:return"onCallListener";case d.ACCEPT:return"onAcceptCallListener";case d.REJECT:return"onRejectCallListener";case d.STOP:return"onStopCallListener";case d.INVALID:return"onInvalidEventsListener";case d.NOT_ANSWER:return"onUserNotAnswerListener";case d.REMOTE_STREAM:return"onRemoteStreamListener";case d.CONNECTION_STATE:return"onSessionConnectionStateChangedListener";case d.CLOSE:return"onSessionCloseListener";case d.STATS_REPORT:return"onCallStatsReport";case d.DEVICES:return"onDevicesChangeListener";default:return null}}addListener(e,t){const s=this.getListenerByName(e);return s&&(this[s]=t),this.removeListener.bind(this,e)}removeListener(e){const t=this.getListenerByName(e);t&&(this[t]=e===d.DEVICES?()=>{}:void 0)}removeAllListeners(){Object.keys(this).forEach(e=>{e.startsWith("on")&&e.endsWith("Listener")&&"function"==typeof this[e]&&(this[e]="onDevicesChangeListener"===e?()=>{}:void 0)})}}class tn{proxy;route=he.urls.whiteboards;server=he.whiteboard.server;constructor(e){this.proxy=e}getURL({id:e,title:t,username:s}){return`${this.server}?whiteboardid=${e}&username=${s}&title=${t}`}async get(e){const t={type:D.GET,url:pe.getUrl(this.route),data:"string"==typeof e?{chat_dialog_id:e}:e};return this.proxy.ajax(t)}async create(e){const t={type:D.POST,url:pe.getUrl(this.route),data:e};return this.proxy.ajax(t)}async update(e,t){const s={type:D.PUT,url:pe.getUrl(this.route,e),data:t};return this.proxy.ajax(s)}async delete(e){const t={type:D.DELETE,url:pe.getUrl(this.route,e),dataType:R.TEXT};return this.proxy.ajax(t)}}class sn{proxy;cache=new Map;route=he.urls.unfurl;server=he.linkpreview.server;constructor(e){this.proxy=e}async get(e){if(!this.cache.has(e)){let t;try{const s={type:D.POST,url:`${this.server}/${this.route}`,data:{url:e}};t=await this.proxy.ajax(s)}catch(s){t={url:e,title:this.getHostFromUrl(e),description:"",images:[]}}finally{this.cache.set(e,t)}}return this.cache.get(e)}getHostFromUrl(e){if("function"==typeof URL)return new URL(e).hostname;const t=e.match(/^(?:https?:\/\/)?([^\/]+)/);return t?t[1]:e}}class nn{ConnectyCube;version=B;isWebRTCAvailable=le;utils;service;auth;users;storage;pushnotifications;data;addressbook;chat;meeting;whiteboard;linkpreview;videochat;videochatconference;setSession;getSession;createSession;destroySession;login;logout;init(e,t={}){t&&"object"==typeof t&&he.set(t),this.utils=pe,this.service=new me,this.auth=new fe(this.service),this.users=new Gs(this.service),this.storage=new Bs(this.service),this.pushnotifications=new Vs(this.service),this.data=new $s(this.service),this.addressbook=new ge(this.service),this.chat=he.chat.apiImp===y.SAMA?new Os(this.service):new ks(this.service),this.meeting=new qs(this.service),this.whiteboard=new tn(this.service),this.linkpreview=new sn(this.service),le&&(this.videochat=new en(this.chat,this.service),this.chat.webrtcSignalingProcessor=this.videochat.signalingProcessor,this.videochatconference=new Fs(this.service)),e.token?(he.creds.appId=e.appId,this.service.setSession({token:e.token})):(he.creds.appId=e.appId,he.creds.authKey=e.authKey),this.setSession=this.auth.setSession,this.getSession=this.auth.getSession,this.createSession=this.auth.createSession,this.destroySession=this.auth.destroySession,this.login=this.auth.login,this.logout=this.auth.logout}}return Object.assign(new nn,{ConnectyCube:nn,...M})});
//# sourceMappingURL=connectycube.min.js.map
